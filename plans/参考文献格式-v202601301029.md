# 参考文献格式优化计划

**创建时间**：2026-01-30
**状态**：已完成

---

## 一、背景与目标

### 当前架构问题

1. **用户修改参数需跨文件操作**：参数定义在 `@config.tex`，但用户自然地在 `reference.tex` 中查找修改位置
2. **升级时存在覆盖风险**：若用户直接修改 `@config.tex`，模板更新时可能丢失定制
3. **职责不够清晰**：`@config.tex` 混合了"基础定义"和"默认值设置"两个职责

### 优化目标

实现**两层架构**：
- **`@config.tex`**：声明变量 + 提供合理默认值（基础层）
- **`reference.tex`**：用户按需覆盖参数（定制层）

---

## 二、设计方案

### 架构原则

```
@config.tex (基础层)          reference.tex (定制层)
├── 声明 length 变量    ───→  ├── 可选：\setlength 覆盖
├── 设置默认值         ───→  └── \bibliography 调用
└── thebibliography 重定义
```

### 核心机制

利用 LaTeX 的"后定义覆盖先定义"特性：
1. `@config.tex` 先声明并设置默认值
2. `reference.tex` 中用户可选地 `\setlength` 重新赋值
3. `thebibliography` 重定义在 `@config.tex` 末尾，此时读取的是最终值

---

## 三、具体实施步骤

### 步骤 1：调整 `@config.tex`

**移除内容**（从三项目的 `@config.tex` 中）：
```latex
% 移除以下默认值设置（仅保留变量声明）：
% \setlength{\NSFCBibTitleAboveSkip}{...}
% \setlength{\NSFCBibTitleBelowSkip}{...}
% \setlength{\NSFCBibItemSep}{...}
% \setlength{\NSFCBibTextWidth}{...}
```

**保留内容**：
```latex
% 变量声明
\newlength{\NSFCBibTitleAboveSkip}
\newlength{\NSFCBibTitleBelowSkip}
\newlength{\NSFCBibItemSep}
\newlength{\NSFCBibTextWidth}

% 基础默认值（推荐值，可被 reference.tex 覆盖）
\setlength{\NSFCBibTitleAboveSkip}{10pt}   % 统一默认值
\setlength{\NSFCBibTitleBelowSkip}{0pt}
\setlength{\NSFCBibItemSep}{0pt}
\setlength{\NSFCBibTextWidth}{397.16727pt} % 按青年基金基准对齐

% 说明：上述参数会在本文件末尾的 thebibliography 环境重定义中生效。
% 用户可在 reference.tex 中通过 \setlength{\NSFCBibXXX}{...} 覆盖这些默认值。
```

### 步骤 2：改造 `reference.tex`

**模板结构**（三项目统一）：
```latex
% 参考文献
% 间距调节（本文件直接修改，覆盖 @config.tex 默认值）：
% - 标题与上文：\NSFCBibTitleAboveSkip（默认 10pt）
% - 标题与条目：\NSFCBibTitleBelowSkip（默认 0pt）
% - 条目间距：\NSFCBibItemSep（默认 0pt）
% - 条目行宽：\NSFCBibTextWidth（默认 397.16727pt）
%
% 用法示例（取消注释即可生效）：
% \setlength{\NSFCBibTitleAboveSkip}{15pt}   % 增加标题上方间距
% \setlength{\NSFCBibTitleBelowSkip}{5pt}    % 增加标题下方间距
% \setlength{\NSFCBibItemSep}{3pt}           % 增加条目之间的间距
% \setlength{\NSFCBibTextWidth}{380pt}       % 缩窄条目行宽

% 行距与字号设置
\begin{spacing}{1}
\wuhao
\bibliographystyle{bibtex-style/gbt7714-nsfc}
\bibliography{references/myexample}
\end{spacing}
\newpage
```

**说明**：
- General 项目保留 `\begingroup...\endgroup`（如有作用域隔离需求）
- Local/Young 项目保持原有 `\newpage` 结构

### 步骤 3：统一默认值

**当前差异**：
- General：`\NSFCBibTitleAboveSkip = 15pt`
- Local：`\NSFCBibTitleAboveSkip = 10pt`
- Young：`\NSFCBibTitleAboveSkip = 1em`

**优化后**：
- 三项目统一为 `10pt`（视觉居中，符合多数场景）
- 如需差异化，用户在各项目的 `reference.tex` 中自行调整

---

## 四、文件变更清单

### 修改文件（3 × 2 = 6 个）

| 项目 | 文件 | 变更类型 |
|------|------|----------|
| NSFC_General | `extraTex/@config.tex` | 精简默认值设置 |
| NSFC_General | `references/reference.tex` | 新增参数覆盖示例 |
| NSFC_Local | `extraTex/@config.tex` | 精简默认值设置 |
| NSFC_Local | `references/reference.tex` | 新增参数覆盖示例 |
| NSFC_Young | `extraTex/@config.tex` | 精简默认值设置 |
| NSFC_Young | `references/reference.tex` | 新增参数覆盖示例 |

---

## 五、验证测试

### 测试用例

1. **默认值测试**：不修改 `reference.tex`，编译验证三项目参考文献格式一致
2. **覆盖测试**：在 `reference.tex` 中设置 `\setlength{\NSFCBibItemSep}{5pt}`，验证生效
3. **升级模拟**：更新 `@config.tex` 默认值，确认用户的 `reference.tex` 覆盖仍有效
4. **跨项目对比**：PDF 像素级对比，确认换行位置对齐

### 预期结果

- 三项目默认格式完全一致
- 用户可在 `reference.tex` 独立定制各项目参数
- 模板更新不影响用户定制

---

## 六、文档更新

### 需更新的文档

1. **`references/README.md`**（如存在）：说明参数调整方法
2. **`CHANGELOG.md`**：记录架构优化变更
3. **项目主 `README.md`**：如提及参考文献配置，需同步更新

### 新增说明段落（可插入 `references/README.md`）

```markdown
## 参考文献间距调整

三套模板（General/Local/Young）的参考文献间距参数已统一管理：

### 默认值（在 `extraTex/@config.tex` 中）

- 标题与上文：10pt
- 标题与条目：0pt
- 条目间距：0pt
- 条目行宽：397.16727pt

### 定制方法（在 `references/reference.tex` 中）

如需调整间距，直接在 `reference.tex` 顶部添加：

```latex
\setlength{\NSFCBibTitleAboveSkip}{15pt}   % 示例：增加标题上方间距
\setlength{\NSFCBibItemSep}{3pt}           % 示例：增加条目间距
```

### 注意事项

- 参数修改仅在当前项目生效
- 模板更新时 `@config.tex` 可能被覆盖，但 `reference.tex` 中的定制会保留
```

---

## 七、风险评估

| 风险 | 概率 | 影响 | 缓解措施 |
|------|------|------|----------|
| 用户不理解两层架构 | 中 | 低 | 提供清晰注释和文档 |
| 现有项目升级后格式变化 | 低 | 中 | 默认值保持视觉一致 |
| `\setlength` 语法错误 | 低 | 低 | 注释中提供正确示例 |

---

## 八、后续优化方向（可选）

---

> 变更历史记录在 CHANGELOG.md

1. **参数化更多样式**：如字号、行距等
2. **提供预设方案**：如"紧凑型"、"宽松型"参数组合
3. **自动化验证脚本**：检查三项目参考文献格式一致性

---

## 九、执行优先级

| 优先级 | 任务 |
|--------|------|
| P0 | 步骤 1-2：核心架构调整 |
| P1 | 步骤 3：统一默认值 |
| P1 | 步骤五：验证测试 |
| P2 | 步骤六：文档更新 |

---

**备注**：本计划执行后，三套模板的参考文献配置将实现"基础统一 + 允许定制"的平衡，既保持跨项目一致性，又尊重用户个性化需求。
