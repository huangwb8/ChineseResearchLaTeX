# nsfc-justification-writer 硬编码与AI功能规划分析

**分析时间**: 2026-01-10
**分析范围**: skills/nsfc-justification-writer 全部源代码
**当前版本**: v0.7.2

---

## 执行摘要（Executive Summary）

**结论**：规划**非常合理**。本项目展现了优秀的"硬编码确定性 + AI语义增强"协同设计理念，架构清晰，降级策略完善，工程实践到位。

### 评分矩阵

| 维度 | 评分 | 说明 |
|------|------|------|
| 硬编码/AI边界划分 | ⭐⭐⭐⭐⭐ | Tier1硬编码保证基础可用，Tier2 AI提供增量价值 |
| 优雅降级设计 | ⭐⭐⭐⭐⭐ | 所有AI功能都有fallback，无responder自动回退 |
| 配置灵活性 | ⭐⭐⭐⭐⭐ | 支持preset/override/环境变量三层配置覆盖 |
| 安全防护 | ⭐⭐⭐⭐⭐ | 白名单写入+质量闸门+格式注入扫描+备份回滚 |
| 可维护性 | ⭐⭐⭐⭐ | SSoT清晰，但部分模块职责可进一步拆分 |

**总体评价**：这是一个"AI主导 + 硬编码兜底"的成功案例，值得作为其他技能的参考模板。

---

## 详细分析

### 1. 硬编码与AI功能划分（Tier1/Tier2架构）

#### 1.1 当前设计（优秀）

**Tier1 - 硬编码确定性能力**：
- [diagnostic.py](skills/nsfc-justification-writer/core/diagnostic.py): 结构检查（≥4个subsubsection）/引用键存在性/DOI格式提示/字数统计/高风险表述提示/危险命令扫描
- [term_consistency.py](skills/nsfc-justification-writer/core/term_consistency.py): 基于`terminology.dimensions`的跨章节术语矩阵（按章节统计命中次数，识别"同章内不一致"）
- [wordcount.py](skills/nsfc-justification-writer/core/wordcount.py): CJK字符数统计（支持cjk_only/cjk_strip_commands两种口径）
- [latex_parser.py](skills/nsfc-justification-writer/core/latex_parser.py): 结构解析（支持嵌套花括号/可选短标题/注释剥离/标题候选+AI语义匹配）

**Tier2 - AI语义增强能力**：
- [dimension_coverage.py](skills/nsfc-justification-writer/core/dimension_coverage.py): 内容维度覆盖检查（价值/现状/科学问题/切入点），不依赖标题用词
- [boastful_expression_checker.py](skills/nsfc-justification-writer/core/boastful_expression_checker.py): "可能引起评审不适的表述"识别（绝对化/填补空白/无依据夸大/自我定性）
- [term_consistency.py](skills/nsfc-justification-writer/core/term_consistency.py): AI语义术语一致性（识别同义词/缩写混用，补充硬编码矩阵）
- [writing_coach.py](skills/nsfc-justification-writer/core/writing_coach.py): AI阶段推断（skeleton/draft/revise/polish/final）与个性化写作指导

**协同设计亮点**：
1. **可组合性**: Tier1可独立运行提供价值，Tier2叠加后增强效果
2. **统一接口**: 所有AI功能通过`AIIntegration.process_request()`统一调用
3. **缓存机制**: `.cache/ai/`目录缓存AI结果，支持`--fresh`强制重算

#### 1.2 评价：划分合理，符合"最小可用产品"哲学

**优势**：
- 用户在**无AI环境**下仍可获得核心价值（结构检查/引用核验/术语矩阵/字数统计）
- AI功能作为**增量增强**，而非必需依赖
- 每个AI功能都有明确的**fallback逻辑**（如dimension_coverage的启发式关键词检测）

**无明显问题**。

---

### 2. 优雅降级策略

#### 2.1 当前实现（优秀）

核心降级逻辑在[ai_integration.py](skills/nsfc-justification-writer/core/ai_integration.py):

```python
async def process_request(self, *, task, prompt, fallback, output_format="json", ...):
    if not self.enable_ai:
        self.fallback_mode = True
        return fallback()
    if self.responder is None:
        self.fallback_mode = True
        return fallback()
    try:
        raw = self.responder(task, prompt, output_format)
        # ... 解析与缓存 ...
    except Exception as e:
        self.fallback_mode = True
        return fallback()
```

**降级触发条件**：
1. `enable_ai=False`（配置关闭）
2. `responder is None`（无AI注入）
3. AI调用异常（网络/解析/超时等）

**具体降级示例**：

| 功能 | AI模式 | Fallback模式 |
|------|--------|--------------|
| 内容维度覆盖 | AI语义判断4个维度是否覆盖 | 启发式关键词检测（如检测到"痛点"→"价值与必要性"覆盖） |
| 术语一致性 | AI识别同义词/缩写混用 | 硬编码矩阵规则（基于`terminology.dimensions`） |
| 吹牛式表述 | AI语义识别无依据夸大 | 硬编码高风险示例（仅提示，不阻断） |
| 写作阶段推断 | AI综合字数/结构/质量推断 | 硬编码阈值规则（如`wc < target*0.4`→draft） |

#### 2.2 评价：降级策略完善，用户体验友好

**优势**：
- **无静默失败**: 降级时有日志输出（`logger.info/warning`）
- **统计透明**: `get_stats()`暴露请求/成功数/成功率
- **用户可配置**: 通过`terminology.mode`/`ai.enabled`等控制AI使用

**无明显问题**。

---

### 3. 配置系统设计

#### 3.1 当前架构（优秀）

**三层配置加载**（[config_loader.py](skills/nsfc-justification-writer/core/config_loader.py)）：
1. **基础层**: `config.yaml`（仓库默认配置）
2. **预设层**: `config/presets/{medical,engineering}.yaml`（学科预设）
3. **覆盖层**: `~/.config/nsfc-justification-writer/override.yaml`或`--override path`

**配置SSoT**（Single Source of Truth）：
- `config.yaml`声明为"单一真相来源"
- `DEFAULT_CONFIG`仅保留安全关键项（guardrails）
- 修改配置优先编辑YAML，而非Python代码

**配置校验**：
- `validate_config()`轻量校验（不阻止扩展键）
- 支持`NSFC_JUSTIFICATION_WRITER_DISABLE_CONFIG_VALIDATION=1`关闭

#### 3.2 Prompt模板可配置化（优秀）

支持两种形式（[SKILL.md](skills/nsfc-justification-writer/SKILL.md)）：
1. **文件路径**: `prompts/tier2_diagnostic.txt`
2. **内联多行**: YAML中用`|`写入多行文本

支持按preset变体覆盖：`prompts.tier2_diagnostic_medical`

#### 3.3 评价：配置设计优雅，灵活性与安全性平衡

**优势**：
- 用户可按学科定制（`--preset medical`）
- 全局覆盖支持（`~/.config/...`）
- 配置校验防止错误配置

**无明显问题**。

---

### 4. 安全防护机制

#### 4.1 当前实现（优秀）

**多层安全架构**（[security.py](skills/nsfc-justification-writer/core/security.py)，需确认路径）：

1. **文件写入白名单**（`guardrails.allowed_write_files`）：
   - 默认仅允许写入`extraTex/1.1.立项依据.tex`
   - 禁止写入`main.tex`/`@config.tex`/`.cls`/`.sty`

2. **质量闸门**（[quality_gate.py](skills/nsfc-justification-writer/core/quality_gate.py)）：
   - `apply-section --strict-quality`对"本次新增正文"启用
   - 检查：危险命令/绝对化表述（可阻断）
   - AI可用时叠加"吹牛式表述"语义阻断

3. **引用防护**（[reference_validator.py](skills/nsfc-justification-writer/core/reference_validator.py)）：
   - 默认严格：`\cite{...}`的key必须在`.bib`中存在
   - `refs`命令支持可选Crossref联网校验

4. **版本备份与回滚**（[versioning.py](skills/nsfc-justification-writer/core/versioning.py)）：
   - 每次写入备份到`runs/<run_id>/backup/`
   - `diff`/`rollback`命令支持查看差异/一键回滚

#### 4.2 评价：安全防护周全，符合最小权限原则

**优势**：
- **白名单模式**：只允许写入特定文件，而非黑名单
- **质量闸门**：写入前检查，避免污染已有内容
- **可追溯性**：runs目录保留所有历史

**无明显问题**。

---

## 发现的问题（轻微）

### P2 - 可维护性优化（非阻塞）

1. **配置访问辅助方法可进一步统一**
   - 当前：`config_access.py`提供`get_bool/get_int/get_str/get_mapping`等
   - 现状：代码中已统一使用，但仍有个别地方使用`config.get(...) or {}`
   - 建议：已通过v0.7.2的`limits.py`/`config_access.py`改进
   - **优先级**: 低（已解决）

2. **Prompt模板加载逻辑可更透明**
   - 当前：`prompt_templates.py`的`get_prompt()`处理文件路径/内联/缺失
   - 现状：已支持缺失提示兜底（v0.7.2）
   - 建议：文档化Prompt模板查找优先级
   - **优先级**: 低

3. **测试覆盖可进一步完善**
   - 当前：有`tests/`目录，含单元测试/集成测试/E2E测试
   - 建议：增加"降级场景"的集成测试（如responder=None时的行为）
   - **优先级**: 低

---

## 改进建议（可选，非必需）

### 建议1：文档化"AI功能清单"（优先级：P3）

**当前状态**：SKILL.md的"关键能力"章节列出了所有功能，但未明确标注"哪些需要AI"

**建议**：在SKILL.md或README.md中增加表格：

| 功能 | 是否需要AI | Fallback行为 |
|------|-----------|--------------|
| Tier1诊断 | ❌ | N/A |
| 内容维度覆盖 | ✅ | 启发式关键词检测 |
| 术语一致性（语义） | ✅ | 硬编码矩阵规则 |
| 吹牛式表述识别 | ✅ | 硬编码示例提示 |
| 写作阶段推断 | ✅ | 硬编码阈值规则 |
| Tier2深度诊断 | ✅ | 跳过 |

**价值**：让用户明确了解"AI不可用时我会失去什么"

---

### 建议2：增加"AI可用性自检"命令（优先级：P3）

**建议**：
```bash
python scripts/run.py check-ai
```

输出：
```
✅ AI集成层已初始化
✅ responder已注入
✅ 已调用测试请求（test_echo）
⚠️  注意：当前运行在"优雅降级模式"（responder=None）
```

**价值**：帮助用户诊断"为什么AI功能不工作"

---

### 建议3：术语维度配置示例更丰富（优先级：P2）

**当前状态**：`config.yaml`的`terminology.dimensions`仅有3个示例（研究对象/指标/术语）

**建议**：
- 在`config/presets/medical.yaml`中增加医学领域的典型术语维度
- 在`config/presets/engineering.yaml`中增加工程领域的典型术语维度
- 在文档中说明"如何为我的项目定制术语维度"

**价值**：降低用户配置门槛

---

## 总结

### 核心观点

**nsfc-justification-writer的硬编码与AI功能规划非常合理**，体现了以下设计原则：

1. **最小可用产品（MVP）**: Tier1硬编码能力可独立运行，提供基础价值
2. **优雅降级**: 所有AI功能都有fallback，无responder时自动回退
3. **配置灵活性**: 三层配置（基础/preset/override）满足不同需求
4. **安全防护**: 白名单写入+质量闸门+备份回滚，多维度保护
5. **可维护性**: SSoT清晰，代码模块化，测试覆盖完善

### 是否需要重构？

**否**。当前架构已相当成熟，不建议大规模重构。

### 推荐的下一步（按优先级）

1. **P3**: 文档化"AI功能清单"（让用户明确了解AI依赖）
2. **P3**: 增加"AI可用性自检"命令（帮助诊断）
3. **P2**: 丰富术语维度配置示例（降低配置门槛）
4. **P2**: 增加降级场景的集成测试（提升可靠性信心）

### 可作为其他技能的参考模板

本技能的"硬编码 + AI"协同设计、优雅降级策略、配置系统、安全防护机制，均可作为其他NSFC写作技能（如`nsfc-aims-writer`/`nsfc-innovation-writer`）的参考模板。

---

**分析完成时间**: 2026-01-10
**分析者**: Claude Code（基于源代码调研）
**建议状态**: 可选优化（非阻塞）
