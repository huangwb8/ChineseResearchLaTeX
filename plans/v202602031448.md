# 优化计划（v202602031448）

**计划日期**: 2026-02-03  
**计划ID**: v202602031448  
**目标技能**: nsfc-abstract  
**目标技能路径**: skills/nsfc-abstract

---

## 独立评估与审查范围（强制）

- [x] 本轮基于目标 skill 的**当前工作状态**独立评估
- [x] **未查看**历史轮次的 `plans/` 与 `tests/`（计划阶段不依赖历史产物，避免确认偏差/路径依赖）

**必须审查文件**（参考 `config.yaml:a_round_check.independent_review.required_files`）：
- `SKILL.md` / `config.yaml`

**必须审查目录**（参考 `config.yaml:a_round_check.independent_review.required_dirs`）：
- `scripts/` / `references/` / `templates/` / `assets/`

**排除范围**：`plans/`、`tests/`、`README.md`、`CHANGELOG.md` 以及 `exclude_patterns` 命中的文件。

**扫描/审查证据（建议填入命令）**：
- `nl -ba skills/nsfc-abstract/SKILL.md | sed -n '1,120p'`
- `nl -ba skills/nsfc-abstract/scripts/validate_abstract.py | sed -n '1,140p'`
- `nl -ba skills/nsfc-abstract/config.yaml`
- `python3 -m py_compile skills/nsfc-abstract/scripts/validate_abstract.py`
- `python3 skills/nsfc-abstract/scripts/validate_abstract.py skills/nsfc-abstract/examples/demo_output.txt --strict`

---

## 问题清单（按优先级）

> 每个问题至少包含：位置（文件:行号）、影响、修复方式、验证方法。

### P0（必须修复）

1) `validate_abstract.py` 解析 config.yaml 的字符串值只兼容“带引号”的写法
- 位置：`skills/nsfc-abstract/scripts/validate_abstract.py:45`
- 影响：一旦维护者把 `config.yaml` 的 `format.*` 改成不带引号的标量（YAML 常见写法），脚本将无法读取配置而静默回退默认值，导致“口径以 config 为准”的承诺失效。
- 修复：改为先取整行 value、去掉行内注释，再按“可选引号”剥离；确保引号/不引号都可解析。
- 验证：
  - 新增单测覆盖：带引号/不带引号两种 config 写法都能正确读取分段标记与上限值
  - 运行：`python3 -m unittest -v skills/nsfc-abstract/tests/test_validate_abstract.py`

2) 缺失 `[ZH]/[EN]` 分段标记时的错误信息不可操作
- 位置：`skills/nsfc-abstract/scripts/validate_abstract.py:72`
- 影响：用户/维护者在脚本失败时不知道要如何修复输入（例如需要包裹标记、标记应以 config 为准），降低“确定性校验”的可用性。
- 修复：在错误输出中加入：期望标记、最小示例、以及“请按 SKILL.md/README 的输出格式重试”的提示；保持返回码不变。
- 验证：用不含标记的输入文件运行脚本，确认 stderr 包含修复提示且退出码为 2。

### P1（强烈建议）

1) 触发边界过宽：`triggers` 含“摘要”可能误触发
- 位置：`skills/nsfc-abstract/SKILL.md:20`
- 影响：用户只是在问“论文摘要/会议摘要/写作摘要”也可能触发，偏离本 skill 的“NSFC 标书摘要”定位（系统性问题：触发边界设计）。
- 修复：移除过宽触发词，改为更具体的触发短语（如“标书摘要/NSFC 摘要/青年基金 摘要/中英文摘要”）；必要时保留负向约束在 description 内。
- 验证：`rg -n \"triggers\" skills/nsfc-abstract/SKILL.md`，确认不再包含单独的“摘要”。

2) 计数口径不清：文档说“含标点与空格”，脚本会把换行也计入字符
- 位置：`skills/nsfc-abstract/SKILL.md:60` + `skills/nsfc-abstract/scripts/validate_abstract.py:79`
- 影响：用户如果按展示习惯换行排版，会导致校验更严格，造成“明明看起来没超限却超限”的困惑（系统性问题：规范口径与确定性校验不一致）。
- 修复：对 block 做轻量规范化：把任意连续空白折叠为单个空格再计数；同时在输出中明确“计数已做空白折叠”。
- 验证：构造包含多行/多空格的输入，确认脚本计数稳定且提示清晰。

3) 单一真相来源：限制值在文档中硬编码 400/4000，未明确“以 config.yaml 为准”
- 位置：`skills/nsfc-abstract/SKILL.md:7`、`skills/nsfc-abstract/README.md:5`
- 影响：未来若调整阈值，会出现“文档口径”和“脚本口径（来自 config）”不一致（系统性问题：一致性/配置集中化）。
- 修复：在 SKILL.md 与 README.md 中补充“默认 400/4000，以 config.yaml:limits 为准”的一句话说明。
- 验证：`rg -n \"config.yaml\" skills/nsfc-abstract/SKILL.md skills/nsfc-abstract/README.md`

4) 缺少回归测试：校验脚本是确定性关键路径但没有单测
- 位置：`skills/nsfc-abstract/scripts/validate_abstract.py:1`
- 影响：后续修改易引入回归（例如解析/计数口径/返回码），且难以及时发现（系统性问题：缺少确定性验证闭环）。
- 修复：新增 `skills/nsfc-abstract/tests/test_validate_abstract.py`（stdlib unittest），覆盖：
  - 正常解析与计数
  - 缺失标记报错与返回码
  - `--strict` 超限返回码
  - config 引号/不引号两种写法都能读取
- 验证：`python3 -m unittest -v skills/nsfc-abstract/tests/test_validate_abstract.py`

5) README 对脚本退出码/STDIN 用法未说明，降低可复现性
- 位置：`skills/nsfc-abstract/README.md:31`
- 影响：用户难以把校验集成到自己的流程（例如 CI/Makefile），也不清楚失败码语义。
- 修复：补充：`-` 表示从 stdin 读取、`--strict` 的返回码约定（0/1/2）。
- 验证：人工审阅 README.md 与脚本 `--help` 一致。

### P2（可选）

1) `config.yaml` 的 `content_points_min/max`、`zh_recommended_sentences` 未在 SKILL.md 明确引用
- 位置：`skills/nsfc-abstract/config.yaml:7`
- 影响：配置存在但不影响行为，增加维护噪声。
- 修复：在 SKILL.md 中补一句“研究内容默认 3-4 点/推荐 5 句（以 config 为准）”，或删去无用配置。
- 验证：`rg -n \"content_points\" skills/nsfc-abstract/SKILL.md` 能找到对应说明。

2) demo 输出缺少“仅示例”提示，容易被误解为推荐领域/结论
- 位置：`skills/nsfc-abstract/examples/demo_output.txt:1`
- 影响：用户可能把示例当作可直接复用的科学主张。
- 修复：在示例文件开头加一行注释说明“用于演示格式与校验，不代表真实数据/结论”。
- 验证：打开示例文件确认首行提示存在。

3) 脚本输出为英文标题 `Length Check`，与中文场景不一致
- 位置：`skills/nsfc-abstract/scripts/validate_abstract.py:85`
- 影响：可读性较弱但不影响功能。
- 修复：可改为中英文并列或纯中文；保持输出稳定。
- 验证：运行脚本确认输出符合预期。

---

## 执行步骤（按顺序）

1) 修复 `validate_abstract.py`：配置字符串解析兼容不带引号；错误信息更可操作；计数口径做空白折叠
2) 调整 SKILL.md：收窄 triggers；补充“默认阈值以 config 为准”与配置项引用
3) 调整 README.md：补充脚本 stdin/strict/退出码说明
4) 新增 stdlib 单测：`skills/nsfc-abstract/tests/test_validate_abstract.py`
5) 补充示例文件提示行
6) 轻量测试：py_compile + 单测 + demo/缺失标记/超限 三类用例，记录到 `tests/v202602031448/TEST_REPORT.md`

---

## 本轮轻量测试

- 会话目录：`tests/v202602031448/`
- 测试计划：`tests/v202602031448/TEST_PLAN.md`
- 测试报告：`tests/v202602031448/TEST_REPORT.md`
