# nsfc-justification-writer 改进计划（基于代码审查结论）

**创建/更新日期**：2026-01-10  
**适用范围**：`skills/nsfc-justification-writer/`（全量）  
**审查时技能版本**：v0.7.1  

---

## 目标

- 优先解决可能影响正确性/可诊断性的缺陷（异常处理、配置校验边界）。
- 在不改变用户可见行为的前提下，减少冗余、提升可维护性（Prompt 单一来源、配置访问口径统一、日志口径一致）。
- 形成“可交付 + 可验收”的执行清单，便于后续逐项落地。

## 范围与非目标

**范围**：
- `core/`（异常处理、配置校验、配置访问、日志）
- `prompts/` 与 Prompt 加载逻辑
- `scripts/`（输出与日志口径）

**非目标**（本计划不包含）：
- 新增功能/新命令
- 大规模重构（例如引入并发、重写 CLI 框架）
- 为并发场景做强保证（仅在明确需要时再纳入）

---

## 执行清单（按优先级）

### P0（优先保证正确性与可诊断性）

| 任务 | 交付物 | 验收标准 |
|------|--------|----------|
| 收紧 `except Exception`（E2） | 相关模块的异常捕获改为更具体的异常；必要时补充上下文信息 | 发生错误时能定位原因；非预期异常不被静默吞掉（至少保留堆栈或明确日志） |
| 明确 `terminology.dimensions` 允许为空与否（E1） | 配置校验规则与文档口径一致 | `validate-config` 行为与配置说明一致；不会出现“代码允许/校验拒绝”的矛盾 |

### P1（优先提升可维护性，避免重复与口径漂移）

| 任务 | 交付物 | 验收标准 |
|------|--------|----------|
| Prompt 单一来源（R1） | 选定一种权威来源并移除另一份冗余（文件/代码常量二选一） | 修改 Prompt 不需要两处同步；加载优先级清晰且有提示 |
| 日志口径统一（D1） | CLI 与核心模块统一到同一套日志策略（至少输出渠道/级别一致） | 关键路径不再混用 `print` 与 `logging`；可通过配置/参数控制日志级别（若已有机制则复用） |
| 清理未使用导入（L2） | 删除未使用 import/整理导入顺序 | 静态检查不再报未使用导入（以项目既有工具为准） |

### P2（优化项：在不扩张范围的前提下“补齐角落”）

| 任务 | 交付物 | 验收标准 |
|------|--------|----------|
| 配置访问口径统一（R2） | 统一使用 `core/config_access.py` 的 `get_*` 辅助方法 | 关键模块不再出现 `config.get(... ) or {}` 的重复样式 |
| 类型注解补齐（D2） | 对关键函数补齐类型注解（以增量为主） | 不引入新告警；类型变更不影响运行 |
| 版本号呈现策略明确（D3） | 明确“版本号展示在哪些文件出现/不出现”的约定并落地 | 版本口径不会分散且互相矛盾（与 `CHANGELOG.md` 保持一致） |

---

## 验证清单（建议）

- 单测：运行 `skills/nsfc-justification-writer/tests/` 目录下的现有用例（如项目当前已配置 pytest）。
- 烟测：跑一遍既有 CLI 的关键路径（如 `validate-config`、一次诊断/写入流程），确保无回归。

---

## 附录：问题索引（用于追踪）

- R1：Prompt 内容重复（`prompts/*.txt` vs `core/prompt_templates.py`）
- R2：配置访问模式重复（`config.get(... ) or {}`）
- L2：未使用导入/导入顺序问题
- E1：配置校验边界（`terminology.dimensions` 空 dict）
- E2：异常捕获过宽（`except Exception`）
- D1：日志记录不统一（`logging` 与 `print` 混用）
- D2：类型注解不完整
- D3：版本号呈现策略分散

---

本文件不记录变更历史；变更历史统一记录在 `CHANGELOG.md`。
