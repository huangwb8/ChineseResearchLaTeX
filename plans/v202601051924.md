# `transfer_old_latex_to_new` Skill 开发计划

**版本**: v1.0
**创建日期**: 2026-01-05
**状态**: 待审核
**开发者**: AI Agent (Claude Code)

---

## 📋 一、技能定位与目标

### 1.1 核心定位

**角色**: 顶级科学家思维的智能标书迁移助手
**使命**: 将旧版 NSFC 标书内容有机迁移到新版模板，保持科学逻辑完整性
**约束**: 严格遵守新模板结构，只修改内容文件（`extraTex/*.tex`），不破坏模板框架

### 1.2 与现有技能的生态关系

```
现有 NSFC 技能生态:
├── nsfc-writing-core      # 总则/守门员
├── nsfc-rationale-writer  # 立项依据写作
├── nsfc-aims-writer       # 内容目标问题写作
├── nsfc-methods-feasibility-writer  # 方案可行性写作
├── nsfc-innovation-writer # 特色与创新写作
├── nsfc-foundation-conditions-writer  # 研究基础写作
├── nsfc-workplan-writer   # 研究计划写作
└── nsfc-bib-manager       # 参考文献管理

新增技能:
└── transfer_old_latex_to_new  # 【跨版本迁移】智能迁移旧标书到新模板
```

**差异化优势**:
- 现有技能: 单章节写作/补强
- 新技能: 跨版本、跨结构、全流程智能迁移

---

## 🎯 二、核心工作流设计

### 2.1 高层流程图

```
┌─────────────────────────────────────────────────────────────┐
│                    Phase 0: 参数验证与准备                     │
├─────────────────────────────────────────────────────────────┤
│ 1. 验证输入路径有效性                                         │
│ 2. 检测项目结构标准性 (main.tex, extraTex/, @config.tex)    │
│ 3. 识别项目版本类型 (2025版 vs 2026版等)                     │
│ 4. 建立项目快照备份                                          │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│                  Phase 1: 双向结构深度分析                     │
├─────────────────────────────────────────────────────────────┤
│ 1.1 旧项目结构分析                                            │
│     ├── 解析 main.tex 提取章节树结构                         │
│     ├── 扫描 extraTex/ 识别内容文件清单                      │
│     ├── 分析 @config.tex 提取配置信息                        │
│     └── 生成结构化元数据: sections_map_old.json             │
│                                                              │
│ 1.2 新项目结构分析                                            │
│     ├── 同上流程分析新模板                                    │
│     └── 生成结构化元数据: sections_map_new.json             │
│                                                              │
│ 1.3 智能差异分析                                              │
│     ├── 章节对应关系推断 (基于语义相似度 + 结构启发式)       │
│     ├── 识别新增/删除/合并的章节                              │
│     ├── 检测结构破坏性变更 (如 1.1→独立成板块)               │
│     └── 生成迁移计划: migration_plan.json                   │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│               Phase 2: AI自主规划迁移策略                      │
├─────────────────────────────────────────────────────────────┤
│ 2.1 语义映射建立                                              │
│     ├── 旧章节 → 新章节 的映射关系矩阵                       │
│     ├── 内容拆分/合并决策 (如 1.1+1.2 → 新1.1)               │
│     ├── 内容扩充/裁剪建议 (如立项依据从1500字→2500字)        │
│     └── 新增内容识别 (如"研究风险应对"需新建)                │
│                                                              │
│ 2.2 迁移优先级排序                                            │
│     ├── 高优先级: 核心科学内容 (立项依据、研究内容)          │
│     ├── 中优先级: 方法与可行性                               │
│     └── 低优先级: 行政性信息 (承担项目、完成情况)            │
│                                                              │
│ 2.3 风险点识别                                                │
│     ├── 逻辑断裂风险 (板块间衔接)                             │
│     ├── 术语不一致风险                                       │
│     ├── 引用丢失风险                                         │
│     └── 格式破坏风险                                         │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│                  Phase 3: 内容智能迁移执行                     │
├─────────────────────────────────────────────────────────────┤
│ 3.1 一对一迁移 (简单映射)                                     │
│     ├── 直接复制对应文件内容                                  │
│     ├── LaTeX 语法基础检查                                    │
│     └── 写入新项目 extraTex/                                 │
│                                                              │
│ 3.2 一对多/多对一迁移 (结构重组)                              │
│     ├── 内容拆分: 按照新结构切分内容                         │
│     ├── 内容合并: 智能拼接并添加过渡段                       │
│     ├── 保持 LaTeX 环境完整性 (\section, \subsection)       │
│     └── 写入新项目 extraTex/                                 │
│                                                              │
│ 3.3 新增内容生成                                              │
│     ├── 识别缺失章节 (如"研究风险应对")                      │
│     ├── 基于旧项目内容生成补足内容                            │
│     ├── 调用其他 NSFC 写作技能 (nsfc-methods-feasibility)   │
│     └── 写入新项目 extraTex/                                 │
│                                                              │
│ 3.4 交叉引用修复                                              │
│     ├── 扫描 \ref{}, \cite{} 引用                            │
│     ├── 更新标签编号以匹配新结构                              │
│     └── 验证引用有效性                                       │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│               Phase 4: 迭代优化循环 (最多5轮)                  │
├─────────────────────────────────────────────────────────────┤
│ FOR round = 1 TO max_rounds (默认5, 可配置)                 │
│     ├── 4.1 质量评估                                         │
│     │       ├── 逻辑连贯性检查 (板块间衔接)                  │
│     │       ├── 科学内容完整性检查                            │
│     │       ├── 术语一致性检查                               │
│     │       └── LaTeX 编译验证                               │
│     │                                                        │
│     ├── 4.2 问题诊断                                         │
│     │       ├── 识别薄弱段落                                 │
│     │       ├── 逻辑跳跃点定位                                │
│     │       └── 表述不精确位置标记                            │
│     │                                                        │
│     ├── 4.3 优化执行                                         │
│     │       ├── 调用相关 NSFC 写作技能进行补强               │
│     │       ├── 优化过渡段                                    │
│     │       ├── 统一术语口径                                  │
│     │       └── 补充证据锚点                                  │
│     │                                                        │
│     ├── 4.4 收敛判断                                         │
│     │       IF 质量达标 OR 无明显改进 THEN                   │
│     │           提前退出循环                                  │
│     │       END IF                                           │
│     │                                                        │
│     └── 4.5 进度报告                                         │
│             记录当前轮次改进点                                │
│ ENDFOR                                                       │
│                                                              │
│ 输出: 优化报告 (optimization_report.md)                     │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│                    Phase 5: 最终验证与交付                     │
├─────────────────────────────────────────────────────────────┤
│ 5.1 LaTeX 编译验证                                            │
│     ├── 编译新项目 (xelatex → bibtex → xelatex → xelatex)  │
│     ├── 检查编译错误与警告                                    │
│     └── 修复问题直到编译通过                                  │
│                                                              │
│ 5.2 结构完整性检查                                            │
│     ├── 验证所有新模板章节均有内容                            │
│     ├── 检查章节编号连续性                                    │
│     └── 确认无空章节                                         │
│                                                              │
│ 5.3 内容质量终检                                              │
│     ├── 全文通读                                             │
│     ├── 关键科学论点核查                                      │
│     └── 引用完整性验证                                       │
│                                                              │
│ 5.4 交付物生成                                                │
│     ├── PDF 输出                                             │
│     ├── 迁移日志 (migration_log.md)                         │
│     ├── 变更摘要 (change_summary.md)                        │
│     └── 备份恢复说明 (restore_guide.md)                     │
└─────────────────────────────────────────────────────────────┘
```

### 2.2 关键决策点

| 决策点 | 默认策略 | 可配置性 |
|--------|----------|---------|
| **迭代轮次** | 最多5轮 | ✅ 用户Prompt可指定 |
| **迁移模式** | 智能分析后自动决策 | ✅ 可指定"保守/激进"模式 |
| **备份策略** | 自动创建快照 | ✅ 可选择备份位置 |
| **新增内容** | 调用写作技能生成 | ✅ 可选择"留空占位" |
| **LaTeX编译** | 最终必须通过 | ⚠️ 强制要求 |

---

## 🏗️ 三、技术实现方案

### 3.1 目录结构设计

```
skills/transfer_old_latex_to_new/
├── SKILL.md                    # 主指令文件
├── README.md                   # 用户使用指南
├── config.yaml                 # 可配置参数
├── CHANGELOG.md                # 变更日志
│
├── scripts/                    # 工具脚本
│   ├── analyze_structure.py    # 解析LaTeX项目结构
│   ├── compare_structures.py   # 结构差异分析
│   ├── generate_migration_plan.py  # 生成迁移计划
│   ├── migrate_content.py      # 执行内容迁移
│   ├── validate_latex.py       # LaTeX编译验证
│   ├── create_backup.py        # 创建项目快照
│   └── restore_backup.py       # 恢复项目快照
│
├── references/                 # 参考文档
│   ├── structure_mapping_guide.md    # 结构映射指南
│   ├── migration_patterns.md         # 常见迁移模式
│   ├── version_differences_2025_2026.md  # 版本差异详解
│   └── troubleshooting.md            # 故障排除
│
└── test/                       # 测试用例
    ├── test_simple_migration/    # 简单迁移测试
    ├── test_complex_restructure/  # 复杂重构测试
    └── test_edge_cases/          # 边缘情况测试
```

### 3.2 核心脚本设计

#### 3.2.1 `analyze_structure.py` - 结构解析器

**功能**:
- 解析 `main.tex` 提取章节树
- 扫描 `extraTex/` 目录识别内容文件
- 生成结构化元数据 JSON

**输出格式**:
```json
{
  "project_path": "/path/to/NSFC_Young",
  "version": "2025",
  "main_structure": {
    "sections": [
      {
        "level": 1,
        "title": "（一）立项依据与研究内容",
        "number": "1",
        "subsections": [
          {
            "level": 2,
            "title": "1. 项目的立项依据",
            "number": "1.1",
            "content_file": "extraTex/1.1.立项依据.tex",
            "word_count": 1500,
            "has_references": true
          }
        ]
      }
    ]
  },
  "extra_files": [
    "extraTex/@config.tex",
    "extraTex/1.1.立项依据.tex",
    ...
  ],
  "config": {
    "document_class": "ctexart",
    "compiler": "xelatex"
  }
}
```

#### 3.2.2 `compare_structures.py` - 差异分析器

**功能**:
- 对比新旧项目结构
- 识别章节对应关系
- 标记新增/删除/合并操作

**输出格式**:
```json
{
  "mapping": {
    "one_to_one": [
      {
        "old": "extraTex/1.1.立项依据.tex",
        "new": "extraTex/1.1.立项依据.tex",
        "similarity": 0.95
      }
    ],
    "one_to_many": [
      {
        "old": "extraTex/1.3.方案及可行性.tex",
        "new": [
          "extraTex/2.1.研究方案.tex",
          "extraTex/2.2.可行性分析.tex"
        ],
        "reason": "新模板将方案与可行性拆分"
      }
    ],
    "many_to_one": [
      {
        "old": [
          "extraTex/1.1.立项依据.tex",
          "extraTex/1.2.研究内容.tex"
        ],
        "new": "extraTex/1.1.立项依据.tex",
        "reason": "新模板合并为单一板块"
      }
    ],
    "new_added": [
      {
        "file": "extraTex/2.1.研究风险应对.tex",
        "reason": "新模板明确要求",
        "content_source": "generate_new"
      }
    ],
    "removed": [
      {
        "file": "extraTex/3.5.其它.tex",
        "reason": "新模板删除此章节"
      }
    ]
  },
  "structural_changes": {
    "major": [
      "第一板块从'立项依据与研究内容'拆分为两个独立板块"
    ],
    "minor": [
      "章节编号从数字改为汉字（一）（二）"
    ]
  }
}
```

#### 3.2.3 `generate_migration_plan.py` - 迁移计划生成器

**功能**:
- 基于差异分析生成详细迁移计划
- 按优先级排序迁移任务
- 标记潜在风险点

**输出格式**:
```json
{
  "migration_tasks": [
    {
      "id": 1,
      "priority": "high",
      "type": "one_to_one",
      "source": "old/extraTex/2.1.研究基础.tex",
      "target": "new/extraTex/3.1.研究基础与可行性.tex",
      "actions": [
        "复制内容",
        "检查LaTeX语法",
        "补充'研究风险应对'部分"
      ],
      "risks": [
        "需要新增风险分析内容",
        "可能需要调整章节结构"
      ]
    }
  ],
  "optimization_rounds": 5,
  "validation_checks": [
    "LaTeX编译通过",
    "所有章节非空",
    "引用完整性"
  ]
}
```

#### 3.2.4 `migrate_content.py` - 内容迁移执行器

**功能**:
- 执行迁移计划中的任务
- 处理内容拆分/合并
- 修复交叉引用

**关键逻辑**:
```python
def migrate_content(task, old_project, new_project):
    if task['type'] == 'one_to_one':
        # 直接迁移
        content = read_file(old_project / task['source'])
        content = fix_latex_syntax(content)
        write_file(new_project / task['target'], content)

    elif task['type'] == 'one_to_many':
        # 内容拆分
        content = read_file(old_project / task['source'])
        sections = split_content_intelligently(content, task['targets'])
        for target, section_content in zip(task['targets'], sections):
            write_file(new_project / target, section_content)

    elif task['type'] == 'many_to_one':
        # 内容合并
        contents = []
        for source in task['sources']:
            contents.append(read_file(old_project / source))
        merged = merge_contents_with_transitions(contents)
        write_file(new_project / task['target'], merged)

    elif task['type'] == 'new_added':
        # 生成新内容
        if task['content_source'] == 'generate_new':
            content = generate_new_content(task['context'])
            write_file(new_project / task['target'], content)
```

### 3.3 AI推理增强点

以下环节需要AI智能决策，无法硬编码:

| 决策点 | AI输入 | AI输出 |
|--------|--------|--------|
| **章节对应关系** | 章节标题、内容摘要 | 语义相似度评分、映射建议 |
| **内容拆分点** | 完整内容、目标结构 | 拆分位置、过渡段建议 |
| **内容合并策略** | 多个源内容、语义分析 | 合并顺序、衔接方案 |
| **新增内容生成** | 上下文、新模板要求 | 补足内容草案 |
| **优化评估** | 当前内容、质量标准 | 改进建议、收敛判断 |

---

## 📝 四、SKILL.md 内容大纲

### 4.1 YAML Frontmatter

```yaml
---
name: transfer-old-latex-to-new
description: 智能迁移旧版NSFC标书到新版模板：分析旧新项目结构、AI自主规划迁移策略、执行内容迁移、迭代优化、编译验证。用于用户要求"迁移标书/升级模板/跨版本迁移/旧标书转新模板"。
---
```

### 4.2 正文结构

```markdown
# LaTeX 标书智能迁移器

## 0.5) 深度参考版本差异指南（强制）
- 读取 `references/version_differences_2025_2026.md`
- 理解结构变化的科学政策背景
- 掌握常见迁移模式

## 0) 前置约束（每次迁移都要遵守）
- **只修改** `extraTex/*.tex` 内容文件（排除 `@config.tex`）
- **绝不修改** `main.tex` 模板结构
- **迁移前自动备份**原项目
- **LaTeX编译必须通过**才算完成

## 1) 触发条件识别
当用户提到以下关键词时触发本技能：
- "迁移标书"、"升级模板"、"跨版本迁移"
- "旧标书转新模板"、"2025转2026"
- "项目结构变化"、"内容重组"

## 2) 标准迁移工作流

### 2.1 准备阶段
[详细步骤...]

### 2.2 分析阶段
[详细步骤...]

### 2.3 迁移阶段
[详细步骤...]

### 2.4 优化阶段
[详细步骤...]

### 2.5 验证阶段
[详细步骤...]

## 3) 智能决策指南

### 3.1 章节对应关系推断
[启发式规则 + AI推理指导]

### 3.2 内容拆分/合并策略
[语义完整性保持原则]

### 3.3 新增内容生成
[调用其他技能的接口规范]

## 4) 迭代优化机制
- 评估标准定义
- 收敛判断逻辑
- 提前退出条件

## 5) 工具与脚本
- 脚本调用规范
- 输出格式要求
- 错误处理流程

## 6) 质量保证检查表
- 迁移前检查
- 迁移中检查
- 迁移后检查
```

### 4.3 参考文档清单

| 文档 | 用途 | 加载时机 |
|------|------|----------|
| `structure_mapping_guide.md` | 章节映射决策参考 | Phase 2 |
| `migration_patterns.md` | 常见迁移模式库 | Phase 2 |
| `version_differences_2025_2026.md` | 版本差异详解 | Phase 0 |
| `troubleshooting.md` | 故障排除指南 | 按需 |

---

## 🧪 五、测试策略

### 5.1 测试用例设计

#### 测试用例1: 简单一对一迁移
**场景**: 2025版 → 2026版，章节结构基本一致
**验证点**:
- 内容完整性
- LaTeX编译通过
- 无格式破坏

#### 测试用例2: 复杂结构重组
**场景**: 旧版"立项依据与研究内容"拆分为独立板块
**验证点**:
- 逻辑连贯性
- 过渡段质量
- 交叉引用正确性

#### 测试用例3: 新增内容生成
**场景**: 新模板要求"研究风险应对"但旧版缺失
**验证点**:
- 内容相关性
- 科学性
- 与整体一致性

#### 测试用例4: 边缘情况
**场景**:
- 空章节处理
- 特殊字符处理
- 图表引用处理

### 5.2 回归测试策略

每次 skill 更新后:
1. 运行全部测试用例
2. 记录性能指标 (执行时间、token消耗)
3. 对比基线版本

---

## ⚙️ 六、config.yaml 配置设计

```yaml
# transfer_old_latex_to_new 配置文件

# 迁移参数
migration:
  max_rounds: 5                    # 最大优化轮次
  backup_mode: "snapshot"          # 备份模式: snapshot/copy/none
  strict_mode: false               # 严格模式: 编译失败则中止

  # 迁移策略
  strategy:
    content_generation: "smart"    # 新增内容生成: smart/placeholder/skip
    reference_handling: "preserve" # 引用处理: preserve/update/recreate
    figure_handling: "copy"        # 图片处理: copy/link/skip

  # 质量阈值
  quality_thresholds:
    min_similarity: 0.7            # 最小语义相似度（用于自动映射）
    min_word_count: 100            # 最小章节字数（警告阈值）
    max_ref_errors: 5              # 最大引用错误数（警告阈值）

# 编译参数
compilation:
  engine: "xelatex"                # LaTeX引擎
  passes: 4                        # 编译轮数 (xelatex->bibtex->xelatex->xelatex)
  timeout: 120                     # 单次编译超时(秒)

# AI推理参数
ai:
  model: "claude-opus-4-5"         # 首选模型
  temperature: 0.3                 # 生成温度
  max_tokens_per_request: 8000     # 单次请求最大token

# 输出控制
output:
  generate_report: true            # 生成迁移报告
  generate_change_summary: true    # 生成变更摘要
  keep_intermediate: false         # 保留中间文件
  verbose: true                    # 详细日志
```

---

## 🚀 七、开发阶段规划

### 阶段1: 核心框架搭建 (预计2-3天)
- [ ] 创建目录结构
- [ ] 编写 SKILL.md 初稿
- [ ] 实现结构解析脚本 (`analyze_structure.py`)
- [ ] 实现差异分析脚本 (`compare_structures.py`)

### 阶段2: 迁移逻辑实现 (预计3-4天)
- [ ] 实现迁移计划生成器 (`generate_migration_plan.py`)
- [ ] 实现内容迁移执行器 (`migrate_content.py`)
- [ ] 实现备份/恢复脚本
- [ ] 编写参考文档

### 阶段3: 优化与验证 (预计2-3天)
- [ ] 实现迭代优化逻辑
- [ ] 实现 LaTeX 编译验证 (`validate_latex.py`)
- [ ] 集成现有 NSFC 写作技能
- [ ] 编写测试用例

### 阶段4: 测试与调优 (预计2-3天)
- [ ] 执行完整测试流程
- [ ] 性能优化
- [ ] 文档完善
- [ ] 用户接受度测试

**总计**: 约 9-13 天

---

## 🎯 八、成功标准

### 8.1 功能完整性
- ✅ 支持标准 NSFC LaTeX 项目结构
- ✅ 自动识别版本差异
- ✅ 智能规划迁移策略
- ✅ 执行内容迁移
- ✅ 迭代优化 (最多5轮)
- ✅ LaTeX 编译通过
- ✅ 生成完整交付物

### 8.2 质量标准
- ✅ 内容完整性 ≥ 95% (旧内容无遗漏)
- ✅ 逻辑连贯性评分 ≥ 4/5
- ✅ LaTeX 编译警告 ≤ 5个
- ✅ 执行时间 ≤ 10分钟 (中型项目)
- ✅ Token消耗 ≤ 100k (单次迁移)

### 8.3 用户体验
- ✅ 零学习成本 (用户提供路径即可)
- ✅ 进度可见 (每阶段输出报告)
- ✅ 可逆操作 (支持备份恢复)
- ✅ 清晰的日志和错误提示

---

## 📚 九、参考资源

### 内部资源
- [SKILL 开发技巧.md](/Users/bensz/Nutstore Files/PythonCloud/Agents/pipelines/skills/skill开发技巧.md)
- [CLAUDE.md - Skills 开发流水线](/Users/bensz/Nutstore Files/PythonCloud/Agents/pipelines/skills/CLAUDE.md)
- 现有 NSFC 写作技能集合

### 外部资源
- [Agent Skills 官方规范](https://agentskills.io)
- [Claude Skills Best Practices](https://platform.claude.com/docs/en/agents-and-tools/agent-skills/best-practices)
- NSFC 官方模板文档 (2025版、2026版)

---

## ✅ 十、待审核决策点

请用户确认以下关键决策:

| 决策点 | 建议方案 | 替代方案 | 需要确认? |
|--------|----------|----------|-----------|
| **迭代轮次默认值** | 5轮 | 3轮 / 7轮 | ✅ |
| **新增内容生成策略** | 调用写作技能 | 留空占位 | ✅ |
| **备份方式** | 自动快照 | 用户手动备份 | ✅ |
| **LaTeX编译失败处理** | 中止并报告 | 强制修复后继续 | ✅ |
| **优先开发阶段** | 按阶段1-4顺序 | 优先实现核心功能 | ✅ |

---

## 📝 十一、后续优化方向

### v1.1 规划
- 支持非标准项目结构
- 支持跨项目类型迁移 (如青年基金→面上项目)
- 增加可视化迁移预览

### v1.2 规划
- 支持增量迁移 (仅迁移变更章节)
- 支持批量迁移 (多项目并行)
- 增加迁移模板库

---

**文档版本**: v1.0
**最后更新**: 2026-01-05
**状态**: ⏳ 等待用户审核
