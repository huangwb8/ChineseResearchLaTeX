# nsfc-justification-writer 改良计划

**创建日期**: 2026-01-09
**计划版本**: v1.0
**目标版本**: v0.5.0

---

## 一、当前开发度评估

### 1.1 已完成模块（成熟度：高）

| 模块 | 状态 | 说明 |
|------|------|------|
| 核心代码 | ✅ | ~3100 行 Python，17 个测试全部通过 |
| CLI 工具链 | ✅ | diagnose/coach/apply-section/refs/terms/review/diff/rollback |
| Tier1 诊断 | ✅ | 结构/引用/字数/质量检查完整 |
| 安全写入 | ✅ | 白名单 + 备份 + 回滚机制 |
| 术语一致性 | ✅ | `build_term_matrix` + 跨文件检查 |
| HTML 报告 | ✅ | 可视化诊断报告 |
| 配置系统 | ✅ | 基础配置 + preset + 用户 override |
| 示例推荐 | ✅ | `example_matcher.py` + metadata 支持 |
| 文档 | ✅ | SKILL.md/architecture.md/tutorial.md |

### 1.2 代码统计

```
总代码行数: ~3094 行
测试用例: 17 个
测试覆盖率: 核心模块基本覆盖，AI 集成层不足
```

---

## 二、缺陷与改进机会

### 缺陷 1：AI 集成层验证不足

**现状**：
- `ai_integration.py` 的实际 AI 调用逻辑未在测试中覆盖
- Tier2 诊断依赖 AI，但 fallback 机制未充分测试
- 缺少 mock AI 响应的测试用例

**影响**：
- AI 服务故障时 fallback 行为不确定
- 无法验证 AI 响应格式是否符合预期
- 生产环境可能出现未处理的异常

**改进方案**：
1. 添加 `tests/test_ai_integration.py`：
   - mock API 响应测试成功/失败场景
   - 测试 fallback 机制是否正确触发
   - 测试响应格式验证
2. 添加 `tests/integration/test_ai_fallback.py`：
   - 模拟 AI 超时/错误/格式错误
   - 验证 tier2 诊断能否优雅降级

---

### 缺陷 2：跨章节引用检查未充分利用

**现状**：
- `config.yaml` 定义了 `related_tex`（研究内容、研究基础）
- `term_consistency_report()` 读取了这些文件，但关联分析薄弱
- 缺少术语/指标/研究对象的跨章节一致性验证

**影响**：
- 用户可能在不同章节使用不一致的术语
- 关键指标口径可能不统一
- 研究对象描述可能出现矛盾

**改进方案**：
1. 增强 `term_consistency.py`：
   - 添加 `CrossChapterValidator` 类
   - 实现术语/指标/研究对象的三维一致性矩阵
2. 添加 `tests/test_cross_chapter.py`：
   - 测试跨章节术语不一致的检测
   - 测试指标口径冲突的识别

---

### 缺陷 3：示例库覆盖不足

**现状**：
- 只有 4 个示例（medical/engineering/cs/materials）
- `examples/` 目录缺少 README 说明如何贡献新示例
- metadata.yaml 的关键字段未文档化

**影响**：
- 用户难以找到与自己领域相关的参考
- 示例推荐准确度受限
- 社区难以贡献新示例

**改进方案**：
1. 扩展示例库：
   - 新增 `examples/chemistry/`、`examples/biology/`、`examples/math/`
   - 每个示例包含 `.tex` + `.metadata.yaml` + `README.md`
2. 文档化 metadata schema：
   - 在 `examples/README.md` 中定义必填/可选字段
   - 提供 metadata 验证工具

---

### 缺陷 4：CLI 用户体验问题

**现状**：
- 长时间操作（如诊断大文件）缺少进度指示
- `--html-report auto` 的行为不够直观（输出路径不明确）
- 错误信息对新手不够友好

**影响**：
- 用户不知道进度是否卡住
- 生成的 HTML 报告难以找到
- 新手遇到错误时不知道如何处理

**改进方案**：
1. 添加进度指示器：
   - 使用 `rich.progress` 显示进度条
   - 对于大文件操作，显示当前步骤
2. 改进 HTML 报告输出：
   - 明确输出路径：`已生成报告：{path}`
   - 提供 `--open` 参数自动打开浏览器
3. 优化错误信息：
   - 为常见错误提供"如何修复"提示
   - 添加 `--verbose` 参数显示详细堆栈

---

### 缺陷 5：性能与可扩展性

**现状**：
- Tier2 诊断截断 `tex[:12000]`，大文件可能遗漏问题
- HTML 报告生成可能较慢（无流式输出）
- 术语矩阵计算复杂度为 O(n²)，大项目性能下降

**影响**：
- 长篇标书诊断不完整
- 用户等待时间过长
- 大型项目响应缓慢

**改进方案**：
1. 分块处理大文件：
   - 添加 `--chunk-size` 参数
   - 对每个 `\subsubsection` 分别调用 Tier2
2. 缓存诊断结果：
   - 使用 `.cache/` 目录存储中间结果
   - 添加 `--fresh` 参数强制重新计算
3. 优化术语矩阵算法：
   - 使用稀疏矩阵存储
   - 添加增量更新模式

---

### 缺陷 6：文档与测试覆盖不足

**现状**：
- `docs/tutorial.md` 内容较简略
- 缺少端到端示例工作流
- 测试用例仅 17 个，覆盖率不足

**影响**：
- 新手上手困难
- 不知道如何将各个功能串联使用
- 边缘情况可能出现 bug

**改进方案**：
1. 扩充 `tutorial.md`：
   - 添加"从零到立项依据"完整工作流
   - 添加"常见问题与解决方法"章节
2. 添加工作流示例：
   - 在 `docs/workflows/` 中添加典型场景的 step-by-step 指南
3. 补充测试用例：
   - `rollback`/`diff` 功能测试
   - `apply_section` 边界条件测试
   - 并发写入保护测试

---

### 缺陷 7：配置系统限制

**现状**：
- 仅提供 medical/engineering 两个 preset
- 用户自定义配置需要手动编写 YAML
- 缺少配置验证机制

**影响**：
- 其他学科用户需要手动配置
- 配置错误可能导致难以排查的问题
- 学科特定需求无法满足

**改进方案**：
1. 扩展 preset 库：
   - 新增 `chemistry.yaml`、`biology.yaml`、`math.yaml`
   - 每个预设包含学科特定的术语组和禁用词
2. 添加配置验证：
   - 使用 JSON Schema 验证 config.yaml
   - 提供 `--validate-config` 命令
3. 交互式配置生成：
   - 添加 `scripts/run.py config-init` 命令
   - 引导用户生成 override.yaml

---

### 缺陷 8：引用管理集成不深

**现状**：
- 仅检查 bibkey 是否存在
- 未验证 DOI 是否有效
- 未与 `nsfc-bib-manager` 深度集成

**影响**：
- 引用的论文 DOI 可能失效
- 无法自动补全缺失的引用信息
- 引用质量无法保证

**改进方案**：
1. 添加 DOI 验证：
   - 在 `reference_validator.py` 中添加 DOI 格式检查
   - 可选：通过 CrossRef API 验证 DOI 有效性
2. 与 `nsfc-bib-manager` 集成：
   - 添加 `--sync-bib` 命令调用 bib-manager
   - 自动补全缺失的引用条目

---

## 三、优先级计划

### P0（必须修复）

1. **AI 集成层测试** - 保证生产环境稳定性
2. **CLI 用户体验改进** - 降低上手门槛
3. **配置验证机制** - 避免配置错误导致的问题

### P1（重要改进）

4. **跨章节一致性检查** - 提升标书质量
5. **文档与测试覆盖** - 提升可维护性
6. **性能优化** - 支持大型项目

### P2（增强功能）

7. **示例库扩展** - 提升推荐准确度
8. **引用管理集成** - 保证引用质量

---

## 四、验收标准

- [ ] 所有新增测试通过
- [ ] 测试覆盖率达到 60% 以上
- [ ] 文档完整（tutorial/workflows/API）
- [ ] CLI 交互流畅（进度指示/友好错误）
- [ ] 大文件（>10000 行）诊断时间 < 10 秒
- [ ] 跨章节一致性检查可识别术语/指标冲突

---

## 五、变更历史

本计划文档的变更历史记录在根级 `CHANGELOG.md` 中。
