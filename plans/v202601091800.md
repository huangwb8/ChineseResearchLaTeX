# nsfc-justification-writer 改良计划

> **创建日期**：2026-01-09
> **当前版本**：v0.3.0
> **目标版本**：v0.4.0

---

## 一、开发度评估总结（修正版）

### 1.1 已实现能力（v0.3.0）

| 类别 | 功能 | 状态 | 完成度 |
|------|------|------|--------|
| **Tier1 硬编码诊断** | 结构检查（`\subsubsection` 数量/标题） | ✅ | 95% |
| **Tier1 硬编码诊断** | 引用核验（`.bib` key 存在性） | ✅ | 95% |
| **Tier1 硬编码诊断** | 字数统计（CJK 字符计数） | ✅ | 95% |
| **Tier1 硬编码诊断** | 质量规则（禁止短语/命令检测） | ✅ | 90% |
| **安全写入** | 白名单文件控制 + 备份 | ✅ | 95% |
| **版本管理** | diff/回滚功能 | ✅ | 95% |
| **术语一致性** | 基于 `alias_groups` 的跨章节检查 | ✅ | 75% |
| **CLI 工具** | diagnose/wordcount/refs/terms/coach/review | ✅ | 90% |
| **HTML 报告** | 可视化诊断报告 + 问题高亮 | ✅ | 85% |
| **信息表** | init 模板生成 + 交互式收集 + 必填验证 | ✅ | 90% |
| **AI 集成** | Tier2 语义分析 + fallback 机制 | ✅ | 85% |
| **AI 集成** | writing_coach 智能建议 + fallback | ✅ | 80% |
| **示例推荐** | 基于关键词匹配 examples/ | ⚠️ | 55% |

**总体完成度**：约 **85%**

### 1.2 测试覆盖情况

- **文件数量**：29 个 Python 文件
- **测试文件**：4 个 (`test_latex_parser.py`, `test_reference_validator.py`, `test_wordcount_and_diagnostic.py`, `e2e/test_cli_flow.py`)
- **测试通过**：8 个测试全部通过
- **覆盖率评估**：约 45-55%（缺少核心模块单元测试和边界情况测试）

---

## 二、缺陷清单（按优先级排序）

### 2.1 高优先级缺陷

#### 缺陷 #1：配置与文档不一致

**表现**：
- [SKILL.md:48-52](skills/nsfc-justification-writer/SKILL.md#L48-L52) 描述了"4 段闭环"叙事结构（价值与必要性→现状与不足→科学问题/假说→本项目切入点）
- [config.yaml:60-64](skills/nsfc-justification-writer/config.yaml#L60-L64) 的 `expected_subsubsections` 为 `["研究背景", "国内外研究现状", "现有研究的局限性", "研究切入点"]`
- 两者的对应关系未在文档中明确说明

**影响**：用户不清楚"价值与必要性"应该写在哪个 `\subsubsection` 下

**建议修复**：
1. 在 SKILL.md 中添加"推荐标题与内容映射表"
2. 在 `templates/structure_template.tex` 中添加注释说明每个部分的写作要点

---

#### 缺陷 #2：示例推荐功能不完善

**表现**：
- [core/example_matcher.py:41-47](skills/nsfc-justification-writer/core/example_matcher.py#L41-L47) 的 `_category_boost` 只支持硬编码的医学/工程两类
- [examples/](skills/nsfc-justification-writer/examples/) 目录下只有 2 个示例文件
- 缺少示例的元数据（关键词、难度、字数等）

**影响**：`examples` 命令推荐结果对非医学/工程领域不够准确

**建议修复**：
1. 为每个示例添加 `metadata.yaml`
2. 扩展 `_category_boost` 支持更多领域（信息学/材料/社科等）
3. 新增 3-5 个跨领域示例

---

### 2.2 中优先级缺陷

#### 缺陷 #3：测试覆盖不足

**表现**：
- 缺少对 [core/diagnostic.py](skills/nsfc-justification-writer/core/diagnostic.py) 的单元测试
- 缺少对 [core/writing_coach.py](skills/nsfc-justification-writer/core/writing_coach.py) 的单元测试
- 缺少对 [core/example_matcher.py](skills/nsfc-justification-writer/core/example_matcher.py) 的单元测试
- 缺少边界情况测试（空文件/超大文件/编码错误）

**影响**：代码质量保障不足，潜在 bug 可能未被发现

**建议修复**：
1. 为核心模块添加单元测试（目标覆盖率 80%+）
2. 添加集成测试：模拟完整写作流程
3. 添加边界测试

---

#### 缺陷 #4：与其他 Skill 集成不足

**表现**：
- [core/bib_manager_integration.py](skills/nsfc-justification-writer/core/bib_manager_integration.py) 仅生成建议文本
- `refs` 命令不会自动触发 `nsfc-bib-manager`
- `terms` 命令不会提示同步到其他章节

**影响**：用户需要手动在多个 Skill 间同步信息

**建议修复**：
1. 在 `refs` 命令输出中添加"可直接复制给 nsfc-bib-manager 的提示词"
2. 在 `terms` 命令输出中添加"建议同步到以下章节"的列表
3. 未来考虑 `--sync` 参数自动调用相关 Skill

---

### 2.3 低优先级缺陷

#### 缺陷 #5：HTML 报告可增强

**表现**：
- [templates/html/report_template.html:139](skills/nsfc-justification-writer/templates/html/report_template.html#L139) 声称"行号可点击定位"，但实际只是锚点跳转
- 缺少"复制行号"或"打开文件"按钮
- 问题高亮后没有"一键修复"提示

**建议修复**：添加"复制到剪贴板"按钮和更清晰的操作指引

---

#### 缺陷 #6：配置管理不够灵活

**表现**：
- [config.yaml:114-119](skills/nsfc-justification-writer/config.yaml#L114-L119) 的 `alias_groups` 是硬编码的
- 缺少用户配置覆盖机制
- 缺少针对不同学科的预设配置

**建议修复**：
1. 支持从 `~/.config/nsfc-justification-writer/override.yaml` 加载用户配置
2. 提供医学/工学/理学等学科的预设 `alias_groups`

---

#### 缺陷 #7：文档可进一步完善

**表现**：
- [README.md](skills/nsfc-justification-writer/README.md) 只有 75 行，缺少常见问题
- 缺少"首次使用指南"
- 缺少架构说明文档

**建议修复**：
1. 在 README 中添加 FAQ 部分
2. 添加 `docs/tutorial.md`（完整写作流程教程）
3. 添加 `docs/architecture.md`（架构说明）

---

## 三、已确认无误的功能（无需修复）

以下功能经源代码验证，实现正确，无需修复：

| 功能 | 验证结果 |
|------|----------|
| **AI 集成** | [core/ai_integration.py](skills/nsfc-justification-writer/core/ai_integration.py) 有完整实现，支持 `responder` 注入 + fallback 机制 |
| **Tier2 Prompt** | [prompts/tier2_diagnostic.txt](skills/nsfc-justification-writer/prompts/tier2_diagnostic.txt) 有 16 行内容，定义了 4 个诊断维度 |
| **信息表验证** | [core/info_form.py:59-79](skills/nsfc-justification-writer/core/info_form.py#L59-L79) 有完整的必填字段验证（`required=True`） |
| **LaTeX 安全写入** | [core/security.py](skills/nsfc-justification-writer/core/security.py) 有白名单机制，`apply-section` 会拒绝写入非白名单文件 |
| **危险命令检测** | [core/hard_rules.py](skills/nsfc-justification-writer/core/hard_rules.py) 有完整的 `forbidden_phrases` 和 `avoid_commands` 检测 |
| **术语一致性** | [core/term_consistency.py](skills/nsfc-justification-writer/core/term_consistency.py) 有完整的跨章节一致性检查 |
| **版本回滚** | [core/versioning.py](skills/nsfc-justification-writer/core/versioning.py) 有完整的备份/回滚机制 |

---

## 四、改良计划（按优先级执行）

### 阶段 1：修复高优先级缺陷（v0.3.1 → v0.3.2）

#### 1.1 统一配置与文档（缺陷 #1）

1. **在 SKILL.md 中添加映射表**
   ```markdown
   ## 推荐 `\subsubsection` 标题与内容映射

   | `\subsubsection` 标题 | 对应叙事段落 | 核心写作要素 |
   |------------------------|--------------|--------------|
   | 研究背景 | 价值与必要性 | 痛点→影响范围→为何现在做 |
   | 国内外研究现状 | 现状与不足 | 主流路线→代表性工作→2-4条不足 |
   | 现有研究的局限性 | 科学问题/假说 | 假说（可证伪）→关键科学问题 |
   | 研究切入点 | 本项目切入点 | 差异化切口→验证指标→过渡到研究内容 |
   ```

2. **在 `templates/structure_template.tex` 中添加注释**
   - 每个 `\subsubsection` 下方添加写作要点注释

#### 1.2 改进示例推荐（缺陷 #2）

1. **为现有示例添加 `metadata.yaml`**
   ```yaml
   # examples/medical/example_001.metadata.yaml
   category: medical
   keywords: [深度学习, 医学影像, 肺结节检测, 临床决策]
   difficulty: intermediate
   word_count: 3800
   structure_version: v2026
   description: 医学影像AI辅助诊断的立项依据示例
   ```

2. **扩展 `core/example_matcher.py` 的 `_category_boost`**
   - 支持信息学、材料、社科等更多领域
   - 从 `metadata.yaml` 读取关键词进行匹配

3. **新增 2-3 个跨领域示例**
   - `examples/cs/example_001.tex`（计算机科学）
   - `examples/materials/example_001.tex`（材料科学）

---

### 阶段 2：完善核心功能（v0.3.3 → v0.3.4）

#### 2.1 补充测试覆盖（缺陷 #3）

1. **为核心模块添加单元测试**
   - `tests/test_diagnostic.py`：测试 Tier1 诊断逻辑
   - `tests/test_writing_coach.py`：测试阶段判断逻辑
   - `tests/test_example_matcher.py`：测试示例匹配算法

2. **添加集成测试**
   - `tests/integration/test_full_workflow.py`：模拟完整写作流程

3. **添加边界测试**
   - 空文件/超大文件/非法字符/编码错误

#### 2.2 加强 Skill 集成（缺陷 #4）

1. **优化 `refs` 命令输出**
   - 添加"可直接复制给 nsfc-bib-manager 的提示词"段落

2. **优化 `terms` 命令输出**
   - 添加"建议同步到以下章节"的列表

---

### 阶段 3：优化用户体验（v0.3.5 → v0.4.0）

#### 3.1 改进 HTML 报告（缺陷 #5）

1. **添加"复制行号"按钮**
   - 使用 JavaScript 实现点击复制功能

2. **添加更清晰的操作指引**
   - 在问题高亮处添加"修复建议"提示

#### 3.2 灵活化配置（缺陷 #6）

1. **支持用户配置覆盖**
   - 从 `~/.config/nsfc-justification-writer/override.yaml` 加载
   - 文档说明如何自定义 `alias_groups`

2. **学科预设**
   - 添加 `config/presets/medical.yaml` 等
   - `--preset medical` 参数快速加载

#### 3.3 完善文档（缺陷 #7）

1. **扩展 README.md**
   - 添加 FAQ 部分

2. **添加 `docs/` 目录**
   - `tutorial.md`：完整写作流程教程
   - `architecture.md`：架构说明

---

## 五、实施注意事项

1. **保持向后兼容**：配置文件格式和 CLI 接口不应 breaking change
2. **测试驱动**：每修复一个缺陷，先添加测试，再修改代码
3. **文档同步**：代码修改后同步更新 SKILL.md 和 README.md
4. **变更记录**：所有修改记录在根级 `CHANGELOG.md`（不在各文件内维护版本历史）
5. **AI 功能可选**：确保没有 AI 也能使用基础功能（Tier1 硬编码能力）

---

## 六、验收标准

改良完成后，应满足：

1. ✅ 配置与文档完全一致（映射表清晰）
2. ✅ 示例推荐准确率 > 80%
3. ✅ 测试覆盖率 > 80%
4. ✅ 与其他 Skill 的集成提示清晰
5. ✅ HTML 报告有更清晰的操作指引
6. ✅ 支持用户配置覆盖
7. ✅ 文档包含 FAQ 和教程

---

**变更历史记录在 [CHANGELOG.md](../CHANGELOG.md)**
