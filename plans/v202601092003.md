# nsfc-justification-writer 改良计划

**创建日期**：2026-01-09
**评估版本**：v0.6.0
**评估范围**：完整代码库分析（核心模块、CLI、测试、文档）

---

## 一、开发度评估

### 1.1 总体成熟度

| 维度 | 评分 | 说明 |
|------|------|------|
| 核心功能完整性 | 85% | Tier1 诊断/安全写入/版本回滚/HTML 报告均已实现 |
| AI 集成度 | 40% | 接口预留完善，但缺少实际 AI 调用实现 |
| 测试覆盖率 | 50% | 单元测试存在但覆盖不全，缺少集成测试 |
| 文档完整性 | 75% | SKILL.md/架构/教程齐全，但 API 文档缺失 |
| 工程规范 | 80% | 类型注解/异常处理/日志良好，但部分模块耦合度较高 |

**结论**：项目处于「功能可用但需打磨」阶段，硬编码能力成熟，AI 能力为预留接口。

### 1.2 功能模块状态

| 模块 | 状态 | 缺陷等级 |
|------|------|----------|
| `diagnostic.py` | ✅ 成熟 | 低 |
| `editor.py` | ✅ 成熟 | 低 |
| `security.py` | ✅ 成熟 | 低 |
| `versioning.py` | ✅ 成熟 | 低 |
| `latex_parser.py` | ✅ 成熟 | 低 |
| `hybrid_coordinator.py` | ⚠️ 可用 | 中 |
| `writing_coach.py` | ⚠️ 可用 | 中 |
| `ai_integration.py` | ❌ 缺实现 | 高 |
| `term_consistency.py` | ⚠️ 部分实现 | 中 |
| `reference_validator.py` | ⚠️ 可用 | 中 |
| `example_matcher.py` | ⚠️ 可用 | 中 |

---

## 二、缺陷清单

### 2.1 高优先级缺陷（需立即修复）

#### 缺陷 H-1：AI 集成层为空壳

**位置**：`core/ai_integration.py`

**问题描述**：
- `AIIntegration` 类仅提供接口和 fallback 逻辑，缺少实际的 AI 调用实现
- `responder` 参数始终为 `None`，导致 `is_available()` 永远返回 `False`
- 所有依赖 AI 的功能（Tier2 诊断、术语一致性检查、示例推荐、写作引导）都会回退到硬编码逻辑

**影响**：
- Tier2 语义诊断无法工作
- AI 术语一致性检查无法生效
- AI 示例推荐无法提供可解释理由
- 写作引导无法利用 AI 生成个性化建议

**修复方案**：
1. 实现 `responder` 接口，连接到实际 AI 服务（如 OpenAI API、本地 LLM）
2. 添加配置项支持自定义 AI 端点和认证
3. 提供测试用的 mock responder
4. 在 `config.yaml` 中添加 AI 配置段（endpoint/api_key/model）

---

#### 缺陷 H-2：术语一致性检查功能不完整

**位置**：`core/term_consistency.py`

**问题描述**：
- `TermConsistencyAI` 类已定义但未被充分使用
- `terminology.mode` 配置项存在，但 AI 模式下的实际检查逻辑缺失
- 配置示例中的 `terminology.dimensions` 结构存在，但代码中处理不完整

**影响**：
- 跨章节术语一致性检查仅依赖硬编码别名组
- 无法捕捉隐含同义词/缩写混用
- 维护成本高（需手动维护大量别名组）

**修复方案**：
1. 完善 `TermConsistencyAI.check()` 方法，确保在 AI 可用时被调用
2. 修复 `CrossChapterValidator.build()` 中对 `dimensions` 的处理逻辑
3. 添加更多预设的 `alias_groups` 示例
4. 提供 AI 术语检查的 fallback 逻辑优化

---

#### 缺陷 H-3：配置验证逻辑缺失

**位置**：`core/config_loader.py`

**问题描述**：
- `validate_config()` 函数存在但检查项不足
- 未验证必需的配置项（如 `targets.justification_tex`）
- 未验证路径存在性（如 `prompts.*` 指向的文件）
- 未验证 `terminology.dimensions` 结构合法性

**影响**：
- 配置错误仅在运行时暴露，用户体验差
- 难以调试配置问题

**修复方案**：
1. 添加必需配置项检查
2. 添加路径存在性验证（可选）
3. 添加 `terminology.dimensions` 结构验证
4. 提供更友好的错误提示

---

### 2.2 中优先级缺陷（影响体验）

#### 缺陷 M-1：LaTeX 解析器边界情况处理不足

**位置**：`core/latex_parser.py`

**问题描述**：
- `strip_comments()` 对 `\verb` 和 `\lstinline` 的处理为近似实现
- 未处理 `\verb|...|` 中出现 `\%` 的特殊情况
- 未处理嵌套的 `\verb` 或 `\lstinline`（虽然 LaTeX 不允许）

**影响**：
- 极端情况下可能误删注释或保留注释
- 可能导致 `\subsubsection` 定位不准确

**修复方案**：
1. 完善 `\verb` 和 `\lstinline` 的边界情况处理
2. 添加单元测试覆盖边界情况
3. 考虑使用第三方 LaTeX 解析库（如 `pylatexenc`）

---

#### 缺陷 M-2：引用验证器 DOI 校验为可选功能

**位置**：`core/reference_validator.py`

**问题描述**：
- `verify_doi_via_crossref()` 函数已实现，但 CLI 仅在 `refs --verify-doi crossref` 时调用
- 默认流程中不进行 DOI 校验
- 超时处理为静默失败（返回 `False`），用户无感知

**影响**：
- 用户可能提交无效 DOI 而不自知
- Crossref API 调用成功率不可知

**修复方案**：
1. 在 `diagnose` 命令中添加可选的 DOI 校验步骤
2. 添加 DOI 校验结果的统计输出
3. 提供更细粒度的超时控制

---

#### 缺陷 M-3：示例推荐器匹配算法过于简单

**位置**：`core/example_matcher.py`

**问题描述**：
- `_tokens()` 函数仅支持英文和少量中文关键词
- `_category_boost()` 硬编码了类别-关键词映射
- AI 模式下的 `ExampleRecommenderAI` 未被充分测试

**影响**：
- 示例推荐准确性不高
- 扩展新类别需修改代码

**修复方案**：
1. 改进 tokenization，支持更多中文分词
2. 将类别-关键词映射移到配置文件
3. 添加示例推荐效果评估

---

#### 缺陷 M-4：写作引导阶段判断逻辑过于简化

**位置**：`core/writing_coach.py`

**问题描述**：
- `_infer_stage()` 函数的判断条件较为粗糙
- 未考虑用户已完成部分章节的情况
- 阶段转换阈值（如 `word_target * 0.4`）硬编码

**影响**：
- 阶段判断可能不准确
- 用户可能收到不合适的引导建议

**修复方案**：
1. 优化阶段判断逻辑，考虑更多因素
2. 将阈值移到配置文件
3. 支持用户手动覆盖阶段判断

---

#### 缺陷 M-5：HTML 报告模板过于简陋

**位置**：`templates/html/report_template.html`

**问题描述**：
- 报告样式简单，缺少交互功能
- 无代码折叠、高亮优化
- 无导出 PDF 功能

**影响**：
- 用户体验一般
- 不利于分享和存档

**修复方案**：
1. 改进 HTML 样式，添加更多交互
2. 添加代码折叠、高亮优化
3. 考虑添加导出 PDF 功能（使用 wkhtmltopdf 或浏览器渲染）

---

### 2.3 低优先级缺陷（优化建议）

#### 缺陷 L-1：缺少性能优化

**位置**：多处

**问题描述**：
- 大文件处理时可能占用较多内存
- 流式读取功能（`io_utils.py`）未被充分利用
- 缓存策略可优化

**影响**：
- 超大文件处理可能变慢
- 内存占用可能较高

**修复方案**：
1. 更广泛应用流式读取
2. 优化缓存策略
3. 添加性能监控

---

#### 缺陷 L-2：错误消息可改进

**位置**：多处

**问题描述**：
- 部分错误消息不够友好
- 缺少修复建议
- 错误堆栈信息默认不输出

**影响**：
- 用户调试困难
- 新手上手成本高

**修复方案**：
1. 统一错误消息风格
2. 为每个错误添加修复建议
3. 改进 `--verbose` 模式的输出

---

#### 缺陷 L-3：日志系统不完善

**位置**：多处

**问题描述**：
- 使用 `logging` 但未配置 handler
- 部分模块直接 `print()` 到 stderr
- 缺少日志级别控制

**影响**：
- 调试困难
- 无法控制输出详细程度

**修复方案**：
1. 配置统一的 logging handler
2. 移除 `print()`，改用 `logging`
3. 添加日志级别控制

---

#### 缺陷 L-4：测试覆盖不全

**位置**：`tests/`

**问题描述**：
- 部分核心模块缺少单元测试
- 缺少集成测试
- 缺少端到端测试

**影响**：
- 重构风险高
- 回归风险高

**修复方案**：
1. 补充缺失的单元测试
2. 添加集成测试
3. 添加端到端测试
4. 设置 CI/CD 自动化测试

---

#### 缺陷 L-5：文档可改进

**位置**：多处

**问题描述**：
- 缺少 API 文档
- 缺少开发者指南
- 示例不够丰富

**影响**：
- 新手上手成本高
- 二次开发困难

**修复方案**：
1. 生成 API 文档（使用 Sphinx）
2. 编写开发者指南
3. 添加更多示例

---

## 三、改良路线图

### 3.1 短期任务（1-2 周）

优先级：高

1. **实现 AI 集成层（H-1）**
   - 添加 OpenAI API 集成
   - 添加本地 LLM 支持（Ollama）
   - 更新配置文件和文档

2. **修复术语一致性检查（H-2）**
   - 完善 `TermConsistencyAI` 的使用
   - 修复 `dimensions` 处理逻辑

3. **增强配置验证（H-3）**
   - 补充验证逻辑
   - 改进错误提示

### 3.2 中期任务（2-4 周）

优先级：中

1. **改进 LaTeX 解析器（M-1）**
   - 完善边界情况处理
   - 添加单元测试

2. **优化引用验证器（M-2）**
   - 集成 DOI 校验到诊断流程
   - 添加统计输出

3. **改进示例推荐器（M-3）**
   - 改进 tokenization
   - 将映射移到配置

4. **优化写作引导（M-4）**
   - 改进阶段判断逻辑
   - 添加配置项

5. **改进 HTML 报告（M-5）**
   - 改进样式和交互
   - 考虑 PDF 导出

### 3.3 长期任务（1-2 月）

优先级：低

1. **性能优化（L-1）**
   - 更广泛应用流式读取
   - 优化缓存策略

2. **改进错误消息（L-2）**
   - 统一风格
   - 添加修复建议

3. **完善日志系统（L-3）**
   - 配置统一 handler
   - 移除 `print()`

4. **补充测试（L-4）**
   - 单元测试
   - 集成测试
   - 端到端测试

5. **改进文档（L-5）**
   - API 文档
   - 开发者指南
   - 更多示例

---

## 四、技术债务清单

| 债务项 | 位置 | 影响 | 建议处理时机 |
|--------|------|------|--------------|
| AI responder 未实现 | `ai_integration.py` | 高 | 立即 |
| 术语一致性 AI 未生效 | `term_consistency.py` | 高 | 立即 |
| 配置验证不足 | `config_loader.py` | 中 | 短期 |
| LaTeX 解析边界情况 | `latex_parser.py` | 中 | 中期 |
| 测试覆盖不全 | `tests/` | 中 | 中期 |
| 性能优化空间 | 多处 | 低 | 长期 |
| 日志系统不统一 | 多处 | 低 | 长期 |
| 文档缺失 | 多处 | 低 | 长期 |

---

## 五、总结

`nsfc-justification-writer` 是一个功能基础扎实、设计良好的项目，硬编码能力（Tier1 诊断、安全写入、版本回滚）已相当成熟。主要问题在于 AI 集成层为空壳，导致依赖 AI 的功能无法正常工作。

**建议优先处理**：
1. 实现 AI 集成层（H-1）
2. 修复术语一致性检查（H-2）
3. 增强配置验证（H-3）

完成这三项后，项目可达到「生产可用」状态。

---

**文档版本**：v1.0
**最后更新**：2026-01-09
