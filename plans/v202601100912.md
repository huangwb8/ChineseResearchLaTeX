# nsfc-justification-writer 安全措施审阅与改进建议

**创建/更新日期**：2026-01-10  
**审阅范围**：`skills/nsfc-justification-writer/`（代码 + CLI + 配置 + 测试）  
**审阅时技能版本**：v0.7.3（见 `skills/nsfc-justification-writer/config.yaml`）  

---

## 执行摘要

**结论**：整体“安全护栏”设计是**明确且有效**的：写入白名单 + 引用守护（防幻觉引用）+ 写入前质量闸门 + runs 备份/回滚，形成了可复现闭环。  
但存在一处**真实的安全缺口**：`guardrails` 在配置合并后可被置空/清空，导致写入白名单机制失效（属于“最小权限”被意外解除的风险）。此外还有一处**口径矛盾的可靠性缺口**：无 PyYAML 环境下的“降级可用性”与当前 `validate_config()` 的强校验相冲突（与测试用例的预期也不一致）。

---

## 已具备的安全措施（现状）

### 1) 写入白名单 + 禁止清单（最小权限写入）

- 写入目标在 `project_root` 内强制校验，且默认仅允许写入 `extraTex/1.1.立项依据.tex`：`skills/nsfc-justification-writer/core/security.py`
- 明确禁止写入 `main.tex`、`extraTex/@config.tex`、以及任意 `.cls/.sty`：`skills/nsfc-justification-writer/config.yaml`（`guardrails.*`）

**效果**：默认情况下，脚本无法改动主模板与样式文件，避免“结构被破坏/宏包被污染”。

### 2) 写入前引用守护（防幻觉引用）

- `apply-section` 默认严格拒绝缺失 bibkey 的 `\\cite{...}`：`skills/nsfc-justification-writer/core/hybrid_coordinator.py` + `skills/nsfc-justification-writer/core/reference_validator.py`
- `scripts/run.py` 对缺失引用输出可执行修复建议，并引导交给 `nsfc-bib-manager` 做核验：`skills/nsfc-justification-writer/core/bib_manager_integration.py`

**效果**：将“引用可核验性”前置成硬约束（默认），把幻觉引用的风险压到最低。

### 3) 写入前质量闸门（降低模板破坏与不当措辞风险）

- 命中 `\\section/\\input/...` 等危险命令可拒绝写入；高风险夸大表述可提示/可选阻断：`skills/nsfc-justification-writer/core/quality_gate.py` + `skills/nsfc-justification-writer/core/hard_rules.py`
- `apply-section --strict-quality` 仅对“本次新增正文”做阻断，避免被历史遗留内容“卡死”。

**效果**：把“破坏模板结构”的常见事故拦截在落盘前。

### 4) 可追溯与可回滚（降低误写入成本）

- 写入使用 `os.replace` 的原子替换；并可选自动备份：`skills/nsfc-justification-writer/core/editor.py`
- runs 目录记录备份/diff/rollback：`skills/nsfc-justification-writer/core/versioning.py` + `skills/nsfc-justification-writer/scripts/run.py`

**效果**：一旦误写，可快速 diff/回滚，降低不可逆损失。

### 5) 联网行为默认克制（可选、显式开启）

- 默认不直连外部大模型：AI 能力依赖运行环境注入 responder（不可用自动回退）：`skills/nsfc-justification-writer/core/ai_integration.py` + `skills/nsfc-justification-writer/scripts/run.py check-ai`
- Crossref DOI 校验是显式选项（`--verify-doi crossref`），且有超时与失败兜底：`skills/nsfc-justification-writer/core/reference_validator.py`

**效果**：默认不产生外部网络依赖；需要联网时也尽量“可控、可禁用、可超时”。

---

## 发现的问题（客观、与安全直接相关）

### P0：`guardrails` 可被 override 置空/清空，导致白名单失效（真实安全缺口）

**现象**：
- 写入白名单依赖 `guardrails.allowed_write_files` 非空；但当前配置合并逻辑允许把 `guardrails` 覆盖成 `null`/非 dict，或把关键列表覆盖为空列表。
- 一旦 `allowed_write_files` 为空，`validate_write_target()` 将不再执行白名单约束（只剩“在 project_root 内”的限制）。此时再配合 `targets.justification_tex` 被覆盖为其他路径，即可在 `project_root` 内改写非预期文件（仍然不影响 `.cls/.sty` 取决于 forbidden_globs 是否也被置空）。

**涉及代码**：
- 配置合并：`skills/nsfc-justification-writer/core/config_loader.py`（`_deep_merge` + override 机制）
- 白名单读取：`skills/nsfc-justification-writer/core/security.py`（`build_write_policy()` + `get_mapping()` 的“非 dict → {}”）

**风险判断**：
- 如果脚本仅由“完全可信的本机用户”运行：这是“自毁式”风险（误配置即可把护栏拆掉）。
- 如果脚本被集成到更上层工具链/自动化环境：这是潜在的**防护绕过面**（环境变量/全局 override 引入意外扩权）。

### P1：无 PyYAML 环境下“降级可用性”与当前强校验冲突（可靠性/口径缺陷）

**现象**：
- `config_loader.py` 中明确支持“未安装 PyYAML 时跳过 YAML 加载”；但随后会执行 `validate_config()` 的强校验（要求存在 `skill_info/targets/...` 等），按代码推断会导致 `load_config()` 直接失败。
- 与测试用例 `skills/nsfc-justification-writer/tests/test_config_loader_no_pyyaml.py` 的预期（无 PyYAML 仍可加载并至少保证 guardrails 生效）存在矛盾。

**影响**：
- 这不是“安全漏洞”，但会破坏“无依赖也能运行 Tier1/护栏”的承诺；在严格环境（无法装 PyYAML）下会导致工具不可用，从而迫使用户绕过流程（更容易出现手工误写入等风险）。

### P2：Prompt 允许从任意路径读取（潜在隐私/数据外泄面）

**现象**：
- `prompts.*` 支持指定任意文件路径（含绝对路径）：`skills/nsfc-justification-writer/core/prompt_templates.py`
- 若运行环境注入了真实 AI responder（可能联网），则“外部文件内容”有机会被拼入 prompt 并发送到外部（取决于上层如何使用该 prompt）。

**备注**：
- 这是“可用性/可配置性”带来的典型权衡；更像“需要明确告知用户的风险点”，而非必须移除的功能。

### P2：备份/回滚按 `filename` 选择，未来扩展到多目标时可能误回滚

**现象**：
- 备份与回滚匹配主要依赖 `target_path.name`：`skills/nsfc-justification-writer/core/editor.py` + `skills/nsfc-justification-writer/core/versioning.py`
- 当前仅写入一个固定文件时没问题；一旦允许多文件写入或目标文件名相同，存在“选错备份”的可能。

---

## 改进建议（按优先级，含验收标准）

### P0（必须）：保证 `guardrails` 不可被静默移除

1) **对 `guardrails` 做强校验**（推荐直接阻断，而非警告）
- 交付物：更新 `skills/nsfc-justification-writer/core/config_loader.py:validate_config()`，新增：
  - `guardrails` 必须是 dict
  - `allowed_write_files` 必须是非空字符串列表
  - `forbidden_write_globs/forbidden_write_files` 至少一个非空（可选，但建议）
- 验收标准：
  - `guardrails: null` / `allowed_write_files: []` 时，`validate-config` 返回失败；`load_config()` 默认拒绝运行。

2) **合并后兜底回填“安全关键项”**（双保险）
- 交付物：在 `load_config()` 完成 `_deep_merge` 后，对 `guardrails` 做一次“不可为空”的回填/修正（即使用户 override 写错，也能保证最小护栏仍在）。
- 验收标准：
  - 即使 YAML/override 把 `guardrails` 写成非 dict，也会自动回退到 `DEFAULT_CONFIG["guardrails"]`（或显式报错，二选一但需一致）。

### P1（建议）：修复无 PyYAML 的降级口径矛盾

- 交付物（二选一）：
  1) 扩充 `DEFAULT_CONFIG`，使其包含通过 `validate_config()` 所需的最小字段；或
  2) 当检测到 `yaml_available=false` 时，跳过强校验，仅保证 guardrails（并在 CLI 输出明确警告）。
- 验收标准：
  - 与 `skills/nsfc-justification-writer/tests/test_config_loader_no_pyyaml.py` 的预期一致（至少“可加载 + 护栏生效”）。

### P2（可选）：降低 Prompt 外部路径带来的隐私风险

- 交付物：
  - 在文档与 `validate-config` 输出中增加明确提示：当 `prompts.*` 指向绝对路径/skill_root 外路径时，打印“可能导致敏感信息被拼入 prompt”的警告。
  - 或增加配置开关：默认仅允许 `skill_root/prompts/` 下的文件；需要读取外部 prompt 时显式开启（opt-in）。
- 验收标准：
  - 用户能在运行前意识到“外部文件内容可能被用于 AI 请求”的风险。

### P2（可选）：备份/回滚用“相对路径”或元数据定位

- 交付物：
  - 备份路径改为保留相对路径（`backup/<run_id>/<relpath>`），或在 run logs 写入 `target_relpath` 并据此查找备份。
- 验收标准：
  - 支持未来扩展到多目标写入时仍可正确 diff/rollback（不误匹配）。

---

## 轻量验证清单（建议）

- 配置安全性：
  - `validate-config` 对 `guardrails: null` / `allowed_write_files: []` 必须失败。
- 写入权限：
  - `apply-section` 只能写入白名单文件；尝试将 `targets.justification_tex` 指向其他路径时必须被拒绝（默认配置下）。
- 隐私提醒：
  - 当 `--verify-doi crossref` 启用时，输出应明确提示“将联网请求 Crossref”并可设置超时。

---

本文件不记录变更历史；变更历史统一记录在 `CHANGELOG.md`。

