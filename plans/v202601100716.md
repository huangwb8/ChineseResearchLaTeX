# nsfc-justification-writer 代码审查报告

生成时间：2026-01-10

## 执行摘要

对 `skills/nsfc-justification-writer` 进行了全面的源代码审查，涵盖了核心模块 30+ Python 文件。整体代码质量较高，架构清晰，遵循了项目的设计哲学。发现的问题主要集中在：**配置冗余、未使用的代码残留、潜在的类型安全问题和一些可维护性改进空间**。

---

## 一、配置冗余问题

### 1.1 配置重复定义（高优先级）

**位置**：
- `core/config_loader.py` 的 `DEFAULT_CONFIG`
- `config.yaml`

**问题描述**：
`DEFAULT_CONFIG` 字典（约 100 行）与 `config.yaml` 文件存在大量重复配置。这违反了 DRY 原则，增加了维护成本。

**影响**：
- 修改配置时需要同时更新两处，容易遗漏
- 版本 0.7.0 中两处配置已存在差异风险

**设计原则（重要）**：
> **以 `config.yaml` 为单一真相来源（Single Source of Truth）**
> - `config.yaml` 是用户可编辑的配置文件，应作为权威来源
> - `DEFAULT_CONFIG` 仅作为"兜底值"，在 `config.yaml` 缺失或加载失败时提供最小可用配置
> - 任何配置变更都应优先修改 `config.yaml`，而非 `DEFAULT_CONFIG`

**改进方案**：

**方案 A（推荐）**：精简 `DEFAULT_CONFIG`，仅保留安全关键项
```python
# core/config_loader.py
DEFAULT_CONFIG: Dict[str, Any] = {
    # 仅保留"安全关键项"：即使 YAML 缺失也必须生效的默认值
    "guardrails": {
        "allowed_write_files": ["extraTex/1.1.立项依据.tex"],
        "forbidden_write_files": ["main.tex", "extraTex/@config.tex"],
        "forbidden_write_globs": ["**/*.cls", "**/*.sty"],
    },
    # 其他配置项从 config.yaml 读取，缺失时抛出明确错误
}
```

**方案 B**：完全移除 `DEFAULT_CONFIG`
```python
# config.yaml 缺失或无效时直接抛出错误
# 优点：强制用户明确配置，避免"静默降级"带来的隐蔽错误
# 缺点：可能降低上手友好性
```

**配套措施**：
1. 在 `config.yaml` 顶部添加注释：
   ```yaml
   # ═══════════════════════════════════════════════════════════
   # 本文件是 nsfc-justification-writer 的配置单一真相来源（Single Source of Truth）
   # 修改配置时，请优先编辑本文件，而非 core/config_loader.py
   # ═══════════════════════════════════════════════════════════
   ```
2. 在 SKILL.md 中明确说明配置优先级
3. 添加配置校验测试，确保 `config.yaml` 包含所有必需字段

### 1.2 `latex_style_contract` 配置项未使用

**位置**：`config.yaml` 第 86-94 行

**问题描述**：
```yaml
latex_style_contract:
  keep_commands:
    - "\\justifying"
    - "\\indent"
  avoid_commands:
    - "\\section"
    - "\\subsection"
    - "\\input"
    - "\\include"
```

此配置在代码中**从未被引用**，与 `quality.avoid_commands` 存在功能重叠。

**建议**：
- 移除 `latex_style_contract` 配置项
- 统一使用 `quality.avoid_commands`

### 1.3 `quality_contract` 配置项仅用于文档

**位置**：`config.yaml` 第 96-104 行

**问题描述**：
```yaml
quality_contract:
  must_include: [...]
  avoid: [...]
```

此配置在代码中**从未被引用**，仅出现在 SKILL.md 文档中作为说明。

**建议**：
- 将此配置移至 `references/quality_contract_guidelines.md` 等文档文件
- 或保留但添加 `_comment: "仅用于文档说明，代码层不强制执行"` 标注

---

## 二、未使用/残留代码

### 2.1 `intent_parser.py` 功能孤立

**位置**：`core/intent_parser.py`

**问题描述**：
- `intent_parser.py` 模块定义了 `ParsedIntent` 和 `parse_intent()` 函数
- 但在整个项目代码中**未被任何模块调用**
- `prompts/intent_parse.txt` 也未被使用

**建议**：
- 如果未来不打算使用此功能，建议移除
- 或在 SKILL.md 中标注为"预留扩展点"

### 2.2 `NSFCJustificationWriterError` 基类未充分利用

**位置**：`core/errors.py` 第 7-9 行

**问题描述**：
```python
class NSFCJustificationWriterError(Exception):
    """兼容旧命名：保留作为所有异常的基类。"""
```

注释说明是"兼容旧命名"，但所有异常都直接继承自 `SkillError`，`NSFCJustificationWriterError` 从未被实际使用。

**建议**：
- 移除 `NSFCJustificationWriterError`
- 统一使用 `SkillError` 作为基类

### 2.3 `core/__init__.py` 导出项不完整

**位置**：`core/__init__.py`

**问题描述**：
```python
__all__ = [
    "AIIntegration",
    "HybridCoordinator",
    "load_config",
]
```

很多核心类（如 `SkillError`、`DiagnosticReport`、`ApplyResult` 等）没有被导出，但 `run.py` 中通过直接导入模块使用。

**影响**：
- 降低代码可发现性
- 与"向外暴露的 API 应在 `__init__.py` 中声明"的最佳实践不符

**建议**：
- 补充核心类型到 `__all__`，或
- 明确说明"此 skill 不提供 Python API 入口，仅供内部使用"

---

## 三、类型安全问题

### 3.1 混合类型字典访问模式

**位置**：多处代码

**问题描述**：
```python
# 常见模式
value = config.get("key", {}) or {}
```

这种 `or {}` 模式在代码中大量出现，说明类型系统未被充分利用。

**建议**：
- 考虑使用 `TypedDict` 或 `pydantic` 定义配置模型
- 在关键路径添加类型检查工具（如 `mypy`）

### 3.2 `Any` 类型过度使用

**位置**：多处函数签名

**示例**：
```python
def check_new_body_quality(
    *,
    new_body: str,
    config: Dict[str, Any],  # Any 过于宽泛
    ...
```

**建议**：
- 定义具体的配置类型别名
- 至少为核心配置结构定义 `TypedDict`

---

## 四、可维护性问题

### 4.1 魔法数字和硬编码值

**位置**：多处

**示例**：
```python
# core/hybrid_coordinator.py:180
if int(target.stat().st_size) > 5 * 1024 * 1024:  # 5MB 阈值硬编码

# core/writing_coach.py:200
{tex_text[:3000]}  # 截断长度硬编码

# core/dimension_coverage.py:96
cleaned = cleaned[:20000]  # 最大字符数硬编码

# core/word_target.py:45
target = _clamp_int(target, lo=100, hi=20000)  # 字数范围硬编码
```

**硬编码值汇总**：

| 硬编码值 | 位置 | 用途 | 建议配置键名 |
|----------|------|------|--------------|
| `5 * 1024 * 1024` | hybrid_coordinator.py:180 | 大文件阈值 | `limits.max_file_size_mb` |
| `3000` | writing_coach.py:200 | 写作教练文本截断 | `limits.writing_coach_preview_chars` |
| `20000` | dimension_coverage.py:96 | AI 分析最大字符数 | `limits.ai_max_input_chars` |
| `20000` | term_consistency.py:295 | 术语一致性分析最大字符 | `limits.ai_max_input_chars` |
| `20000` | boastful_expression_checker.py:66 | 吹牛表述检查最大字符 | `limits.ai_max_input_chars` |
| `100` | word_target.py:45 | 字数最小值 | `limits.word_target_min` |
| `20000` | word_target.py:45 | 字数最大值 | `limits.word_target_max` |

**改进方案（用户已采纳）**：

**方案**：在 `config.yaml` 中新增 `limits` 配置节

```yaml
# config.yaml 新增配置节
limits:
  # 文件大小限制
  max_file_size_mb: 5

  # AI 输入字符限制（用于语义分析、术语一致性等）
  ai_max_input_chars: 20000

  # 写作教练预览字符数（用于快速展示当前状态）
  writing_coach_preview_chars: 3000

  # 字数目标范围限制
  word_target:
    min: 100
    max: 20000
```

**代码改造示例**：
```python
# core/hybrid_coordinator.py
max_bytes = config.get("limits", {}).get("max_file_size_mb", 5) * 1024 * 1024
if target.exists() and int(target.stat().st_size) > max_bytes:
    ...

# core/writing_coach.py
preview_chars = config.get("limits", {}).get("writing_coach_preview_chars", 3000)
{tex_text[:preview_chars]}

# core/dimension_coverage.py
max_chars = config.get("limits", {}).get("ai_max_input_chars", 20000)
cleaned = cleaned[:max_chars]
```

**优先级**：P2（可维护性）

**理由**：
- 这些阈值可能因用户需求、项目规模、AI 模型 token 限制而变化
- 放入配置文件后，用户可根据实际情况调整
- 不同项目（医学 vs 数学 vs 工程）可能有不同的合理阈值

### 4.2 注释和文档不足

**位置**：多处

**示例**：
- `core/boastful_expression_checker.py`：缺少"吹牛式表述"与"可验证表述"的区分标准文档
- `core/dimension_coverage.py`：缺少"4 个维度"的设计说明

**建议**：
- 为复杂逻辑添加设计文档
- 在 `references/` 目录下补充 `dimension_coverage_design.md` 等

### 4.3 错误处理中的 `except Exception` 过度使用

**位置**：多处

**示例**：
```python
# core/term_consistency.py:149
except Exception:
    term_matrix_md = "（未启用内容维度覆盖检查）"

# core/writing_coach.py:302
except Exception:
    dimension_md = "（未启用内容维度覆盖检查）"
```

**建议**：
- 捕获更具体的异常类型
- 添加日志记录以便调试

---

## 五、架构设计建议

### 5.1 AI 集成模式可以考虑统一

**当前状态**：
- 每个需要 AI 的模块（`DimensionCoverageAI`、`BoastfulExpressionAI`、`TermConsistencyAI` 等）都实现自己的 `check()` 方法
- 都有类似的 `_fallback()` 模式

**建议**：
- 考虑定义一个 `AITask` 基类或协议
- 统一 fallback、缓存、日志等行为

### 5.2 `HybridCoordinator` 类职责过重

**位置**：`core/hybrid_coordinator.py`

**问题描述**：
- `HybridCoordinator` 类有 400+ 行代码
- 承担了诊断、应用、字数统计、示例推荐等多种职责

**建议**：
- 考虑拆分为多个协调器类
- 例如：`DiagnosticCoordinator`、`ApplyCoordinator` 等

---

## 六、测试覆盖率观察

**发现**：
- `tests/` 目录下测试文件较完整
- 但部分核心模块缺少专门的单元测试（如 `word_target.py`、`info_form.py`）

**建议**：
- 补充边界条件测试
- 特别是正则表达式解析逻辑（如 `word_target.py` 中的各种数字格式解析）

---

## 七、文档一致性建议

### 7.1 SKILL.md 与 config.yaml 描述对齐

**问题**：
- SKILL.md 中的某些描述与 config.yaml 中的默认值不完全一致
- 例如：字数目标在不同地方的表述略有差异

**建议**：
- 建立配置文档自动生成机制
- 或定期进行一致性检查

### 7.2 版本号一致性

**位置**：
- `SKILL.md` 中的版本描述
- `config.yaml` 中的 `version: 0.7.0`
- 根级 `CHANGELOG.md`

**建议**：
- 确保版本号同步机制
- 考虑添加版本号检查测试

---

## 八、性能和资源优化建议

### 8.1 大文件流式处理

**优点**：
- `io_utils.py` 中已实现流式读取
- `iter_text_chunks_by_subsubsection_mark()` 支持大文件分块

**建议**：
- 在文档中更明确地说明"何时需要使用 `--tier2 --chunk-size` 参数"
- 添加性能基准测试

### 8.2 缓存策略

**当前**：
- AI 请求有缓存机制（`.cache/ai/`）

**建议**：
- 添加缓存清理工具/命令
- 在文档中说明缓存失效策略

---

## 九、优先级排序

| 优先级 | 问题类型 | 影响范围 | 建议行动 |
|--------|----------|----------|----------|
| P0 | 配置重复（1.1） | 维护性 | 统一配置来源 |
| P1 | 未使用代码（2.1-2.3） | 代码清洁度 | 移除或标注 |
| P1 | 类型安全（3.1-3.2） | 可靠性 | 逐步引入类型检查 |
| P2 | 文档不足（4.2） | 可维护性 | 补充设计文档 |
| P2 | 职责过重（5.2） | 可维护性 | 考虑重构 |
| P3 | 错误处理（4.3） | 可调试性 | 改进异常处理 |
| P3 | 性能优化（8.1-8.2） | 用户体验 | 文档化或工具化 |

---

## 十、总结

`nsfc-justification-writer` 整体代码质量较高，架构设计清晰，遵循了项目的 KISS、YAGNI 等工程原则。主要改进空间在于：

1. **消除配置冗余**：统一配置来源
2. **清理未使用代码**：降低认知负荷
3. **增强类型安全**：逐步引入类型检查
4. **补充文档**：为复杂逻辑添加设计说明

建议按优先级逐步改进，避免大规模重构带来的风险。

---

## 十一、已完成工作（2026-01-10）

### P0 任务：配置重复定义清理

**1. 精简 `DEFAULT_CONFIG`**
- [core/config_loader.py](../skills/nsfc-justification-writer/core/config_loader.py) 的 `DEFAULT_CONFIG` 从约 100 行精简到约 10 行
- 仅保留安全关键项（`guardrails`），其他配置统一从 `config.yaml` 读取

**2. 添加 SSoT 声明**
- 在 [config.yaml](../skills/nsfc-justification-writer/config.yaml) 顶部添加单一真相来源声明注释
- 在 [core/config_loader.py](../skills/nsfc-justification-writer/core/config_loader.py) 添加配置说明注释

### P1 任务：残留代码清理

**1. 删除未使用的 `intent_parser` 模块**
- 删除 [core/intent_parser.py](../skills/nsfc-justification-writer/core/intent_parser.py)
- 删除 [prompts/intent_parse.txt](../skills/nsfc-justification-writer/prompts/intent_parse.txt)
- 从 [core/prompt_templates.py](../skills/nsfc-justification-writer/core/prompt_templates.py) 移除 `DEFAULT_INTENT_PARSE_PROMPT` 和 `INTENT_PARSE_PROMPT`

**2. 简化异常继承链**
- [core/errors.py](../skills/nsfc-justification-writer/core/errors.py) 中移除 `NSFCJustificationWriterError` 基类
- `SkillError` 直接继承 `Exception`

**3. 删除未使用的配置项**
- 从 [config.yaml](../skills/nsfc-justification-writer/config.yaml) 删除 `latex_style_contract` 配置项
- 从 [config.yaml](../skills/nsfc-justification-writer/config.yaml) 删除 `quality_contract` 配置项
- 从 `prompts` 配置中删除 `intent_parse` 条目

### 清理总结

| 类别 | 删除项 | 位置 |
|------|--------|------|
| 模块 | `intent_parser.py` | core/ |
| 提示词 | `intent_parse.txt` | prompts/ |
| 配置 | `latex_style_contract` | config.yaml, DEFAULT_CONFIG |
| 配置 | `quality_contract` | config.yaml, DEFAULT_CONFIG |
| 配置 | `prompts.intent_parse` | config.yaml, DEFAULT_CONFIG |
| 类 | `NSFCJustificationWriterError` | core/errors.py |
| 常量 | `DEFAULT_INTENT_PARSE_PROMPT` | core/prompt_templates.py |
| 常量 | `INTENT_PARSE_PROMPT` | core/prompt_templates.py |

**代码行数减少**：
- `core/config_loader.py`: 388 行 → 309 行（-79 行，-20%）
- `core/errors.py`: 86 行 → 85 行（-1 行，-1%）
- `core/prompt_templates.py`: 174 行 → 155 行（-19 行，-11%）
- `config.yaml`: 157 行 → 139 行（-18 行，-11%）

---
