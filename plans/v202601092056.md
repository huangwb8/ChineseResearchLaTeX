# nsfc-justification-writer 改良计划（基于 v0.6.0 代码审查）

**创建日期**：2026-01-09  
**评估版本**：`skills/nsfc-justification-writer` v0.6.0  
**评估范围**：核心模块（`core/`）、CLI（`scripts/run.py`）、配置（`config.yaml`）、示例/文档（`examples/`、`docs/`、`references/`）、测试（`tests/`）

---

## 一、开发度评估（现状结论）

整体处于「**可稳定使用（Hard-coded 闭环成熟）+ AI 能力可选增强（接口预留完整）**」阶段。

- **闭环完整性**：已具备“信息表 → 诊断（Tier1）→ 分步引导（coach）→ 安全写入（apply-section）→ 术语一致性 → 评审建议 → 报告/回滚”的可复现流程。
- **工程化程度**：有配置加载与校验、白名单写入、原子写入、runs 备份、diff/rollback；测试包含单测 + e2e/集成（当前 `pytest` 全通过）。
- **AI 集成现实度**：`core/ai_integration.py` 采用 responder 注入 + graceful fallback，脚本层默认不会直接调用外部模型；Tier2/AI 术语/AI 示例推荐属于“有接口、可运行（在注入 responder 时）”。

---

## 二、缺陷清单（按优先级）

### P0（安全/正确性，建议优先）

1) **PyYAML 缺失时会静默降级，导致配置不生效（存在安全退化风险）**  
   - 位置：`skills/nsfc-justification-writer/core/config_loader.py`、`skills/nsfc-justification-writer/config.yaml`  
   - 现象：无 PyYAML 时 `_load_yaml_dict()` 直接返回 `{}`，意味着 `config.yaml`（含 `guardrails.allowed_write_files` 等关键约束）可能被忽略。  
   - 风险：白名单/禁写策略可能退化为“空策略”（默认允许写入 project_root 内任意文件），与 Skill 的契约不一致。

2) **引用解析未剔除注释/类 verbatim 环境，可能产生误报**  
   - 位置：`skills/nsfc-justification-writer/core/reference_validator.py`  
   - 现象：`parse_cite_keys()` 直接 regex 扫全文本，注释里或 `verbatim/lstlisting/minted` 中的 `\cite{}` 也可能被当成真实引用。  
   - 影响：`diagnose/refs/apply-section` 可能误判“缺失 bibkey”并阻塞写入（或提示噪音）。

### P1（体验/一致性，建议尽快）

3) **DEFAULT_CONFIG 与 `config.yaml` 语义不完全对齐，关键安全项应“默认就生效”**  
   - 位置：`skills/nsfc-justification-writer/core/config_loader.py`  
   - 现象：默认配置已覆盖结构/质量/目标文件等，但对 `guardrails` 等“安全关键项”的默认兜底不够明确（高度依赖 YAML 载入）。

4) **若开启 `apply-section --allow-missing-citations`，缺少“写入前质量闸门”**  
   - 位置：`skills/nsfc-justification-writer/core/hybrid_coordinator.py`、`skills/nsfc-justification-writer/core/diagnostic.py`  
   - 现象：写入前目前主要硬阻断缺失 bibkey；对新正文引入的危险命令/不可核验表述更多是“诊断提示”，缺少可选的“阻断模式”。  
   - 影响：用户在放宽引用约束时，更可能把“破坏模板/口号式”内容写进目标文件。

5) **runs/cache 产物未在仓库级明确忽略，易污染工作区**  
   - 位置：根级 `.gitignore`、`skills/nsfc-justification-writer/`  
   - 现象：`skills/nsfc-justification-writer/runs/`、`skills/nsfc-justification-writer/.cache/ai/`、`__pycache__/` 等更像“运行产物”，但缺少仓库级统一忽略策略。

### P2（可维护性/可扩展性，按需）

6) **`ai.min_success_rate_to_enable` 配置项未形成闭环策略**  
   - 位置：`skills/nsfc-justification-writer/config.yaml`、`skills/nsfc-justification-writer/core/ai_integration.py`  
   - 现象：统计存在，但未基于 success rate 做“自动熔断/恢复”策略；配置项容易误导使用者。

7) **字数统计口径仍偏“粗粒度”，对 LaTeX 命令/环境的剔除有限**  
   - 位置：`skills/nsfc-justification-writer/core/wordcount.py`  
   - 现象：目前以 CJK 字符统计为主（已剔注释），但未剔除命令参数、数学环境等；对“4000 字”这种强约束场景可能需要更可解释的口径。

---

## 三、改良目标（本轮聚焦）

1) **安全默认值不可退化**：无论依赖是否齐全，白名单写入与“禁改模板”必须始终生效。  
2) **引用诊断更准确**：减少注释/代码环境导致的误报。  
3) **体验更可控**：对“放宽引用约束”的用户提供可选的质量闸门（阻断/仅警告可配置）。  
4) **运行产物更干净**：避免 runs/cache 误入版本库与干扰协作。

---

## 四、实施计划（按优先级，从上到下）

### 1) 依赖与安全兜底（P0）

- 在 `core/config_loader.py` 中实现“安全关键项的默认兜底”：`guardrails`、`targets.bib_globs`、`quality.avoid_commands` 等至少与 `config.yaml` 的安全意图一致。  
- 明确依赖策略（二选一，择其一执行）：
  - **方案 A（更安全）**：缺少 PyYAML 时直接 fail-fast（提示 `pip install pyyaml`），避免“静默不加载配置”。  
  - **方案 B（更易用）**：缺少 PyYAML 时加载一个“内置等价默认配置”（覆盖 `guardrails` 等关键字段），并在 CLI 输出显式警告“当前未加载 config.yaml”。  
- 为上述行为补充单测：覆盖“无 PyYAML / 配置未加载”的行为与安全策略仍生效。

### 2) 引用解析准确性（P0）

- 在 `reference_validator.py` 引入 `latex_parser.strip_comments()`（并考虑 verbatim 类环境）后再做 `\cite{}` regex 扫描。  
- 为注释/`verbatim|lstlisting|minted` 中的 `\cite{}` 添加回归测试，确保不计入引用键。

### 3) 写入前质量闸门（P1）

- 为 `apply-section` 增加可选参数（例如 `--strict-quality` 或配置项）：  
  - 新正文引入 `quality.avoid_commands` 命中时拒绝写入；  
  - 新正文命中 `quality.forbidden_phrases` 时拒绝写入（或降级为强警告，按配置决定）。  
- 将闸门逻辑限定为“只对本次新增正文负责”，避免因为历史遗留内容导致无法继续迭代（可通过 diff 或仅检查 `new_body` 实现）。

### 4) 运行产物与仓库洁净度（P1）

- 在根级 `.gitignore` 增加：
  - `skills/nsfc-justification-writer/runs/`  
  - `skills/nsfc-justification-writer/.cache/`  
  - `skills/nsfc-justification-writer/**/__pycache__/`  
- 在 `skills/nsfc-justification-writer/scripts/README.md` 补充“runs/cache 为运行产物”的说明与清理建议。

### 5) AI 配置语义收敛（P2）

- 选择其一：
  - 实现基于 `min_success_rate_to_enable` 的“自动熔断/恢复”（需定义采样窗口与恢复条件）；或  
  - 移除该配置项并在文档中明确“AI 是否可用取决于 responder 注入”，避免误导。

### 6) 字数口径增强（P2）

- 在 `wordcount.py` 增加可选模式：  
  - `cjk_only`（现有，默认）  
  - `cjk_strip_commands`（粗剔除 LaTeX 命令与数学环境，输出更接近“正文字符数”的估计）  
- HTML 报告/CLI 输出中增加“口径说明”，避免用户误解。

---

## 五、验收标准（可复现）

- 在无 PyYAML 环境下，`apply-section` 仍严格只允许写 `extraTex/1.1.立项依据.tex`，且拒绝改 `main.tex` / `*.cls/*.sty` 等。  
- 引用解析不统计注释与 verbatim 类环境中的 `\cite{...}`。  
- `apply-section` 的质量闸门开启时，能阻断危险命令/不可核验表述（且不被历史遗留内容“卡死”）。  
- 运行 `python -m pytest -q skills/nsfc-justification-writer/tests` 全通过。  

---

## 变更历史

本计划不在本文档内维护变更历史；统一记录在根级 `CHANGELOG.md`。

