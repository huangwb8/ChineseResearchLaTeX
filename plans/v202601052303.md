# make_latex_model 优化计划

**计划编号**: v202601052303
**创建时间**: 2026-01-05 23:03
**计划状态**: 📋 待评审
**目标版本**: v2.1.0 - v2.3.0
**当前版本**: v2.0.0

---

## 📋 执行摘要

### 优化目标

基于对 `make_latex_model` skill 的全面源代码调研，本计划旨在系统性地提升技能的可用性、可扩展性和用户体验。

### 核心发现

**当前优势**：
- ✅ 三层配置合并系统完善
- ✅ 模板继承机制工作正常
- ✅ 自动化工具链完整（analyze_pdf.py, compare_headings.py, validate.sh）
- ✅ 测试覆盖充分（Auto-Test-01 通过，向后兼容性验证通过）

**主要不足**：
- ❌ 验证器插件系统定义但未实现
- ❌ PDF 像素对比工具缺失
- ❌ 工作流需手动执行多个步骤
- ❌ 跨平台兼容性有改进空间

### 优化优先级

| 优先级 | 类别 | 工作量 | 预期收益 |
|--------|------|--------|----------|
| P0 | 核心功能增强 | 2-3 周 | 🔥 高 |
| P1 | 工作流优化 | 1-2 周 | 🔥 高 |
| P2 | 跨平台兼容性 | 1 周 | 🟡 中 |

---

## 🎯 优化路线图

### 阶段 1: 核心功能增强（v2.1.0）

**时间规划**: 2-3 周
**目标**: 完善验证器插件系统，实现像素对比工具

#### 任务 1.1: 实现验证器插件系统

**状态**: ⏳ 待开始
**优先级**: P0
**工作量**: 5-7 天

**具体任务**:

1. **创建验证器模块结构**
   ```bash
   mkdir -p skills/make_latex_model/core/validators
   touch skills/make_latex_model/core/validators/__init__.py
   touch skills/make_latex_model/core/validators/compilation_validator.py
   touch skills/make_latex_model/core/validators/style_validator.py
   touch skills/make_latex_model/core/validators/heading_validator.py
   touch skills/make_latex_model/core/validators/visual_validator.py
   ```

2. **实现各验证器**

   **1.1.1 CompilationValidator（编译验证器）**
   - 检查 LaTeX 编译是否成功
   - 检查编译日志中的警告
   - 验证 PDF 文件生成
   - 跨平台编译测试（macOS/Windows/Linux）

   **1.1.2 StyleValidator（样式参数验证器）**
   - 验证行距设置（`baselinestretch` 或 `linespread`）
   - 验证颜色定义（`MsBlue RGB 0,112,192`）
   - 验证页面边距（左 3.20cm, 右 3.14cm）
   - 验证字号系统（三号、四号、小四等）
   - 验证标题格式（缩进、间距、编号）

   **1.1.3 HeadingValidator（标题文字验证器）**
   - 集成现有 `compare_headings.py` 逻辑
   - 验证一级标题文字（`section_1`, `section_2`, `section_3`）
   - 验证二级标题文字（`subsection_1_1` ~ `subsection_3_5`）
   - 生成 HTML 差异报告

   **1.1.4 VisualValidator（视觉相似度验证器）**
   - 检查 PDF 页面尺寸
   - 统计每行字数（需人工对比）
   - 提供视觉对比指导

3. **重构 validate.sh**
   - 使用 Python 验证器替代 shell 脚本检查
   - 保留 `validate.sh` 作为入口，调用 Python 模块
   - 支持动态选择验证器（`--validators compilation,style,heading`）

4. **更新配置文件**
   - 在 `templates/nsfc/base.yaml` 中配置验证器
   - 支持项目本地配置覆盖验证器设置

**验收标准**:
- [ ] 所有验证器继承 `ValidatorBase` 并正确注册
- [ ] `validate.sh` 输出与当前版本一致
- [ ] 支持选择性运行验证器
- [ ] 向后兼容性测试通过
- [ ] 代码覆盖率 > 80%

---

#### 任务 1.2: 实现 PDF 像素对比工具

**状态**: ⏳ 待开始
**优先级**: P0
**工作量**: 3-5 天

**具体任务**:

1. **创建像素对比脚本**
   ```bash
   touch skills/make_latex_model/scripts/compare_pdf_pixels.py
   ```

2. **实现核心功能**

   **1.2.1 PDF 转图像**
   - 使用 `PyMuPDF` (fitz) 渲染 PDF 页面
   - 支持自定义分辨率（默认 150 DPI）
   - 支持批量转换多页 PDF

   **1.2.2 像素对比算法**
   - 逐像素对比 RGB 值
   - 计算差异像素比例（`changed_ratio`）
   - 忽略微小差异（`tolerance=2`）
   - 生成差异热图

   **1.2.3 报告生成**
   - 文本报告（Markdown）
   - 可视化报告（HTML）
   - 差异图像导出（PNG）

3. **集成到工作流**
   - 更新 `validate.sh`，自动调用像素对比（如有基准 PDF）
   - 更新 `SKILL.md`，添加像素对比工具说明

**依赖**:
- PyMuPDF（已有）
- Pillow（图像处理）

**验收标准**:
- [ ] 能够对比两个 PDF 文件的像素差异
- [ ] `changed_ratio` 计算准确
- [ ] 生成 HTML 差异报告
- [ ] 支持批量对比多页 PDF
- [ ] 处理大型 PDF（>100 页）性能可接受（<30 秒）

---

#### 任务 1.3: 样式配置双向同步工具

**状态**: ⏳ 待开始
**优先级**: P1
**工作量**: 2-3 天

**具体任务**:

1. **创建同步脚本**
   ```bash
   touch skills/make_latex_model/scripts/sync_config.py
   ```

2. **实现核心功能**

   **1.3.1 LaTeX 配置解析**
   - 解析 `@config.tex` 中的样式定义
   - 提取颜色定义（`\definecolor`）
   - 提取字号定义（`\newcommand`）
   - 提取页面设置（`\geometry`）
   - 提取标题格式（`\titleformat`）

   **1.3.2 JSON 配置对比**
   - 读取 `analyze_pdf.py` 生成的 JSON
   - 对比 LaTeX 配置与 JSON 分析结果
   - 生成差异报告

   **1.3.3 配置修改建议**
   - 生成 LaTeX 代码修改建议
   - 支持自动修改（`--apply`）
   - 支持预览模式（`--dry-run`）

**验收标准**:
- [ ] 能解析 `@config.tex` 的样式定义
- [ ] 能对比 JSON 分析结果与 LaTeX 配置
- [ ] 生成准确的修改建议
- [ ] 支持自动修改和预览模式

---

### 阶段 2: 工作流优化（v2.2.0）

**时间规划**: 1-2 周
**目标**: 简化用户操作流程，提升用户体验

#### 任务 2.1: 一键式优化流程

**状态**: ⏳ 待开始
**优先级**: P1
**工作量**: 3-4 天

**具体任务**:

1. **创建优化脚本**
   ```bash
   touch skills/make_latex_model/scripts/optimize.sh
   touch skills/make_latex_model/scripts/optimize.py
   ```

2. **实现完整流程**

   **2.1.1 自动化流程**
   - 步骤 1: 分析 Word PDF 基准（调用 `analyze_pdf.py`）
   - 步骤 2: 提取标题文字（调用 `compare_headings.py`）
   - 步骤 3: 对比样式参数（调用 `sync_config.py`）
   - 步骤 4: 生成修改建议
   - 步骤 5: 修改 LaTeX 配置（可选，需确认）
   - 步骤 6: 编译 LaTeX 项目
   - 步骤 7: 运行验证器
   - 步骤 8: 生成优化报告

   **2.1.2 交互式确认**
   - 支持交互模式（`--interactive`）
   - 每步操作前询问用户确认
   - 支持跳过某些步骤

   **2.1.3 报告生成**
   - Markdown 报告（命令行查看）
   - HTML 报告（浏览器查看）
   - JSON 报告（程序调用）

3. **更新文档**
   - 更新 `SKILL.md`，添加一键优化说明
   - 更新 `scripts/README.md`

**验收标准**:
- [ ] 一条命令完成完整优化流程
- [ ] 支持交互式确认
- [ ] 生成多格式报告
- [ ] 错误处理完善

---

#### 任务 2.2: 交互式配置向导

**状态**: ⏳ 待开始
**优先级**: P1
**工作量**: 2-3 天

**具体任务**:

1. **创建向导脚本**
   ```bash
   touch skills/make_latex_model/scripts/setup_wizard.py
   ```

2. **实现向导功能**

   **2.2.1 交互式问答**
   - 项目名称/路径
   - 模板类型（NSFC_Young/NSFC_General/NSFC_Local/其他）
   - 优化级别（minimal/moderate/thorough）
   - Word 模板路径
   - 是否启用像素对比

   **2.2.2 自动生成配置**
   - 生成 `.template.yaml`
   - 生成 `artifacts/` 目录结构
   - 预下载依赖（检查 PyMuPDF 等）

   **2.2.3 配置导入**
   - 支持导入历史配置（`--import`）
   - 支持配置模板（`--template`）

**验收标准**:
- [ ] 用户无需查看文档即可完成配置
- [ ] 生成正确的配置文件
- [ ] 支持导入导出配置

---

### 阶段 3: 跨平台兼容性增强（v2.3.0）

**时间规划**: 1 周
**目标**: 提升用户体验，特别是 Windows 用户

#### 任务 3.1: Windows 兼容性改进

**状态**: ⏳ 待开始
**优先级**: P2
**工作量**: 2-3 天

**具体任务**:

1. **提供 .bat 脚本**
   - `scripts/validate.bat`
   - `scripts/benchmark.bat`
   - `scripts/optimize.bat`

2. **Python 脚本替代方案**
   - 将核心逻辑迁移到 Python
   - Shell 脚本仅作为入口
   - 使用 `subprocess` 调用 LaTeX 编译

3. **操作系统检测**
   - 使用 `platform` 模块检测 OS
   - 自动适配命令路径（如 `/` vs `\`）

**验收标准**:
- [ ] Windows 用户无需 Git Bash 即可运行
- [ ] 跨平台测试通过（macOS/Windows/Linux）
- [ ] 文档说明 Windows 特定注意事项

---

#### 任务 3.2: 字体路径自动检测

**状态**: ⏳ 待开始
**优先级**: P2
**工作量**: 1-2 天

**具体任务**:

1. **创建字体检测模块**
   ```bash
   touch skills/make_latex_model/core/font_detector.py
   ```

2. **实现字体检测功能**
   - macOS: `/System/Library/Fonts/`, `/Library/Fonts/`
   - Windows: `C:\Windows\Fonts\`
   - Linux: `/usr/share/fonts/`

3. **集成到模板配置**
   - 在 `templates/nsfc/base.yaml` 中定义字体路径规则
   - 支持用户自定义字体路径

**验收标准**:
- [ ] 自动检测系统字体路径
- [ ] 支持三主流操作系统
- [ ] 用户可覆盖字体路径

---

## 📊 优先级矩阵

| 任务 | 优先级 | 工作量 | 价值 | 紧急度 | 依赖 |
|------|--------|--------|------|--------|------|
| 1.1 验证器插件系统 | P0 | 5-7 天 | 🔥 高 | 🔥 高 | 无 |
| 1.2 PDF 像素对比工具 | P0 | 3-5 天 | 🔥 高 | 🔥 高 | 无 |
| 1.3 样式配置同步 | P1 | 2-3 天 | 🔥 高 | 🟡 中 | 1.2 |
| 2.1 一键式优化 | P1 | 3-4 天 | 🔥 高 | 🟡 中 | 1.1, 1.2 |
| 2.2 交互式向导 | P1 | 2-3 天 | 🟡 中 | 🟡 中 | 无 |
| 3.1 Windows 兼容性 | P2 | 2-3 天 | 🟡 中 | 🟢 低 | 无 |
| 3.2 字体路径检测 | P2 | 1-2 天 | 🟡 中 | 🟢 低 | 无 |

**图例**:
- 🔥 高: 核心功能，用户强需求
- 🟡 中: 重要功能，提升体验
- 🟢 低: 锦上添花，长期优化

---

## 🗓️ 时间规划

### 短期（1-2 月）：v2.1.0 - v2.3.0

**目标**: 完成核心功能增强、工作流优化和跨平台兼容性

| 周次 | 任务 | 交付物 |
|------|------|--------|
| 第 1 周 | 任务 1.1 验证器插件系统 | 核心验证器实现 |
| 第 2 周 | 任务 1.2 PDF 像素对比工具 | 像素对比脚本 |
| 第 3 周 | 任务 1.3 样式配置同步 + 任务 2.2 交互式向导 | 同步工具 + 向导 |
| 第 4 周 | 任务 2.1 一键式优化 | 优化脚本 + 文档 |
| 第 5 周 | 任务 3.1 Windows 兼容性 + 任务 3.2 字体检测 | .bat 脚本 + 字体检测 |

**里程碑**: v2.3.0 发布（核心功能完善 + 跨平台支持）

---

## 🎯 成功指标

### 技术指标

| 指标 | 当前值 | 目标值 | 测量方法 |
|------|--------|--------|----------|
| 验证器数量 | 0 | 4+ | ValidatorRegistry.list() |
| 支持的模板数量 | 3 | 10+ | templates/ 目录 |
| 文档完整度 | 70% | >85% | 文档检查清单 |

### 用户体验指标

| 指标 | 当前值 | 目标值 | 测量方法 |
|------|--------|--------|----------|
| 首次使用时间 | 30 分钟 | <10 分钟 | 用户测试 |
| 工作流步骤数 | 7 步 | 1-2 步 | 流程分析 |
| Windows 兼容性 | 需 Git Bash | 原生支持 | 用户反馈 |
| 错误提示友好度 | 60% | >85% | 用户调研 |

---

## ⚠️ 风险与缓解

### 风险 1: 验证器重构引入回归

**概率**: 中
**影响**: 高

**缓解措施**:
- 保留旧版本 `validate.sh` 作为备份
- 充分的手动测试
- 灰度发布（先在少数项目测试）

---

### 风险 2: 跨平台兼容性问题

**概率**: 高
**影响**: 中

**缓解措施**:
- 提供详细的平台特定文档
- 社区反馈快速响应
- 在主流平台进行手动测试

---

## 📚 参考资源

### 内部文档

- [SKILL.md](../skills/make_latex_model/SKILL.md) - 技能定义
- [scripts/README.md](../skills/make_latex_model/scripts/README.md) - 工具文档
- [tests/Auto-Test-01/FINAL_REPORT.md](../skills/make_latex_model/tests/Auto-Test-01/FINAL_REPORT.md) - 测试报告
- [CHANGELOG.md](../CHANGELOG.md) - 变更历史

### 外部资源

- [Keep a Changelog](https://keepachangelog.com/zh-CN/1.1.0/) - 变更日志规范
- [PyMuPDF 文档](https://pymupdf.readthedocs.io/) - PDF 处理库
- [pytest 文档](https://docs.pytest.org/) - 测试框架
- [GitHub Actions 文档](https://docs.github.com/actions) - CI/CD

---

## ✅ 行动项

### 立即行动（本周）

1. **评审本计划** - 团队讨论优先级和时间规划
2. **创建任务看板** - 使用 GitHub Projects 或类似工具
3. **设置开发环境** - 准备测试环境和依赖

### 短期行动（2 周）

1. **开始任务 1.1** - 实现验证器插件系统
2. **设计测试用例** - 覆盖所有验证器
3. **更新 CI/CD** - 自动运行测试

### 中期行动（1-2 月）

1. **完成核心功能** - 任务 1.1 - 2.2
2. **发布 v2.2.0** - 核心功能完善版本
3. **收集用户反馈** - 改进用户体验

---

## 📝 版本历史

| 版本 | 日期 | 变更 |
|------|------|------|
| v1.0.0 | 2026-01-05 23:03 | 初始版本 |

---

**维护者**: Claude Code
**评审状态**: 📋 待评审
**下一步**: 请评审本计划并提供反馈
