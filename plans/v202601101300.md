# nsfc-justification-writer「理论创新导向优化」源代码审查与改进建议

**创建时间**：2026-01-10 13:00  
**审查对象**：`skills/nsfc-justification-writer/`（含 `core/`、`prompts/`、`templates/`、`references/`、`scripts/`、`tests/`）

## 审查方法与覆盖范围

- 全量检索“理论创新/`theoretical`”相关变更点：确认主要涉及 `references/`、`templates/`、`prompts/`，以及 `core/writing_coach.py`、`core/review_advice.py`。
- 对 `skills/nsfc-justification-writer/**/*.py` 执行语法编译检查（`py_compile`）：用于验证“代码可运行性”这一最低门槛。
- 快速通读协调器与脚本入口：确认语法错误会在导入期阻断 `scripts/run.py` 的多数子命令。

## 结论摘要（客观）

该“理论创新导向优化”在文档与提示词层面的规划方向是明确的（DoD + 写作教练 + 句式模板 + 信息表约束），但当前实现存在 **P0 级缺陷**：两处 Python 源码出现 **SyntaxError**，导致 `nsfc-justification-writer` 的脚本入口在导入阶段即失败，相关功能无法使用（包含本次新增/修改的“写作教练/评审建议”链路）。

## 发现的问题与改进建议（按优先级）

### P0（阻断使用）：Python 语法错误导致整个 skill 运行失败

**问题 1：`core/review_advice.py` 中字符串包含未转义的双引号**
- 证据：`skills/nsfc-justification-writer/core/review_advice.py:27` 等多处，形如：`"你的一句话问题定义是否让"非本细分领域评审"也能理解？",`
- 影响：
  - 任何导入 `core.review_advice` 的路径都会直接 `SyntaxError`。
  - 由于 `core/hybrid_coordinator.py` 顶层导入 `generate_review_markdown`，`scripts/run.py` 在初始化时就会失败（不局限于 `review` 子命令）。
- 建议修复：
  - 统一改用单引号包裹字符串，或转义内部双引号，或改为中文引号 `“…”`，避免破坏 Python 字面量。
  - 修复后增加最小回归：将该模块纳入 `pytest`/`py_compile` 的自动检查（见 P1 建议）。

**问题 2：`core/writing_coach.py` 中字符串包含未转义的双引号**
- 证据：`skills/nsfc-justification-writer/core/writing_coach.py:96`、`skills/nsfc-justification-writer/core/writing_coach.py:115` 等，形如：`"- 不新增引用；如必须引用，请先提示"需用户提供 DOI/链接或走 nsfc-bib-manager 核验"\n"`
- 影响：
  - `core.writing_coach` 直接 `SyntaxError`，导致 `coach` 链路不可用。
  - 同样会在 `core/hybrid_coordinator.py` 顶层导入 `coach_markdown` 时阻断脚本运行。
- 建议修复：同上（字符串字面量统一风格与转义策略）。

**额外客观证据（可复现）**
- `py_compile` 全量检查结果：仅上述 2 个文件报错，其余 `.py` 可正常编译通过。

### P1（一致性/可控性）：理论创新导向约束在“AI 可用 vs 回退路径”之间存在不一致风险

**问题 3：`review_suggestions` 的 AI Prompt 未显式强调“理论创新导向”**
- 现状：
  - AI 路径使用 `skills/nsfc-justification-writer/prompts/review_suggestions.txt`，其中未显式声明“默认理论创新导向”。
  - 理论创新导向目前主要通过 `dod_checklist.md` 的一条 DoD 约束“间接注入”（如果评审生成器严格遵循 DoD 则影响较小，但这依赖模型行为）。
  - 回退路径（`_fallback_review_markdown`）则显式使用“理论层面瓶颈/验证方式”等表述（且目前因 P0 语法错误不可用）。
- 风险：AI 可用时生成的“评审问题/建议”可能偏工程导向，与“默认理论创新导向”的产品口径不完全一致。
- 建议改进：
  - 在 `review_suggestions.txt` 的“约束”中增加 1 行明确的风格约束（与 `writing_coach.txt` 同口径），降低对“DoD 间接注入”的依赖。
  - 若未来支持多学科/多风格，建议把“导向”做成可配置参数（见 P2）。

**问题 4：“引用某文件路径”对非工具型 responder 可能不可见**
- 现状：`writing_coach.txt`/代码提示中多次写“详见 references/theoretical_innovation_guidelines.md”。
- 风险：`AIIntegration` 只传递 prompt 文本，本身不会自动把该文件内容拼入 prompt；如果 responder 并不具备文件读取能力，则“详见 …”对模型不可用，导向约束可能变弱。
- 建议改进（不增加复杂度的前提下）：
  - 从 `theoretical_innovation_guidelines.md` 抽取“最小可执行清单（5–8 条）”，直接内联到关键 prompt（`writing_coach.txt`、`review_suggestions.txt`）的约束区；或在配置层增加可选的 `prompts.preamble` 用于统一注入。

### P2（产品化体验）：缺少“导向切换/自适应”机制（可选改进）

**问题 5：当前“理论创新导向（默认）”缺少显式开关**
- 现状：理论创新导向写在文档/DoD/教练提示中，但配置中没有 `writing_style=theoretical|engineering|mixed` 之类的参数。
- 影响：当用户项目确实偏工程落地时，可能需要额外 prompt 工程来“反向纠偏”（虽 `theoretical_innovation_guidelines.md` 已给出工程导向项目的处理策略，但未形成可控入口）。
- 建议（可选，避免过度设计）：
  - 增加一个轻量参数（例如 `style: theoretical|mixed`，默认 `theoretical`），只影响 prompt 模板的几行“约束语”，不要改动诊断/写入等核心逻辑。

## 哪些地方“规划很合理”（保留优点，避免过度指责）

- 通过 `dod_checklist.md` 将“理论创新导向”纳入验收口径，避免只停留在口号层面。
- 将导向落到“可执行行为”：信息表引导（`info_form.md`）、句式模板（`templates/phrase_patterns.md`）、写作教练（`writing_coach.txt`）的闭环设计是自洽的。
- 整体架构仍遵循“AI 可用则增强，不可用则回退”的优雅降级思路（但必须先修复 P0 语法错误才能发挥）。

---

本计划文档的变更历史记录在 `CHANGELOG.md`。

