# guide-updater 硬编码 vs AI 智能规划分析

**创建日期**：2026-01-10
**评估版本**：`skills/guide-updater` v1.0.0
**分析范围**：核心文档（`SKILL.md`）、配置（`config.yaml`）、脚本（`scripts/`）、参考（`references/`）

---

## 一、硬编码部分

### 1. 结构验证规则（`scripts/validate_guide.py`）

| 项目 | 硬编码内容 | 文件位置 |
|------|-----------|---------|
| **必需标题列表** | `["## 写作哲学", "## 命名与术语", ...]` | `validate_guide.py` L9-L17 |
| **禁止片段列表** | `BANNED_SNIPPETS: list[str] = []` | `validate_guide.py` L19 |
| **退出码约定** | `2=文件缺失, 3=UTF-8错误, 4=标题缺失, 5=禁止片段` | `validate_guide.py` L43-L50 |

**设计理由**：
- 必需标题列表是项目指南的"骨架"，保证核心结构完整
- 退出码约定便于脚本自动化集成
- 禁止片段列表可用于检测"意外新增结构"（如新的 `##` 级标题）

### 2. 结构映射规则（`references/guide-structure-map.md`）

| 项目 | 硬编码内容 | 文件位置 |
|------|-----------|---------|
| **放置优先级** | 5 级优先级规则（口径漂移 > 评审质疑 > 可检验性 > 风险 > 事实锚点） | `guide-structure-map.md` L5-L11 |
| **典型映射** | 7 种典型洞见到推荐落点的映射 | `guide-structure-map.md` L13-L21 |

**设计理由**：
- 提供可复用的"落点决策逻辑"，避免 AI 每次都重新判断
- 优先级规则反映了"减少返工"的核心原则

### 3. 先决条件规则（`SKILL.md`）

| 项目 | 硬编码内容 | 文件位置 |
|------|-----------|---------|
| **结构保护规则** | 不新增 `##` 级标题、不改标题文本/编号/顺序 | `SKILL.md` L21-L23 |
| **增量补丁规则** | 新增 1-3 条 bullet 或末尾补 1 句澄清 | `SKILL.md` L47-L49 |

**设计理由**：
- 保证指南文件结构稳定性（"呼吸式生长"而非"推倒重来"）
- 强制最小化变更，降低误改风险

---

## 二、AI 智能规划部分

### 1. 洞见抽取（"原子洞见"分解）

| AI 任务 | 描述 | 输出 |
|---------|------|------|
| **拆解用户表达** | 将复杂的用户表达拆成若干条"可落笔"的要点 | 每条只包含一个主张/规则/写法 |
| **附写目的** | 为每条要点附 1 句"写进指南的目的" | 统一口径/防评审质疑/可复现/风险控制 |

**示例**：

```
用户表达：
"我们在写作时要注意不要用'国际领先'这种表述，也不要用'填补空白'，
评审专家会反感，应该用具体的对比数据来支撑结论。"

AI 抽取为 3 条原子洞见：
1. 禁用"国际领先"表述 → 目的：防评审质疑
2. 禁用"填补空白"表述 → 目的：防评审质疑
3. 用对比数据支撑结论 → 目的：可核验性
```

### 2. 落点选择（动态决策）

| AI 任务 | 描述 | 文件位置 |
|---------|------|---------|
| **参考映射规则** | 需要更细的落点规则时，先读 `guide-structure-map.md` | `SKILL.md` L33 |
| **动态选择落点** | 根据洞见类型，在 7 个典型映射中选择最合适的落点 | `SKILL.md` L34-L41 |
| **处理不确定性** | 不确定时询问用户偏好 | `SKILL.md` L43 |

**示例决策树**：

```
洞见类型 → 推荐落点 → 备选落点 → 不确定时询问

写作禁区/句式建议 → ## 写作哲学
术语/缩写/大小写 → ## 命名与术语 → ## 基本原理（核心概念定义）
评估指标/验证策略 → ## 基本原理 + ## 落点清单
评审问答口径 → ## 评审专家可能的问题及回答
```

### 3. 内容融入（最小补丁写入）

| AI 任务 | 描述 | 约束 |
|---------|------|------|
| **增量补丁生成** | 新增 1-3 条 bullet 或在既有 bullet 末尾补 1 句澄清 | 不新开大段长文 |
| **语气适配** | 紧贴相邻条目的写法与语气 | 保持风格一致 |
| **术语对齐** | 与已有术语保持一致 | 参考项目既有术语表 |
| **大洞见拆分** | 如果洞见很大，先拆成多个 bullet 分散落点 | 不破坏结构平衡 |

**示例**：

```markdown
# 原有内容
## 命名与术语

### 核心概念
- **研究对象**：统一使用"患者"，避免"病例/受试者/样本"混用

# AI 融入后（最小补丁）
## 命名与术语

### 核心概念
- **研究对象**：统一使用"患者"，避免"病例/受试者/样本"混用
- **评估指标**：准确率/精确度统一为"准确率"，首次使用可注明"准确率(accuracy)"

# 而非（错误示范：新开大段）
## 命名与术语

### 核心概念
- **研究对象**：统一使用"患者"，避免"病例/受试者/样本"混用

### 评估指标（新增小节 - 违反"不新增结构"原则）
- 准确率/精确度统一为"准确率"
- 灵敏度/特异度/召回率统一说明
```

### 4. 校验执行（结构完整性检查）

| AI 任务 | 描述 | 工具 |
|---------|------|------|
| **运行验证脚本** | `python skills/guide-updater/scripts/validate_guide.py <路径>` | 硬编码脚本 |
| **手动确认** | 搜索是否意外新增 `##` 级标题 | AI 搜索 + 人工确认 |

---

## 三、混合策略（硬编码 + AI 协同）

| 功能 | 硬编码部分 | AI 规划部分 | 协同方式 |
|------|-----------|------------|---------|
| **洞见抽取** | 原子化规则（每条一个主张/规则） | 智能拆解用户表达、附写目的 | AI 按规则拆解，保证原子性 |
| **落点选择** | 7 种典型映射（`guide-structure-map.md`） | 动态选择最合适落点、处理不确定性 | AI 先查映射表，不确定时询问 |
| **内容融入** | 结构保护规则（不新增 `##`、不改标题） | 最小补丁写入、语气适配、术语对齐 | AI 在约束范围内智能融入 |
| **质量校验** | 必需标题列表、退出码约定 | 运行脚本、手动确认、搜索误改 | AI 执行硬编码校验逻辑 |

---

## 四、架构设计原则

该 skill 采用 **"硬编码约束，AI 智能填充"** 的设计：

1. **硬编码保证结构稳定**：必需标题、结构保护规则、最小补丁原则
2. **AI 负责语义理解**：洞见抽取、落点选择、内容融入的智能决策
3. **混合协同工作流**：AI 在硬编码约束的"安全边界"内灵活规划
4. **可复现性优先**：所有决策都有明确规则依据，可复现、可审计

### 核心设计模式

```python
# 伪代码：guide-updater 工作流
async def update_guide(
    *,
    user_insight: str,        # 用户提供的洞见
    guide_path: Path,         # 指南文件路径
    config: Dict[str, Any],   # 配置（硬编码规则）
    ai: AIIntegration,        # AI 能力
) -> UpdateResult:
    # 1. AI 洞见抽取（按原子化规则拆解）
    atomic_insights = await ai.extract_atomic_insights(
        user_insight,
        rules=config["atomic_rules"],  # 硬编码：每条一个主张
    )

    # 2. AI 落点选择（查映射表 + 动态决策）
    for insight in atomic_insights:
        # 先查硬编码映射表
        target = config["mapping_rules"].get(insight.type)
        # 如果不确定，AI 动态决策或询问用户
        if not target:
            target = await ai.decide_target_section(
                insight,
                context=read_guide(guide_path),
                fallback="ask_user",
            )

    # 3. AI 内容融入（在硬编码约束内）
    for insight, target in zip(atomic_insights, targets):
        # 硬编码约束：不新增 ## 级标题
        if is_new_top_level_section(target):
            raise ValueError("禁止新增 ## 级标题")

        # AI 智能融入
        new_content = await ai.generate_incremental_patch(
            insight,
            target_section=read_section(guide_path, target),
            constraints={
                "max_bullets": 3,      # 硬编码：最多 3 条
                "tone_match": True,    # 硬编码：语气适配
                "term_consistency": True,  # 硬编码：术语对齐
            },
        )

        # 写入
        write_section(guide_path, target, new_content)

    # 4. 硬编码校验（运行脚本）
    validation_result = run_validate_script(guide_path)
    if validation_result.exit_code != 0:
        raise ValidationError(validation_result.message)

    return UpdateResult(success=True)
```

---

## 五、硬编码与 AI 规划的边界

### 应该硬编码的内容

| 类别 | 理由 | 示例 |
|------|------|------|
| **结构骨架** | 保证指南文件结构稳定，避免"另起炉灶" | 必需标题列表、禁止新增 `##` 级标题 |
| **保护规则** | 防止 AI 误操作破坏指南结构 | 不改标题文本/编号/顺序、最小补丁原则 |
| **映射规则** | 可复用的决策逻辑，避免 AI 重复判断 | 7 种典型洞见到落点的映射 |
| **校验逻辑** | 确定性检查结果，可脚本化集成 | 退出码约定、必需标题检查 |
| **格式约定** | 统一输出格式，便于后续处理 | 洞见抽取的"主张+目的"结构 |

### 应该 AI 规划的内容

| 类别 | 理由 | 示例 |
|------|------|------|
| **语义理解** | 用户表达千差万别，需要语义理解 | 拆解复杂表达为原子洞见 |
| **动态决策** | 具体场景需要灵活判断 | 落点选择、边界情况处理 |
| **内容生成** | 需要适配语气、对齐术语 | 生成增量补丁文本 |
| **不确定性处理** | 规则无法覆盖所有情况 | 询问用户偏好、给出推荐方案 |

### 灰色地带（需具体分析）

| 问题 | 建议方案 | 理由 |
|------|---------|------|
| **落点映射的粒度** | 硬编码 7 种典型映射，AI 处理边界情况 | 平衡复用性与灵活性 |
| **洞见大小判断** | 硬编码"最多 3 条 bullet"，AI 判断是否需要拆分 | 结构保护 + 智能适配 |
| **语气适配规则** | 硬编码"必须适配"，AI 负责具体实现 | 原则固定，实现灵活 |
| **术语对齐逻辑** | 硬编码"必须对齐"，AI 负责查找和匹配 | 目标明确，过程智能 |

---

## 六、实施建议

### 阶段 1：完善硬编码基础（当前优先级）

1. **增强 `validate_guide.py`**：
   - 支持自定义必需标题列表（通过 `config.yaml`）
   - 支持自定义禁止片段列表
   - 增加 `--fix` 选项，自动修复简单问题

2. **扩展 `guide-structure-map.md`**：
   - 增加更多典型映射案例
   - 增加"边界情况处理"章节
   - 增加"示例"章节

3. **完善 `SKILL.md`**：
   - 增加"工作流示例"章节
   - 增加"常见问题"章节
   - 增加"与 AI 协同"章节

### 阶段 2：AI 能力增强（后续优化）

1. **洞见抽取增强**：
   - 支持从对话历史中自动抽取洞见
   - 支持去重和合并相似洞见
   - 支持洞见优先级判断

2. **落点选择增强**：
   - 支持多目标落点（一个洞见写入多个章节）
   - 支持落点理由说明
   - 支持落点冲突检测

3. **内容融入增强**：
   - 支持智能去重（避免写入已有内容）
   - 支持内容关联（自动补充交叉引用）
   - 支持格式美化（在约束范围内）

### 阶段 3：工具化与自动化（长期目标）

1. **CLI 工具**：
   ```bash
   # 直接从命令行更新指南
   guide-updater --guide-path 项目指南.md --insight "新增规则：..."
   ```

2. **交互式模式**：
   ```bash
   # 交互式更新，AI 询问用户确认
   guide-updater --guide-path 项目指南.md --interactive
   ```

3. **批量模式**：
   ```bash
   # 从文件批量导入洞见
   guide-updater --guide-path 项目指南.md --batch insights.json
   ```

---

## 七、关键文件索引

| 文件 | 用途 |
|------|------|
| [SKILL.md](../skills/guide-updater/SKILL.md) | 技能主文档，包含使用方式、先决条件、工作流程 |
| [config.yaml](../skills/guide-updater/config.yaml) | 技能配置，包含参数定义、版本信息 |
| [scripts/validate_guide.py](../skills/guide-updater/scripts/validate_guide.py) | 结构完整性验证脚本 |
| [references/guide-structure-map.md](../skills/guide-updater/references/guide-structure-map.md) | 洞见到落点的映射规则 |

---

## 八、变更历史

本计划不在本文档内维护变更历史；统一记录在根级 [`CHANGELOG.md`](../CHANGELOG.md)。
