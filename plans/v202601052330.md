# make_latex_model 技能优化计划

**计划编号**: v202601052330
**创建时间**: 2026-01-05 23:30
**状态**: 待审查
**目标**: 优化 make_latex_model 技能，消除冗余、修复错误、提升可维护性

---

## 📋 优化概览

| 优先级 | 任务类别 | 任务数 | 预计工作量 |
|--------|----------|--------|------------|
| P0 | 紧急修复 | 3 | 15 分钟 |
| P1 | 核心优化 | 2 | 40 分钟 |
| P2 | 次要改进 | 3 | 25 分钟 |
| **总计** | - | **8** | **80 分钟** |

---

## 🔴 P0 - 紧急修复（必须立即执行）

### P0-1: 修复版本号不一致
**文件**: [skills/make_latex_model/SKILL.md:566](../skills/make_latex_model/SKILL.md#L566)

**问题**:
```markdown
当前（错误）: **当前版本**：v1.4.0
应为: **当前版本**：v2.1.0
```

**修复方案**:
```diff
- **当前版本**：v1.4.0
+ **当前版本**：v2.1.0
```

**验证**:
- 确保 SKILL.md 顶部 `version: 2.1.0` 与第 566 行一致
- 确保 config.yaml 中 `version: 2.1.0` 一致

---

### P0-2: 清理已追踪的系统垃圾文件
**问题**: `.DS_Store` 和 `__pycache__` 已被 Git 追踪

**受影响文件** (13+ 个):
```
/.DS_Store
/projects/.DS_Store
/projects/NSFC_Young/.DS_Store
/tests/.DS_Store
/skills/.DS_Store
/skills/make_latex_model/.DS_Store
/skills/make_latex_model/tests/.DS_Store
/skills/make_latex_model/tests/Auto-Test-01/.DS_Store
/skills/make_latex_model/tests/v202601052142/.DS_Store
/skills/make_latex_model/core/__pycache__/
```

**执行命令**:
```bash
# 清理所有 .DS_Store 文件
find . -name ".DS_Store" -exec git rm --cached {} \;

# 清理 __pycache__ 目录
find . -type d -name "__pycache__" -exec git rm -r --cached {} \; 2>/dev/null
```

**注意**: 不要删除 `.git/` 目录下的 `.DS_Store`（Git 内部使用）

---

### P0-3: 优化 .gitignore 配置
**文件**: [/.gitignore](../.gitignore)

**新增内容**（追加到文件末尾）:

```gitignore
# =============================================================================
# Python 虚拟环境（补充）
# =============================================================================
venv/
env/
ENV/
.venv

# =============================================================================
# make_latex_model 技能特定
# =============================================================================

# 技能输出目录（保留 README）
skills/make_latex_model/output/*.json
skills/make_latex_model/output/*.log
!skills/make_latex_model/output/README.md

# 测试工作空间
skills/make_latex_model/tests/*/workspace/
skills/make_latex_model/tests/*/.test_summary.txt

# PDF 分析临时文件
skills/make_latex_model/scripts/*_analysis.json

# =============================================================================
# macOS 补充（增强）
# =============================================================================
._*
```

**说明**:
- ✅ **不忽略** `*.pdf`（用户需要查看 PDF 输出）
- ✅ 新增虚拟环境忽略规则
- ✅ 新增技能特定输出目录忽略规则
- ✅ 新增 macOS 补充规则 `._*`（资源分支文件）

---

## 🟡 P1 - 核心优化（本月完成）

### P1-1: 实施配置继承方案
**目标**: 消除 `config.yaml` 和 `templates/nsfc/base.yaml` 中的验证配置重复

**步骤 1**: 修改 [templates/nsfc/base.yaml](../skills/make_latex_model/templates/nsfc/base.yaml)

**删除内容**（第 140-170 行）:
```yaml
# ❌ 删除以下重复配置
validation:
  tolerance:
    font_size_diff: 0.5
    color_diff: 2
    spacing_diff: 0.05
    margin_diff: 0.5
    line_height_diff: 0.1
    chars_per_line_diff: 1
    line_position_diff: 2
    pixel_changed_ratio: 0.20

  acceptance_priority:
    level_1: [...]
    level_2: [...]
    level_3: [...]
    level_4: [...]
```

**保留内容**:
```yaml
# ✅ 仅保留模板特定的验证器列表
validation:
  enabled_validators:
    - compilation
    - style_params
    - heading_consistency
    - visual_similarity
```

**步骤 2**: 验证配置加载逻辑

**检查文件**: [core/config_loader.py](../skills/make_latex_model/core/config_loader.py)

**验证要点**:
- ✅ 第 137-158 行的 `_deep_merge` 方法已支持深度合并
- ✅ 第 50-51 行的合并顺序为 `default → template → local`
- ✅ 无需修改代码，配置继承机制已就绪

**测试验证**:
```bash
cd skills/make_latex_model
python3 -c "
from core.config_loader import load_config
from pathlib import Path

config = load_config(Path('.'))
print('验证器列表:', config.get('validation', {}).get('enabled_validators'))
print('容忍度配置:', config.get('validation', {}).get('tolerance'))
"
```

**预期输出**:
```python
验证器列表: ['compilation', 'style_params', 'heading_consistency', 'visual_similarity']
容忍度配置: {
    'font_size_diff': 0.5,
    'color_diff': 2,
    'spacing_diff': 0.05,
    # ... 其他容忍度参数（从 config.yaml 继承）
}
```

---

### P1-2: 统一颜色定义到单一数据源
**目标**: 消除 13+ 个文件中重复的 `MsBlue RGB 0,112,192` 定义

**步骤 1**: 在 [config.yaml](../skills/make_latex_model/config.yaml) 中新增颜色定义

**位置**: 在 `optimization_strategies` 之后，`compile_config` 之前新增

```yaml
# ================================
# 样式参考基准（默认颜色系统）
# ================================
style_reference:
  colors:
    MsBlue: "RGB 0,112,192"      # Word 风格蓝色
    header_color: "RGB 0,0,0"     # 页眉颜色
    footer_color: "RGB 0,0,0"     # 页脚颜色
    text_color: "RGB 0,0,0"       # 正文颜色
```

**步骤 2**: 修改 [templates/nsfc/base.yaml](../skills/make_latex_model/templates/nsfc/base.yaml)

**删除重复定义**（第 54-58 行）:
```yaml
# ❌ 删除
style_reference:
  colors:
    MsBlue: "RGB 0,112,192"
    header_color: "RGB 0,0,0"
    footer_color: "RGB 0,0,0"
```

**保留引用**:
```yaml
# ✅ 标题样式中继续使用颜色引用
headings:
  section:
    color: MsBlue  # 从继承的配置中读取
```

**步骤 3**: 更新 [core/validators/style_validator.py](../skills/make_latex_model/core/validators/style_validator.py)

**检查**: 确认验证器从配置中读取颜色值，而非硬编码

**示例代码**:
```python
def __init__(self, config: Dict[str, Any]):
    self.colors = config.get('style_reference', {}).get('colors', {})
    self.ms_blue = self.colors.get('MsBlue', 'RGB 0,112,192')
```

**步骤 4**: 更新测试文件（可选）

**受影响文件**:
- `tests/Auto-Test-01/workspace/NSFC_Young/extraTex/@config.tex`
- `tests/Auto-Test-01/workspace/NSFC_Young/extraTex/1.1.立项依据.tex`
- `tests/Auto-Test-01/workspace/NSFC_Young/main.tex`

**操作**: 测试文件中的颜色定义可以保留（作为测试基准），或在文档中说明这是测试数据

---

## 🟢 P2 - 次要改进（下季度完成）

### P2-1: 处理未完成功能
**文件**: [scripts/setup_wizard.py:292](../skills/make_latex_model/scripts/setup_wizard.py#L292)

**问题**: 包含 `# TODO: 实现配置导入` 注释

**选项**:
- **A**: 实现配置导入功能（如需要）
- **B**: 删除相关代码并更新文档（如不需要）
- **C**: 添加明确的 TODO 标记和计划说明

**推荐**: 先与团队确认是否需要此功能，再决定实施方案

---

### P2-2: 清理 output 目录
**文件**: [skills/make_latex_model/output/benchmark_results.json](../skills/make_latex_model/output/benchmark_results.json)

**选项 A**: 忽略输出文件
```bash
# 从 Git 中移除
git rm --cached skills/make_latex_model/output/benchmark_results.json

# 创建 README 说明
cat > skills/make_latex_model/output/README.md << 'EOF'
# Output 目录

此目录用于存放技能运行时生成的临时输出文件，包括：
- benchmark_results.json: 验证器基准测试结果
- *.log: 运行日志文件

**注意**: 此目录下的文件不应提交到版本控制。
EOF
```

**选项 B**: 保留基准结果作为参考
```bash
# 在 .gitignore 中添加例外
!skills/make_latex_model/output/benchmark_results.json
```

**推荐**: 选项 A（忽略输出文件）

---

### P2-3: 统一测试目录命名
**问题**: 当前混用两种命名格式
- `Auto-Test-01`（使用连字符和前缀）
- `v202601052142`（使用时间戳前缀）

**建议**: 统一为 `v{timestamp}` 格式

**操作**:
```bash
# 重命名测试目录（可选）
cd skills/make_latex_model/tests
mv Auto-Test-01 v202412010000  # 或保留作为历史记录
```

**影响文件**:
- [scripts/validate.sh](../skills/make_latex_model/scripts/validate.sh)
- [scripts/validate.bat](../skills/make_latex_model/scripts/validate.bat)
- 相关文档和脚本中的路径引用

**推荐**: 保留 `Auto-Test-01` 作为历史参考，新测试统一使用 `v{timestamp}` 格式

---

## 📊 配置一致性改进

### P2-4: 统一技能描述文本
**位置**: [config.yaml:18](../skills/make_latex_model/config.yaml#L18) vs [SKILL.md:3](../skills/make_latex_model/SKILL.md#L3)

**当前差异**:
```yaml
# config.yaml
description: LaTeX 模板高保真优化器（通用化版本，支持任意 LaTeX 模板，完整验证器插件系统）

# SKILL.md
description: LaTeX 模板高保真优化器（通用化版本，支持任意 LaTeX 模板，完整验证器插件系统，一键优化流程）
```

**统一为**:
```yaml
description: LaTeX 模板高保真优化器（支持任意 LaTeX 模板，完整验证器插件系统，一键优化流程）
```

---

## 🎯 执行计划

### 阶段 1: 紧急修复（立即执行）
```bash
# 1. 修复版本号
vim skills/make_latex_model/SKILL.md  # 第 566 行

# 2. 清理已追踪的垃圾文件
find . -name ".DS_Store" -exec git rm --cached {} \;
find . -type d -name "__pycache__" -exec git rm -r --cached {} \; 2>/dev/null

# 3. 优化 .gitignore
vim .gitignore  # 追加新规则

# 4. 提交变更
git add .gitignore skills/make_latex_model/SKILL.md
git commit -m "chore: 修复版本号不一致并优化 .gitignore

- 修复 SKILL.md 版本号 v1.4.0 → v2.1.0
- 清理已追踪的 .DS_Store 和 __pycache__
- 新增虚拟环境和技能输出目录忽略规则
- 新增 macOS ._* 文件忽略规则"
```

### 阶段 2: 核心优化（本周完成）
```bash
# 1. 实施配置继承
vim skills/make_latex_model/templates/nsfc/base.yaml  # 删除重复配置

# 2. 统一颜色定义
vim skills/make_latex_model/config.yaml  # 新增颜色定义
vim skills/make_latex_model/templates/nsfc/base.yaml  # 删除重复颜色

# 3. 测试验证
cd skills/make_latex_model
python3 -c "from core.config_loader import load_config; from pathlib import Path; import pprint; pprint.pprint(load_config(Path('.')))"

# 4. 提交变更
git add skills/make_latex_model/config.yaml skills/make_latex_model/templates/nsfc/base.yaml
git commit -m "refactor: 消除配置重复，实施配置继承方案

- 删除 base.yaml 中重复的 validation.tolerance 配置
- 删除 base.yaml 中重复的 validation.acceptance_priority 配置
- 在 config.yaml 中新增统一的颜色定义
- 从 base.yaml 中删除重复的颜色定义
- 利用现有的 _deep_merge 机制实现配置继承"
```

### 阶段 3: 次要改进（下月完成）
```bash
# 1. 统一描述文本
vim skills/make_latex_model/config.yaml

# 2. 清理 output 目录
git rm --cached skills/make_latex_model/output/benchmark_results.json
echo "# Output 目录" > skills/make_latex_model/output/README.md

# 3. 提交变更
git add skills/make_latex_model/config.yaml skills/make_latex_model/output/README.md
git commit -m "chore: 统一配置描述并清理输出目录

- 统一 config.yaml 和 SKILL.md 的描述文本
- 清理 output 目录中的运行时生成文件
- 添加 output 目录说明文档"
```

---

## ✅ 验收标准

### P0 验收
- [ ] SKILL.md 版本号统一为 v2.1.0
- [ ] `.DS_Store` 文件已从 Git 中移除
- [ ] `__pycache__` 目录已从 Git 中移除
- [ ] .gitignore 已更新并生效
- [ ] 新增的虚拟环境目录被正确忽略

### P1 验收
- [ ] config.yaml 和 base.yaml 无重复的 validation 配置
- [ ] 配置加载测试通过，能正确读取继承的配置
- [ ] 颜色定义统一到 config.yaml
- [ ] style_validator.py 从配置读取颜色值
- [ ] 编译测试通过，无配置相关错误

### P2 验收
- [ ] config.yaml 和 SKILL.md 描述一致
- [ ] output 目录只包含 README.md
- [ ] 测试目录命名规范统一（或文档说明混用原因）

---

## 📈 预期成果

| 指标 | 优化前 | 优化后 | 改进 |
|------|--------|--------|------|
| 配置重复代码行数 | ~50 行 | 0 行 | -100% |
| 颜色定义重复次数 | 13 处 | 1 处 | -92% |
| 已追踪的垃圾文件 | 13+ | 0 | -100% |
| .gitignore 规则完整性 | 80% | 95% | +15% |
| 配置可维护性 | 中 | 高 | +30% |

---

## 📝 注意事项

1. **配置继承**: 修改 base.yaml 后，务必测试配置加载逻辑确保向下兼容
2. **颜色定义**: 更新颜色值时只需修改 config.yaml 一处
3. **Git 清理**: 使用 `git rm --cached` 不会删除本地文件，只从 Git 索引中移除
4. **PDF 文件**: ✅ **不忽略** `*.pdf`（用户需要查看编译结果）
5. **测试文件**: 测试目录中的配置和样式文件可以保留作为基准参考

---

## 🔄 后续改进建议

1. **CI 集成**: 在 CI 中检查 .gitignore 规则是否被违反
2. **配置验证**: 添加配置 schema 验证（如使用 JSON Schema）
3. **文档更新**: 在 SKILL.md 中说明配置继承机制
4. **代码扫描**: 定期扫描新增的重复代码

---

**计划制定者**: Claude Code
**审查状态**: 待审查
**预计完成时间**: 2026-01-12
