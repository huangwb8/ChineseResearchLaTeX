# transfer_old_latex_to_new Skill - 工程化落地优化计划

**创建时间**: 2026-01-08 08:43  
**目标**: 将 `skills/transfer_old_latex_to_new` 从“设计文档型技能”升级为“可执行、可回滚、可验证”的迁移技能，并实现“硬编码兜底 + AI 自主规划”的高效分工。  
**范围**: 仅涉及 `skills/transfer_old_latex_to_new/`（必要时补充仓库级通用工具函数，但优先保持本技能自包含）。

---

## 📋 目录

- [1. 现状诊断](#1-现状诊断)
- [2. 目标与非目标](#2-目标与非目标)
- [3. 分层架构与职责分工](#3-分层架构与职责分工)
- [4. 工作空间与安全边界](#4-工作空间与安全边界)
- [5. 最小可执行闭环（MVP）](#5-最小可执行闭环mvp)
- [6. 结构分析与映射算法（硬编码优先）](#6-结构分析与映射算法硬编码优先)
- [7. AI 介入点设计（只在歧义处）](#7-ai-介入点设计只在歧义处)
- [8. 编译与日志解析（确定性）](#8-编译与日志解析确定性)
- [9. 测试与验收标准](#9-测试与验收标准)
- [10. 里程碑与交付物清单](#10-里程碑与交付物清单)
- [11. 风险与对策](#11-风险与对策)

---

## 1. 现状诊断

### 1.1 优点（应保留）
- 工作流清晰：Phase 0–5 覆盖“分析→计划→迁移→优化→编译验证→交付”。
- 配置外置：`config.yaml` 已包含阈值、决策规则、编译序列等，为工程化提供基础。
- 参考资料配套：`references/` 已整理版本差异与映射决策，利于降低模型幻觉。

### 1.2 关键缺口（必须补齐）
- **缺少硬编码执行层**：`scripts/` 与 `test/` 为空，导致“可执行性”不足。
- **边界不自洽**：文档宣称只改 `extraTex/`，但又设计日志/交付物/备份输出（需要明确白名单与输出位置）。
- **指标不可复现**：相似度/质量分/收敛等口径未定义产出与计算方式，配置规则难以生效。
- **README 过度承诺**：如“全自动/零遗漏/质量评分92”等，建议改为“默认自动 + 可回滚 + 关键节点可人工确认”。

---

## 2. 目标与非目标

### 2.1 目标（必须达成）
1. **可执行闭环**：输入（old/new 路径）→ 结构解析 → 迁移计划 → 应用迁移 → 编译验证 → 交付物。
2. **可回滚**：任何写入前创建快照；失败可一键恢复。
3. **可验证**：至少提供“结构完整性/引用完整性/编译成功”三类确定性检查。
4. **AI 价值最大化**：AI 只做不确定性任务（拆分/合并/新增内容/过渡段），其余尽量确定性。

### 2.2 非目标（本阶段不做）
- 不做“跨任意自定义模板”的泛化引擎（先锁定 NSFC 近版本迁移）。
- 不做复杂的 GUI/交互式编辑器（以 CLI/脚本为主）。
- 不追求“写作质量自动拉满”（先确保迁移正确、结构不破、可编译）。

---

## 3. 分层架构与职责分工

### 3.1 三层架构
1. **保护层（硬编码）**：路径校验、文件白名单、备份/回滚、LaTeX 编译与日志解析。
2. **结构层（硬编码优先）**：解析 `main.tex` 的 `\\input{}` / `\\include{}` 树，生成结构 JSON；做基于规则的章节映射。
3. **智能层（AI）**：仅在低置信度映射、一对多拆分、多对一合并、新增章节生成、过渡段生成时介入。

### 3.2 AI 与硬编码分工原则（强制）
- **能用规则解决的，不用 AI**（减少不可控与 token 成本）。
- **AI 输出必须结构化**（JSON schema），并由硬编码校验后才能写入文件。
- **AI 不直接写文件**：AI 生成“建议/patch 片段”，硬编码做验证与落盘。

---

## 4. 工作空间与安全边界

### 4.1 推荐工作空间（避免污染用户项目）
在本 skill 内引入 runs 目录：

```
skills/transfer_old_latex_to_new/
  runs/<run_id>/
    input_snapshot/        # old/new 的可编辑内容快照（仅 extraTex/references/figures）
    analysis/              # sections_map_old.json / sections_map_new.json / diff.json
    plan/                  # migration_plan.json + ai_decisions.json
    logs/                  # compile logs / warnings / actions
    deliverables/          # 结构对比、变更摘要、恢复指南、最终 PDF（可选）
```

原则：
- 默认只在 `runs/<run_id>/` 写入中间产物。
- 对 `new_project/extraTex/*.tex` 的写入，必须通过“白名单 + 备份快照 + 原子写入”。

### 4.2 允许写入白名单（需要在 SKILL.md 与实现中统一）
- `new_project/extraTex/*.tex`（排除 `extraTex/@config.tex`）
- `new_project/references/*.bib`（如确需）
- `skills/transfer_old_latex_to_new/runs/**`（日志、报告、临时文件、交付物）

---

## 5. 最小可执行闭环（MVP）

### 5.1 MVP 命令与输入输出（建议）
- 入口脚本：`skills/transfer_old_latex_to_new/scripts/run.py`
- 子命令：
  - `analyze`：只解析结构并产出 diff/plan（不写入 new）。
  - `apply`：按 plan 写入 `new_project/extraTex`，并产出变更摘要。
  - `compile`：对 new 项目执行标准 4 步法编译，输出日志摘要。
  - `all`：`analyze + apply + compile`（默认）

### 5.2 MVP 交付物（强制）
- `analysis/sections_map_old.json`
- `analysis/sections_map_new.json`
- `analysis/structure_diff.json`
- `plan/migration_plan.json`
- `deliverables/change_summary.md`
- `deliverables/restore_guide.md`

---

## 6. 结构分析与映射算法（硬编码优先）

### 6.1 结构抽取（确定性）
1. 解析 `main.tex`：识别 `\\input{...}` / `\\include{...}` 列表（递归展开，避免循环）。
2. 解析被 input 的文件：提取 `\\section/\\subsection/\\subsubsection` 标题（只用于分析，不改动模板）。
3. 建立“章节 → 内容文件路径”的索引，并统计：
   - 字符数/中文词数（粗略）
   - `\\label{}` 列表
   - `\\ref{}` / `\\cite{}` 列表

### 6.2 映射推断（规则优先，AI 兜底）
分三步：
1. **文件名/编号规则匹配**（最高优先级）
2. **标题相似度（去编号后）**（第二优先级）
3. **内容前 N 字摘要相似度**（第三优先级；先做简单 token overlap，必要时再用 embedding）

输出 `structure_diff.json` 中需包含：
- one_to_one / one_to_many / many_to_one / new_added / removed
- 每条映射的 `confidence` 与 `reason`
- 需要 AI 介入的 `needs_ai: true` 标记

---

## 7. AI 介入点设计（只在歧义处）

### 7.1 必须使用 AI 的场景
- 一对多拆分：需要给出切分点与每段归属（保证 LaTeX 环境不被切断）。
- 多对一合并：需要补过渡段、去重、避免重复定义 label。
- 新增章节生成：基于旧文上下文生成“合规占位内容”或“最小可用内容”。
- 低置信度映射：规则/相似度无法决定时进行裁决。

### 7.2 AI 输出协议（建议 schema）
AI 必须返回 JSON（由硬编码校验）：
- `action`: `split|merge|generate|map_decision`
- `inputs_used`: 具体引用的源文件与片段哈希
- `result`: 目标文件内容片段（或切分范围）
- `warnings`: 可能风险（如“此处需要人工核对”）

---

## 8. 编译与日志解析（确定性）

### 8.1 编译流程（固定）
严格 4 步：
1. `xelatex -interaction=nonstopmode main.tex`
2. `bibtex main`（如存在 .aux 且检测到 `\\bibliography`/`\\addbibresource`）
3. `xelatex -interaction=nonstopmode main.tex`
4. `xelatex -interaction=nonstopmode main.tex`

### 8.2 日志解析（必须产出摘要）
输出 JSON 摘要：
- 错误数、警告数
- 常见错误类型：缺文件、未定义引用、环境未闭合、bib 缺条目等
- 建议动作：`abort` / `retry_after_fix` / `ignore_warning`

---

## 9. 测试与验收标准

### 9.1 单元测试（最小集）
- `main.tex` 输入树解析（含多层 input）
- LaTeX 环境切分保护（`\\begin{}`/`\\end{}` 配对）
- 引用扫描与未定义引用检测
- 计划应用的原子写入与回滚（模拟）

### 9.2 集成测试（最小集）
使用仓库内一个最小样例（可复制自 `projects/` 的某个模板子集）：
- `analyze` 可产出 3 个 JSON
- `apply` 能写入目标 `extraTex` 且不触碰受保护文件
- `compile` 能跑完并生成日志摘要（允许有 warnings，但必须无致命 error）

### 9.3 验收口径（必须满足）
- 迁移后 `new_project` 可编译（无致命错误）
- 目标模板要求的内容文件存在且非空（可设置最小字数阈值）
- `\\ref/\\cite` 未定义项在阈值内（默认 0 或可配置）
- 生成恢复指南，并能按指南恢复到迁移前状态

---

## 10. 里程碑与交付物清单

### M1（1 天）：边界自洽与文档校正
- 更新 `SKILL.md`：写清白名单/工作空间/runs 目录；删除“存在但未实现脚本”的描述或改为“将实现”。
- 更新 `README.md`：弱化强承诺，明确“自动 + 可回滚 + 可人工确认”的定位。

### M2（2–3 天）：MVP 可执行闭环
- 实现 `scripts/run.py`（`analyze/apply/compile/all`）
- 实现结构抽取与 diff 生成（JSON 产物稳定）
- 实现备份/回滚与原子写入

### M3（2–4 天）：AI 介入点落地
- 低置信度映射裁决
- 一对多拆分与多对一合并（含 LaTeX 环境保护）
- 新增章节“占位/最小生成”两档策略

### M4（1–2 天）：测试与样例
- 建立最小单元测试与集成测试
- 提供一个可重复的样例迁移场景（输入/输出/期望）

---

## 11. 风险与对策

- **风险：AI 切断 LaTeX 环境导致编译失败**  
  对策：硬编码做环境配对校验；不通过则自动回退到“保守拆分”（按 `\\subsection{}` 边界）。

- **风险：引用/label 冲突或丢失**  
  对策：迁移前后扫描 label/ref/cite，必要时自动加命名空间前缀并记录映射表。

- **风险：输出污染用户项目目录**  
  对策：默认所有中间产物写入 `runs/<run_id>/`；对 new 项目的写入集中在 `extraTex/` 且受白名单控制。

---

> 变更历史记录在 `CHANGELOG.md`。

