# nsfc-justification-writer v0.2.0 改进计划

**创建时间**：2026-01-09 09:42
**计划版本**：v202601090942
**目标版本**：v0.2.0

---

## 一、现状评估

### 1.1 功能完备性分析

✅ **已有优势**：
- **核心流程清晰**：4 段闭环（价值必要性→现状不足→科学问题/假说→切入点与贡献）
- **模板结构保护**：明确的白名单/黑名单机制
- **可核验性导向**：避免"国际领先"等不可证明表述
- **引用守护机制**：与 `nsfc-bib-manager` 协作的核验流程
- **最小信息表**：6 项 MVP 信息收集框架

⚠️ **功能缺失**：
1. **缺乏智能诊断能力**：无法自动检测现有草稿的问题（逻辑断层、术语不一致、证据不足）
2. **缺乏版本迭代支持**：无法在现有草稿基础上增量优化（仅支持"从零生成"或"重构"）
3. **缺乏跨章节自动对齐**：虽然 SKILL.md 提到"检查术语口径"，但缺乏自动化工具
4. **缺乏字数适配能力**：无法根据 NSFC 字数限制自动调整篇幅
5. **缺乏交互式写作流程**：无法在生成过程中与用户确认关键决策点

### 1.2 架构一致性检查

与兄弟技能（`nsfc-research-content-writer`、`nsfc-research-foundation-writer`）对比：

| 维度 | justification-writer | content-writer | foundation-writer | 一致性 |
|------|---------------------|----------------|-------------------|--------|
| **输出文件数** | 1 个 | 3 个（编排式） | 2 个（编排式） | ❌ 不一致 |
| **信息表结构** | 6 项 MVP | 未提供 | 未提供 | ✅ 基准 |
| **验收标准** | 5 条 DoD | 未提供 | 未提供 | ✅ 基准 |
| **工作流步骤** | 5 步 | 6 步 | 5 步 | ✅ 基本一致 |
| **编排能力** | ❌ 无 | ✅ 有（2.2/2.3 从 2.1 抽取） | ✅ 有（3.2 对齐 2.1） | ⚠️ 需增强 |

### 1.3 工程原则符合度

| 原则 | 符合度 | 问题描述 |
|------|--------|----------|
| **KISS** | ⭐⭐⭐⭐☆ | 信息表设计简洁，但缺乏优先级标识（必填/选填） |
| **YAGNI** | ⭐⭐⭐⭐⭐ | MVP 范围清晰，未过度设计 |
| **DRY** | ⭐⭐⭐☆☆ | 信息表结构与兄弟技能重复，应抽取共享模板 |
| **关注点分离** | ⭐⭐⭐☆☆ | 引用核验逻辑依赖外部技能，缺乏清晰的边界定义 |
| **奥卡姆剃刀** | ⭐⭐⭐⭐☆ | 4 段闭环足够简洁，但可进一步精简为 3 段 |

---

## 二、核心问题诊断

### 2.1 优先级 P0（阻塞性问题）

**问题 1：缺乏草稿智能诊断**
- **表现**：用户提交草稿后，无法自动识别"逻辑断层、术语冲突、证据缺失"
- **影响**：重构盲目，可能引入新问题
- **根因**：无结构化分析工具，依赖人工审阅

**问题 2：信息表与实际脱节**
- **表现**：6 项 MVP 信息未与实际 LaTeX 模板结构对齐
- **影响**：生成内容需二次调整
- **根因**：未基于 `extraTex/1.1.立项依据.tex` 的实际结构设计信息表

### 2.2 优先级 P1（重要优化）

**问题 3：缺乏迭代式写作支持**
- **表现**：无法在现有草稿基础上"精简某段""扩充某段""重组逻辑"
- **影响**：用户需频繁重写整段内容

**问题 4：字数限制未内置**
- **表现**：无法根据 NSFC 字数要求（如 4000 字）自动调整篇幅
- **影响**：生成后需手动裁剪/扩充

### 2.3 优先级 P2（体验增强）

**问题 5：缺乏示例与模板**
- **表现**：无示例输出、无典型结构模板
- **影响**：用户难以理解预期输出质量

**问题 6：跨技能术语一致性未自动化**
- **表现**：虽然 SKILL.md 提到"检查术语口径"，但无自动化工具
- **影响**：章节间术语不一致需人工发现

---

## 三、硬编码与AI智能规划协调机制

> **参考实现**：`transfer_old_latex_to_new` v1.4.0 的 `AIIntegration` 模式

### 3.1 职责边界（硬编码 vs AI）

| 任务类型 | 硬编码负责 | AI负责 | 协调方式 |
|----------|------------|--------|----------|
| **信息表收集** | • 字段定义<br>• 必填/选填标识<br>• 数据类型验证 | • 字段补全建议<br>• 缺失项推断<br>• 领域特定字段推荐 | AI 生成建议 → 用户确认 → 硬编码验证 |
| **内容生成** | • LaTeX 结构模板<br>• 章节骨架保护<br>• 命令格式验证 | • 语义内容生成<br>• 逻辑过渡优化<br>• 证据链构建 | AI 生成草稿 → 硬编码结构检查 → 用户审阅 |
| **草稿诊断** | • 结构完整性（`\subsubsection` 计数）<br>• 引用格式验证（`\cite{...}` 存在性）<br>• 字数统计 | • 逻辑连贯性分析<br>• 术语一致性（语义级别）<br>• 证据充分性评估 | 硬编码快速检查 → AI 深度分析 → 合并报告 |
| **迭代修改** | • 定位目标段落（基于 `\subsubsection`）<br>• 备份原文件<br>• 应用修改（原子写入） | • 理解用户指令（自然语言）<br>• 生成修改内容<br>• 预测影响范围 | AI 解析指令 → 硬编码定位 → AI 生成 → 硬编码应用 |
| **字数适配** | • 字符统计（排除 LaTeX 命令）<br>• 目标差距计算<br>• 调整次数限制（防无限循环） | • 识别冗余内容<br>• 优先级排序（哪部分可精简）<br>• 生成扩充/精简方案 | 硬编码统计 → AI 分析 → AI 生成方案 → 硬编码应用并验证 |
| **术语一致性** | • 提取候选术语（正则 + 词频）<br>• 生成使用矩阵 | • 术语消歧（同一概念不同表述）<br>• 推荐统一表述<br>• 识别同义词/缩写 | 硬编码提取 → AI 消歧 → 生成报告 |

### 3.2 三层决策模型

```
┌─────────────────────────────────────────────────────────┐
│                     用户请求层                            │
│   "写立项依据" / "扩充现状分析" / "诊断草稿问题"            │
└────────────────────┬────────────────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────────────┐
│                  智能调度层（新增）                        │
│  - 任务类型识别（AI）                                     │
│  - 策略选择（AI + 硬编码规则）                            │
│  - 降级决策（基于成功率统计）                              │
└────────────────────┬────────────────────────────────────┘
                     │
         ┌───────────┴───────────┐
         ▼                           ▼
┌─────────────────────┐   ┌─────────────────────┐
│   AI 规划层          │   │   硬编码执行层        │
│ - 语义理解           │   │ - LaTeX 解析         │
│ - 内容生成           │   │ - 结构验证           │
│ - 逻辑诊断           │   │ - 文件写入（白名单）  │
│ - 策略建议           │   │ - 字数统计           │
└─────────────────────┘   └─────────────────────┘
         │                           │
         └───────────┬───────────┘
                     ▼
         ┌───────────────────────┐
         │    确定性保障层        │
         │  - 模板结构保护        │
         │  - 引用守护            │
         │  - 备份与回滚          │
         └───────────────────────┘
```

### 3.3 核心协调模式

**模式 1：AI-First 带回退**（适用于语义理解、内容生成）
- 硬编码规则提供基线能力（永远可用）
- AI 提供增强能力（语义理解）
- 失败时自动降级，保证功能可用性

**模式 2：AI 规划 + 硬编码执行**（适用于迭代修改、字数适配）
- AI 理解意图和规划策略
- 硬编码负责安全验证和确定性执行
- 多层防护：规划验证 → 约束生成 → 原子写入 → 回滚

**模式 3：硬编码感知 + AI 增强**（适用于信息表、术语一致性）
- 硬编码定义数据结构和验证规则
- AI 提供智能补全（减少用户输入负担）
- 用户确认机制（AI不擅自决定关键内容）

---

## 四、改进方案设计（融入协调机制）

### 4.1 信息表重构：动态字段推荐

**目标**：基于 `extraTex/1.1.立项依据.tex` 的实际 `\subsubsection` 结构重构信息表，支持 AI 动态推荐字段

**核心结构**（8 项，带优先级）：
```markdown
1. 【必填】研究对象/应用场景（一句话边界）
2. 【必填】痛点与现有不足（问题定义 + 2-4 条瓶颈）
3. 【必填】核心假说（1 句可证伪表述）
4. 【必填】关键科学问题（1-3 条，断点式）
5. 【必填】本项目切入点（差异化切口，1 段）
6. 【选填】拟解决技术/方法概览（输入→处理→验证→交付骨架）
7. 【选填】前期基础（可核验的论文/专利/数据/原型线索）
8. 【选填】主流路线与代表工作（如需引用，请提供 DOI/链接）
```

**协调机制**：
- **硬编码**：定义 `core_fields`（所有领域通用），必填/选填标识
- **AI 增强**：根据用户描述识别领域（医学/工程/社科），推荐领域特定字段
- **用户确认**：AI 推荐字段需用户确认才添加

**配置示例**（`config.yaml` 新增）：
```yaml
info_form:
  core_fields:
    - name: research_object
      required: true
      type: string
      description: "研究对象/应用场景（一句话边界）"
  ai_recommended_fields:
    medical:
      - name: patient_cohort
        hint: "建议补充：患者队列规模、入排标准"
      - name: clinical_endpoint
        hint: "建议补充：主要终点指标"
    engineering:
      - name: system_architecture
        hint: "建议补充：系统架构图/模块划分"
      - name: performance_metrics
        hint: "建议补充：性能指标（延迟/吞吐/精度）"
```

### 4.2 智能诊断：分层诊断

**目标**：在生成前自动诊断现有草稿问题

**分层机制**：
1. **第 1 层：硬编码快速检查**（秒级，100% 确定）
   - 结构完整性（4/4 个 `\subsubsection`）
   - 引用格式（`\cite{...}` 对应 `.bib`）
   - 字数统计

2. **第 2 层：AI 语义分析**（分钟级，带不确定性）
   - 逻辑连贯性（段落过渡）
   - 术语一致性（语义消歧）
   - 证据充分性（可量化描述）

3. **第 3 层：用户交互式确认**（可选）
   - 仅当 AI 检测到高不确定性时启用

**智能调度**：
- 严重错误（如结构缺失）直接返回，不浪费 AI 资源
- 可疑区域重点分析（如逻辑断层段落）
- 统计 AI 成功率，动态调整诊断策略

**输出格式**：
```
诊断结果：
- ✅ 结构完整：4/4 个核心子标题存在
- ⚠️ 逻辑断层：第 2 段→第 3 段缺乏过渡（建议补充："基于上述不足..."）
- ❌ 术语冲突："研究对象"在 P1 用"患者"，在 P3 用"病例"（建议统一）
- ⚠️ 证据不足：第 3 条"瓶颈"未量化（建议补充准确率/成本数据）
```

### 4.3 迭代式写作：意图理解优先

**目标**：支持在现有草稿基础上增量修改

**协调机制**：
- **AI 意图理解**：用户自然语言指令 → 结构化意图（action/target/focus/constraints）
- **硬编码参数映射**：意图 → 具体参数（向后兼容 `--mode/--target/--action`）
- **降级策略**：AI 理解失败时回退到传统参数解析模式

**工作流**：
```
用户指令： "扩充第 3 段现状分析，重点补充 2023-2025 最新进展"
→ AI 解析意图：{action: expand, target: "国内外研究现状", focus: "2023-2025"}
→ 硬编码定位：找到 `\subsubsection{国内外研究现状}`
→ AI 生成内容：基于上下文 + 用户指令生成扩充内容
→ 硬编码应用：原子写入 + 备份 + 白名单验证
→ 诊断验证：检查逻辑完整性
```

### 4.4 字数适配：智能优先级推断

**目标**：根据 NSFC 字数限制自动调整篇幅

**协调机制**：
- **硬编码统计**：解析 LaTeX 源码，统计中文字符数（排除命令、注释）
- **AI 分析策略**：识别冗余内容、优先级排序（哪部分可精简/扩充）
- **硬编码偏好推断**：基于关键词推断领域偏好（医学优先补充"临床试验"，工程优先补充"算法创新"）
- **AI 生成方案**：基于策略和偏好生成扩充/精简内容
- **硬编码应用验证**：应用修改并重新诊断

**配置示例**（`config.yaml` 新增）：
```yaml
parameters:
  word_count_target:
    type: integer
    required: false
    default: 4000
    description: 目标字数（中文字符数，不含 LaTeX 命令）
  word_count_tolerance:
    type: integer
    required: false
    default: 200
    description: 允许偏差范围（±200 字）
```

### 4.5 示例与模板库

**目标**：提供可参考的示例输出

**文件结构**：
```
skills/nsfc-justification-writer/
├── examples/
│   ├── medical/           # 医学领域示例
│   │   └── example_001.tex
│   ├── engineering/       # 工程领域示例
│   │   └── example_001.tex
│   └── README.md          # 示例使用说明
└── templates/
    ├── structure_template.tex  # 标准结构模板
    └── phrase_patterns.md      # 常用句式模板
```

**示例质量标准**：
- 通过 DoD 验收
- 字数符合 NSFC 要求
- 引用完整（对应 `.bib` 文件）
- 标注领域类型（医学/工程/社科等）

### 4.6 术语一致性：混合消歧

**目标**：自动化检查术语在不同章节间的一致性

**协调机制**：
- **硬编码提取**：候选术语（正则 + 词频），高召回率
- **AI 语义消歧**：同义词/缩写识别，高精确率
- **硬编码矩阵生成**：使用矩阵可视化（确定性）
- **AI 修复建议**：推荐统一表述，考虑修改成本

**实现机制**：
1. **术语提取**：从 `extraTex/1.1.立项依据.tex`、`extraTex/2.1.研究内容.tex`、`extraTex/3.1.研究基础.tex` 中提取关键术语
2. **交叉比对**：生成"术语使用矩阵"，标注不一致
3. **自动修复建议**：列出"推荐表述"和"需修改位置"

**输出格式**：
```
术语一致性检查结果：
┌─────────────┬──────────┬──────────┬──────────┐
│ 术语        │ 立项依据 │ 研究内容 │ 研究基础 │
├─────────────┼──────────┼──────────┼──────────┤
│ 研究对象    │ 患者     │ 病例     │ 患者     │ ⚠️ 不一致
│ 指标 A      │ 准确率   │ 精确度   │ 准确率   │ ⚠️ 不一致
│ 方法 B      │ 深度学习 │ DL       │ 深度学习 │ ⚠️ 不一致
└─────────────┴──────────┴──────────┴──────────┘

推荐统一表述：
- 研究对象 → "患者"（更符合临床语境）
- 指标 A → "准确率"（对应标准术语）
- 方法 B → "深度学习"（首次出现时全称，后续可用 DL）
```

---

## 五、分阶段实施计划

### 优先级 P0：基础设施 + 核心重构

#### Phase 0：协调机制基础设施

**目标**：建立硬编码与AI智能规划协调机制的基础设施（参考 `transfer_old_latex_to_new`）

**任务清单**：
1. [ ] 复用 `transfer_old_latex_to_new/core/ai_integration.py`（或创建子类）
2. [ ] 创建 `core/hybrid_coordinator.py`（智能调度层）
3. [ ] 创建 `core/hard_rules.py`（硬编码规则库）
4. [ ] 创建 `core/ai_agents.py`（AI 能力封装）
5. [ ] 创建 `core/observability.py`（可观测性：统计、日志、提示词优化）
6. [ ] 更新 `config.yaml`（新增 AI 配置、回退策略）
7. [ ] 编写单元测试（测试降级逻辑）

**验收标准**：
- AI 成功率达到 80% 以上才启用（否则自动降级）
- 降级逻辑 100% 可用（硬编码基线能力）
- 统计数据可导出（用于提示词优化）

#### Phase 1：信息表重构

**目标**：解决 P0 问题，确保核心功能可用

**任务清单**：
1. [ ] 重构 `references/info_form.md`（8 项新结构，优先级标识）
2. [ ] 对齐 `extraTex/1.1.立项依据.tex` 的 4 个 `\subsubsection`
3. [ ] 更新 `config.yaml`（新增 `word_count_target` 参数 + `ai_recommended_fields`）
4. [ ] 更新 `SKILL.md`（补充新信息表说明）
5. [ ] 更新 `README.md`（补充新信息表使用示例）

**验收标准**：
- 新信息表可独立使用
- 与现有模板结构完全对齐
- 文档更新完整

### 优先级 P1：智能诊断 + 迭代写作

#### Phase 2：智能诊断（分层诊断机制）

**目标**：实现草稿自动诊断能力

**任务清单**：
1. [ ] 创建 `core/diagnostic.py`（诊断模块）
2. [ ] 实现 Tier 1：硬编码快速检查（结构/引用/字数）
3. [ ] 实现 Tier 2：AI 语义分析（逻辑/术语/证据）
4. [ ] 实现智能调度（严重错误跳过 AI）
5. [ ] 集成到工作流（生成前自动诊断）
6. [ ] 更新 `SKILL.md`（补充诊断流程说明）
7. [ ] 新增 `references/diagnostic_examples.md`（诊断报告示例）

**验收标准**：
- 诊断准确率 ≥ 80%（人工标注 10 个示例测试）
- 诊断报告可读性强（用户能理解问题位置）
- 不破坏现有生成流程
- AI 成功率统计可用

#### Phase 3：迭代式写作（意图理解优先）

**目标**：支持增量修改现有草稿

**任务清单**：
1. [ ] 实现 AI 意图理解（自然语言 → 结构化意图）
2. [ ] 实现硬编码参数映射（向后兼容）
3. [ ] 实现定位逻辑（根据 target 定位 `\subsubsection`）
4. [ ] 实现扩充/精简/重组逻辑（AI 生成 + 硬编码应用）
5. [ ] 集成诊断模块（修改后自动验证）
6. [ ] 更新 `README.md`（补充迭代式写作示例）

**验收标准**：
- 支持 3 种迭代模式（扩充/精简/重组）
- 修改后逻辑完整性不被破坏
- 用户指令响应准确率 ≥ 85%
- 降级到参数解析模式可用

### 优先级 P2：字数适配 + 术语一致性

#### Phase 4：字数适配（智能优先级推断）

**目标**：实现自动字数调整

**任务清单**：
1. [ ] 创建 `core/wordcount_adapter.py`（字数适配模块）
2. [ ] 实现硬编码统计（排除 LaTeX 命令）
3. [ ] 实现硬编码偏好推断（基于关键词）
4. [ ] 实现 AI 策略生成（扩充/精简方案）
5. [ ] 实现硬编码应用验证
6. [ ] 集成到工作流（生成后自动检查）
7. [ ] 更新 `SKILL.md`（补充字数适配说明）

**验收标准**：
- 字数统计准确率 ≥ 95%
- 调整后字数偏差 ≤ ±5%
- 逻辑完整性不被破坏

#### Phase 5：术语一致性（混合消歧）

**目标**：自动化检查术语在不同章节间的一致性

**任务清单**：
1. [ ] 实现硬编码术语提取（正则 + 词频）
2. [ ] 实现 AI 语义消歧（同义词/缩写识别）
3. [ ] 实现使用矩阵生成（可视化）
4. [ ] 实现 AI 修复建议（推荐统一表述）
5. [ ] 集成到工作流
6. [ ] 更新 `README.md`（补充术语检查说明）

**验收标准**：
- 术语一致性工具准确率 ≥ 80%
- 使用矩阵可视化清晰
- 修复建议可操作性强

### 优先级 P3：示例与模板

#### Phase 6：示例库与模板

**目标**：提供可参考的示例输出

**任务清单**：
1. [ ] 创建 `examples/` 目录（医学/工程示例各 1 个）
2. [ ] 创建 `templates/structure_template.tex`
3. [ ] 创建 `templates/phrase_patterns.md`
4. [ ] 示例通过 DoD 验收
5. [ ] 更新 `README.md`（补充示例使用说明）

**验收标准**：
- 示例通过 DoD 验收
- 示例字数符合 NSFC 要求
- 引用完整（对应 `.bib` 文件）
- 文档完整

---

## 六、成功指标

### 6.1 功能指标
- 信息表与模板结构对齐度：100%
- 诊断准确率：≥ 80%
- 字数适配准确率：≥ 95%
- 术语一致性工具准确率：≥ 80%

### 6.2 协调效果指标
- **AI 成功率**：≥ 80%（`ai_integration.get_stats()["success_rate"]`）
- **降级频率**：< 20%（`fallback_count / request_count`）
- **端到端成功率**：≥ 95%（（AI 成功 + 降级成功）/ 总请求数）

### 6.3 用户体验指标
- 新手用户完成信息表时间：≤ 15 分钟
- 草稿生成后需修改次数：≤ 3 次
- 诊断报告可理解性：≥ 90%（用户调研）

### 6.4 工程质量指标
- 代码覆盖率：≥ 70%
- 文档完整度：100%
- 向后兼容性：100%

---

**备注**：
1. 本计划遵循项目的"有机更新原则"，各改进方案间存在明确的生态位关系与协调生长机制
2. 协调机制设计参考 `transfer_old_latex_to_new` v1.4.0 的 `AIIntegration` 模式，确保硬编码确定性与 AI 智能性的有效平衡
3. 实施过程中需持续与 `nsfc-research-content-writer`、`nsfc-research-foundation-writer` 保持对齐，确保三大技能的架构一致性
4. 本计划的变更历史记录在根级 [`CHANGELOG.md`](../CHANGELOG.md) 中
