# `make_latex_model` Skill 开发计划

**创建时间**：2026-01-05 17:48
**状态**：待审查
**版本**：v1.0.0

---

## 📋 项目概述

### 技能名称
`make_latex_model`

### 核心目标
基于最新 Word 模板高保真优化现有的 LaTeX 样式配置（[@config.tex](projects/NSFC_Young/extraTex/@config.tex)），确保渲染的 PDF 与 Word 版打印的 PDF 在**标题样式上完全一致**。

⚠️ **重要原则**：仅修改样式配置层，**绝不改动** `main.tex` 中的示例正文内容。

### 保真度要求
⚠️ **像素级** — 每一行的字数、换行位置必须与 Word 打印的 PDF **完全一致**。

**验证方法**：
- 将 LaTeX 生成的 PDF 与 Word 打印的 PDF 叠加对比
- 检查每行的文字是否完全对齐
- 检查换行位置是否完全相同
- 允许误差：±0.5pt（约 0.2mm）

---

## 📁 目录结构

```
skills/make_latex_model/
├── SKILL.md              # 技能主文档（必需）
├── config.yaml           # 技能配置（必需）
├── README.md             # 技能说明（可选）
└── scripts/              # 辅助脚本（可选）
```

---

## 📝 SKILL.md 完整内容

```markdown
---
name: make_latex_model
version: 1.0.0
description: 基于 NSFC 最新 Word 模板高保真优化 LaTeX 模板（main.tex + @config.tex）
category: normal
---

# NSFC LaTeX 模板高保真优化器

## 0.5) 深度参考
- 本项目的 [CLAUDE.md](../CLAUDE.md) 和 [skills/README.md](skills/README.md) 规范
- 现有某个project的 @config.tex 的样式定义模式
- ⚠️ **禁止参考 main.tex 的正文内容**，那是用户示例，与样式优化无关

## 0) 核心目标
确保 LaTeX 渲染的 PDF 与 Word 版打印的 PDF **像素级对齐**：

### 样式要素（必须完全一致）
- 标题层级格式（一级、二级、三级、四级）
- 字体（中文楷体 + 英文 Times New Roman）
- 字号（三号、四号、小四等）
- 颜色（MsBlue RGB 0,112,192）
- 间距（行距、段前段后、缩进）
- 列表样式（编号格式、缩进）
- 页面设置（边距、版心）

### ⚠️ 关键：每行字数对齐
- **每行的字数必须与 Word 完全相同**
- **换行位置必须与 Word 完全一致**
- 这需要精确调整：字号、字间距、行距、段间距

## 1) 触发条件
用户在以下场景触发本技能：
- NSFC 发布了新的年度 Word 模板（如 2026 年版）
- 当前 LaTeX 模板与 Word 模板存在明显样式差异
- 用户主动要求"对齐 Word 样式"、"更新模板格式"

## 2) 输入参数

| 参数 | 类型 | 必需 | 说明 |
|------|------|------|------|
| `project` | string | 是 | 项目名称（如 `NSFC_Young`、`NSFC_General`） |
| `word_template_year` | string | 是 | Word 模板年份（如 `2026`） |
| `optimization_level` | string | 否 | 优化级别：`minimal`（最小改动）\|`moderate`（中等）\|`thorough`（彻底），默认 `moderate` |
| `dry_run` | boolean | 否 | 预览模式，不实际修改文件，默认 `false` |

## 3) 执行流程

### 步骤 1：理解现状（深度阅读）
1. 读取 `projects/{project}/extraTex/@config.tex`，重点分析：
   - 宏包加载
   - 页面设置（geometry）
   - 颜色定义（definecolor）
   - 字体设置（fontspec、xeCJK）
   - 字号系统（newcommand 字号命令）
   - 标题格式（titlesec 定制）
   - 列表样式（enumitem 配置）

### 步骤 2：分析 Word 模板（像素级测量）
1. 定位 `projects/{project}/template/{word_template_year}年最新word模板-*.doc*`（可能是 .doc 或 .docx）
2. ⚠️ **必须打印 PDF 进行精确测量**：
   - 在 Microsoft Word 中打开模板（.doc 或 .docx 皆可）
   - 填充示例文本（与 main.tex 相同）
   - 导出/打印为 PDF
   - 使用 PDF 测量工具（如 Adobe Acrobat 的"测量工具"）精确测量
3. **提取关键样式要素**（精度要求 ±0.5pt）：
   - **页面**：边距（上、下、左、右）、版心尺寸
   - **正文**：字号（pt）、行距（倍数或 pt 值）、首行缩进（字符或 cm）
   - **一级标题**：字号、字体、颜色、加粗、缩进、段前段后间距
   - **二级标题**：同上
   - **三级标题**：编号格式、字号、缩进、与正文间距
   - **四级标题**：编号格式（如（1））、缩进
   - **列表**：编号格式、左缩进、悬挂缩进、项间距
   - **字间距**：中文字间距、英文词间距（如需微调换行）

### 步骤 3：差异分析与优化策略（像素级）
1. **对比当前 LaTeX 样式与 Word 模板**，识别差异：
   - 字号差异（如 14pt vs 15pt）—— 精度 ±0.1pt
   - 颜色差异（MsBlue RGB 值）
   - 间距差异（行距、段前段后）—— 精度 ±0.5pt
   - 编号格式差异（1.1 vs 1.1.）
   - **⚠️ 换行位置差异** —— 需要调整字间距或字号微调
2. **根据 optimization_level 确定修改策略**：
   - `minimal`：仅修改明显错误的样式（如颜色值错误）
   - `moderate`（默认）：调整与 Word 不一致的样式，保持结构稳定
   - `thorough`：重构样式系统，实现最大保真度

### 步骤 4：轻量级修改原则（像素级精度）
1. **优先调整参数，不重构结构**：
   - 调整 `\titleformat` 中的字号（精度 0.1pt）、颜色、间距参数
   - 调整 `\geometry` 中的边距值（精度 0.1mm）
   - 调整 `\newcommand` 字号定义中的 pt 值
   - **如需换行对齐**：微调 `\XeTeXinterchartokenstate`、字间距、或字号 ±0.1pt
2. **保留老样式的稳定性**：
   - 不修改宏包加载顺序
   - 不删除已有的自定义命令
   - 不改变条件判断结构（如 `\ifwindows`）
3. **增量添加新样式**（如有必要）：
   - 新增 `\newcommand` 而非修改现有命令
   - 使用注释标记新增内容：`% 2026年模板新增`

### 步骤 5：执行修改
1. **仅修改 @config.tex**（样式配置层）：
   - 调整颜色定义
   - 调整字号系统
   - 调整标题格式（titlesec）
   - 调整列表样式
   - 调整页面设置（geometry）
2. **⚠️ 绝不修改 main.tex**：
   - main.tex 是用户示例正文，与样式优化无关
   - 唯一例外：用户明确要求修改示例内容

### 步骤 6：验证与迭代（像素级验证）
1. 编译检查：
   ```bash
   cd projects/{project}
   xelatex -interaction=nonstopmode main.tex
   ```
2. **像素级 PDF 对比验证**：
   - 将 LaTeX 生成的 PDF 与 Word 打印的 PDF **叠加对比**
   - **检查每行的文字是否完全对齐**
   - **检查换行位置是否完全一致**
   - 使用工具：Adobe Acrobat 的"比较文件"功能，或手动叠加
3. **微调与迭代**（最多 3 轮）：
   - 如发现换行不一致：微调字号 ±0.1pt 或字间距
   - 如发现位置偏移：微调边距或缩进 ±0.5pt
   - 每轮调整后重新编译验证

## 4) 输出规范

### 4.1 修改摘要
将变更记录有机地追加到 `projects/{project}/extraTex/@CHANGELOG.md`：

**记录原则**：
- 自然流畅，避免生硬套用模板
- 重点说明"为什么改"（Word 模板的变化）和"改了什么"（具体参数）
- 保留历史追溯性，方便后续版本对比

**记录内容**：
- 修改的文件（仅 @config.tex）
- 修改前后的参数对比（如字号从 14pt → 15pt）
- 优化理由（基于 Word 模板的哪个特征变化）
- 验证结果（是否达到像素级对齐）

**格式参考**：
```markdown
## [v1.0.1] - 2026-01-XX

### Changed（样式优化）
- **一级标题字号**：14pt → 15pt（Word 2026 模板要求）
- **行距**：1.5 → 1.45（通过 PDF 叠加对比确定）
- **页边距**：调整上下边距为 2.54cm（与 Word 完全一致）

### Added（新增样式）
- 新增三级标题编号格式 1.1、1.2（Word 2026 新增要求）

### Fixed（修复）
- 修复 MsBlue 颜色值误差（原 RGB 0,112,190 → 正确的 0,112,192）
```

### 4.2 代码变更
使用 Edit 工具对 `@config.tex` 进行精确修改，保留：
- 原有注释
- 代码风格
- 条件判断结构（如 `\ifwindows`）
- **⚠️ 绝不触碰 main.tex**

### 4.3 验证清单（像素级）
- [ ] **编译无错误和警告**
- [ ] **每行字数与 Word 完全一致**
- [ ] **换行位置与 Word 完全一致**
- [ ] PDF 与 Word 模板标题样式一致
- [ ] 页边距一致（误差 < 0.5mm）
- [ ] 字体加载正常（跨平台）
- [ ] 参考文献样式正确
- [ ] 表格和图片位置正确

## 5) 核心原则（底线）

### 5.0 绝对禁区
⚠️ **永不触碰 main.tex 中的正文内容**
- main.tex 是用户的示例文档，包含章节结构和正文内容
- 本技能的职责是优化**样式配置**（@config.tex），而非内容模板
- 唯一例外：用户明确、主动要求修改示例内容

### 5.1 轻量级修改优先
- ✅ 调整参数值（字号 pt 值、颜色 RGB 值、间距 em/cm 值）
- ✅ 新增自定义命令
- ❌ 删除或重命名现有命令
- ❌ 改变宏包加载顺序
- ❌ 重构条件判断结构

### 5.2 保真度与稳定性平衡
- **过度开发的风险**：引入 bug、破坏已有功能、增加维护成本
- **开发不足的风险**：样式不一致、不符合基金委要求
- **平衡策略**：
  - 默认使用 `moderate` 级别
  - 仅在必要时使用 `thorough` 级别
  - 保留老样式的核心架构

### 5.3 跨平台兼容性
- 保留 `\ifwindows` 条件判断
- 确保 Mac/Windows/Linux 都能正确编译
- 外挂字体路径保持不变（`./fonts/`）

## 6) 验证清单（完成后自检，像素级）

- [ ] **编译检查**：`xelatex -> bibtex -> xelatex -> xelatex` 无错误
- [ ] **像素级对齐**：
  - [ ] 每行字数与 Word 完全一致
  - [ ] 换行位置与 Word 完全一致
  - [ ] 叠加对比 PDF 无明显偏移
- [ ] **样式一致性**：标题层级、字体、字号、颜色与 Word 模板一致（误差 < 0.5pt）
- [ ] **页面设置**：边距、行距、版心与 Word 模板一致（误差 < 0.5mm）
- [ ] **跨平台**：在至少两个操作系统上验证编译
- [ ] **向后兼容**：老用户的内容文件（extraTex/*.tex）无需修改即可使用
- [ ] **文档更新**：如有新增命令或配置，在 @config.tex 顶部添加注释说明

## 7) 常见问题

### Q1: Word 模板是二进制格式，如何准确提取样式？
A: 采用多策略：
1. 基金委提供的模板可能是 .doc 或 .docx，两者都通过 Microsoft Word 打开测量
2. 对比历史模板的变化趋势
3. 用户手动提供样式信息（截图、测量值）

### Q2: 修改后老用户的模板还能用吗？
A: 能。本 skill 仅修改样式定义（@config.tex 和 main.tex），不改变内容文件的接口。

### Q3: 如何判断优化是否"过度"？
A: 参考以下标准：
- ✅ 参数调优（如 14pt → 15pt）：合理
- ✅ 新增命令：合理
- ⚠️ 删除命令：需谨慎，确保无引用
- ❌ 重构核心架构：过度

### Q4: Word 模板章节结构变化了怎么办？
A:
1. **样式配置层面**：在 @config.tex 中添加必要的样式定义
2. **内容层面**：提示用户自己在 main.tex 或 extraTex/*.tex 中添加新章节
3. **⚠️ 本技能不负责内容结构的调整**，那是用户的责任

## 8) 版本历史与变更日志

### 技能版本历史
- v1.0.0 (2026-01-05)：初始版本，支持 NSFC_Young 项目的 2026 年模板对齐

### 项目变更日志
每次样式优化后，变更记录将追加到 `@CHANGELOG.md`，包括：
- 样式参数调整（字号、颜色、间距等）
- 新增样式定义
- Word 模板变化对应的内容
- 验证结果（像素级对齐情况）
```

---

## ⚙️ config.yaml 完整内容

```yaml
# ================================
# make_latex_model 技能配置文件
# ================================

skill_info:
  name: make_latex_model
  version: 1.0.0
  description: 基于 NSFC 最新 Word 模板高保真优化 LaTeX 模板
  category: normal

# ================================
# 输入参数定义
# ================================
parameters:
  project:
    type: string
    required: true
    description: 项目名称（NSFC_Young、NSFC_General、NSFC_Local）
    allowed_values:
      - NSFC_Young
      - NSFC_General
      - NSFC_Local
    default: NSFC_Young

  word_template_year:
    type: string
    required: true
    description: Word 模板年份
    pattern: "^\\d{4}$"
    default: "2026"

  optimization_level:
    type: string
    required: false
    description: 优化级别
    allowed_values:
      - minimal      # 最小改动：仅修复明显错误
      - moderate     # 中等优化：调整不一致的样式（默认）
      - thorough     # 彻底重构：最大保真度
    default: moderate

  dry_run:
    type: boolean
    required: false
    description: 预览模式，不实际修改文件
    default: false

# ================================
# 文件路径配置
# ================================
paths:
  projects_root: "./projects"
  templates_dir: "template"
  main_tex: "main.tex"
  config_tex: "extraTex/@config.tex"
  extratex_dir: "extraTex"
  fonts_dir: "fonts"
  figures_dir: "figures"

# ================================
# 样式参考基准（2026年Word模板）
# ================================
style_reference:
  # 页面设置
  page:
    margin_left: "3.20cm"
    margin_right: "3.14cm"
    margin_top: "2.54cm"
    margin_bottom: "2.54cm"
    line_spacing: 1.5

  # 颜色系统
  colors:
    MsBlue: "RGB 0,112,192"    # Word 风格蓝色
    header_color: "RGB 0,0,0"
    footer_color: "RGB 0,0,0"

  # 字体系统
  fonts:
    chinese_main: "KaiTi"       # 中文楷体
    english_main: "Times New Roman"
    fake_bold_factor: 2.5

  # 字号系统（单位：pt）
  font_sizes:
    chuhao: 42
    xiaochuhao: 36
    yihao: 26
    erhao: 22
    xiaoerhao: 18
    sanhao: 16
    sihao: 14
    xiaosihao: 12
    wuhao: 10.5

  # 标题样式
  headings:
    section:
      font_size: 14        # 四号
      font_weight: bold
      color: MsBlue
      indent: "1.45em"
      spacing_before: 0
      spacing_after: 0

    subsection:
      font_size: 14        # 四号
      font_weight: normal
      color: MsBlue
      indent: "1.45em"
      line_spacing: 1.0

    subsubsection:
      font_size: 13.5
      font_weight: bold
      color: MsBlue
      numbered: true       # 编号格式：1.1, 1.2
      indent: "1.1em"
      sep: "0.5em"

    subsubsubsection:
      font_weight: bold
      numbered: true       # 编号格式：（1）
      indent: "1em"
      sep: "0.5pt"

  # 列表样式
  lists:
    enumerate:
      label_format: "（\\arabic*）"
      color: MsBlue
      font_weight: bold
      left_margin: 0
      item_indent: "4em"
      item_sep: 0
      label_sep: "0.1pt"
      parsep: 0
      topsep: 0

# ================================
# 优化策略配置
# ================================
optimization_strategies:
  minimal:
    description: "最小改动：仅修复明显错误"
    actions:
      - fix_color_values
      - fix_critical_font_sizes
      - fix_page_margins

  moderate:
    description: "中等优化：调整不一致的样式（默认）"
    actions:
      - fix_color_values
      - fix_font_sizes
      - fix_page_margins
      - adjust_spacing
      - align_numbering_format

  thorough:
    description: "彻底重构：最大保真度"
    actions:
      - complete_style_overhaul
      - refactor_title_formatting
      - optimize_list_styles
      - cross_platform_validation

# ================================
# 编译配置
# ================================
compile_config:
  engine: xelatex
  interaction_mode: nonstopmode
  max_runs: 4
  sequence:
    - xelatex
    - bibtex
    - xelatex
    - xelatex

# ================================
# ================================
# 验证规则（像素级精度）
# ================================
validation:
  max_iterations: 3
  required_checks:
    - compilation_success
    - no_warnings
    - line_by_line_alignment    # 每行字数对齐
    - word_wrap_consistency     # 换行位置一致
    - style_consistency
    - cross_platform_compatibility
  tolerance:
    font_size_diff: 0.1      # 字号误差容忍度（pt）—— 像素级要求
    color_diff: 2            # 颜色误差容忍度（RGB）—— 更严格
    spacing_diff: 0.05       # 间距误差容忍度（em）—— 约 0.2pt
    margin_diff: 0.5         # 边距误差容忍度（mm）
    line_position_diff: 2    # 换行位置误差容忍度（pt）

# ================================
# 输出配置
# ================================
output:
  format: markdown
  language: zh-CN
  include_diff: true
  include_validation_report: true
  backup_before_modification: false   # 不备份（依赖 Git）

# ================================
# 兼容性配置
# ================================
compatibility:
  preserve_old_commands: true
  preserve_if_conditions: true
  support_projects:
    - NSFC_Young
    - NSFC_General
    - NSFC_Local
  support_os:
    - windows
    - macos
    - linux
```

---

## 📦 README.md 内容（可选）

```markdown
# make_latex_model — NSFC LaTeX 模板高保真优化器

## 简介

本技能用于基于 NSFC 最新 Word 模板（如 2026 年版）高保真优化现有的 LaTeX 模板，确保渲染的 PDF 与 Word 版打印的 PDF 在标题样式上完全一致。

## 使用场景

- NSFC 发布了新的年度 Word 模板
- 当前 LaTeX 模板与 Word 模板存在样式差异
- 需要对齐最新格式要求

## 核心特性

✅ **轻量级修改**：优先调整参数，不重构结构
✅ **跨平台兼容**：支持 Windows/macOS/Linux
✅ **高保真度**：确保与 Word 模板样式一致
✅ **可回退**：依赖 Git 版本控制，随时可回退

## 示例调用

```
请使用 make_latex_model 优化 NSFC_Young 项目的模板，基于 2026 年 Word 模板，使用 moderate 级别。
```

## 开发说明

- 本技能遵守 `/Users/bensz/Nutstore Files/PythonCloud/Agents/pipelines/skills` 规范
- 配置文件：`config.yaml`
- 技能文档：`SKILL.md`
- 安装方式：运行 `install-bensz-skills` 系统级安装器
```

---

## 🎯 开发里程碑

| 阶段 | 任务 | 交付物 | 状态 |
|------|------|--------|------|
| **阶段 1** | 创建技能目录结构 | `skills/make_latex_model/` 及必需文件 | ⏳ 待开始 |
| **阶段 2** | 编写 SKILL.md 和 config.yaml | 完整的技能文档和配置 | ⏳ 待开始 |
| **阶段 3** | 测试基础功能 | 使用 2026 年模板测试 NSFC_Young 项目 | ⏳ 待开始 |
| **阶段 4** | 优化与迭代 | 根据测试结果调整技能配置 | ⏳ 待开始 |
| **阶段 5** | 文档完善 | README.md、CHANGELOG.md | ⏳ 待开始 |

---

## ⚠️ 关键注意事项

### 1. 像素级精度要求
⚠️ **最高优先级**：每一行的字数、换行位置必须与 Word 完全一致
- 验证方法：PDF 叠加对比、Adobe Acrobat"比较文件"功能
- 允许误差：±0.5pt（约 0.2mm）
- 微调手段：字号 ±0.1pt、字间距微调、边距 ±0.5mm

### 2. 轻量级修改原则
- ✅ 调整参数值（字号 pt 值，精度 0.1pt）
- ✅ 调整颜色 RGB 值
- ✅ 调整间距（em/cm/mm 值，精度 0.05em）
- ✅ 新增自定义命令
- ❌ 删除或重命名现有命令
- ❌ 改变宏包加载顺序
- ❌ 重构条件判断结构

### 3. 保真度与稳定性平衡
- **过度开发的风险**：引入 bug、破坏已有功能、增加维护成本
- **开发不足的风险**：样式不一致、不符合基金委要求
- **平衡策略**：
  - 默认使用 `moderate` 级别
  - 仅在必要时使用 `thorough` 级别
  - 保留老样式的核心架构

### 4. 跨平台兼容性
- 保留 `\ifwindows` 条件判断
- 确保 Mac/Windows/Linux 都能正确编译
- 外挂字体路径保持不变（`./fonts/`）
- **⚠️ 不同平台的字体渲染可能略有差异**，需在多平台验证

### 5. 向后兼容
- 确保老用户的内容文件无需修改
- 不改变内容文件的接口
- 仅修改样式定义层

### 6. Git 友好
- 不备份旧文件
- 依赖 Git 版本控制
- 可随时回退

---

## 📋 审查要点

请您重点审查以下方面：

1. **✅ 技能定位是否清晰**：是否明确了"像素级高保真优化"而非"重构"
2. **✅ 像素级精度要求是否明确**：每行字数、换行位置必须与 Word 完全一致
3. **✅ 修改原则是否合理**：轻量级、增量式、保留老架构
4. **✅ Word 模板处理策略是否可行**：PDF 测量、像素级对比
5. **✅ optimization_level 设计是否合理**：minimal/moderate/thorough 三级是否足够
6. **✅ 验证清单是否完整**：是否覆盖了像素级对齐、换行位置等关键要素
7. **✅ 配置文件精度要求是否合理**：tolerance 值是否严格到 ±0.1pt
8. **✅ 是否符合 Nutstore skills 规范**：YAML frontmatter、目录结构等

---

## 📚 参考文档

- [项目 CLAUDE.md](../CLAUDE.md)
- [skills/README.md](../skills/README.md)
- [现有 main.tex](../projects/NSFC_Young/main.tex)
- [现有 @config.tex](../projects/NSFC_Young/extraTex/@config.tex)
- [Nutstore skills 规范](/Users/bensz/Nutstore%20Files/PythonCloud/Agents/pipelines/skills/install-bensz-skills/README.md)

---

**文档版本**：v1.0.0
**最后更新**：2026-01-05 17:48
