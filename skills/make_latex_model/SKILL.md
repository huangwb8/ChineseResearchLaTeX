---
name: make_latex_model
version: 1.0.0
description: 基于 NSFC 最新 Word 模板高保真优化 LaTeX 模板样式（仅修改 @config.tex；不改 main.tex 正文）
category: normal
---

# NSFC LaTeX 模板高保真优化器

## 0.5) 深度参考
- 本项目的 [CLAUDE.md](../../CLAUDE.md) 和 [skills/README.md](../README.md) 规范
- 现有某个 project 的 `@config.tex` 的样式定义模式
- ⚠️ **禁止参考 `main.tex` 的正文内容**，那是用户示例，与样式优化无关

## 0) 核心目标
确保 LaTeX 渲染的 PDF 与 Word 版打印的 PDF **像素级对齐**：

### 样式要素（必须完全一致）
- 标题层级格式（一级、二级、三级、四级）
- 字体（中文楷体 + 英文 Times New Roman）
- 字号（三号、四号、小四等）
- 颜色（MsBlue RGB 0,112,192）
- 间距（行距、段前段后、缩进）
- 列表样式（编号格式、缩进）
- 页面设置（边距、版心）

### ⚠️ 关键：每行字数对齐
- **每行的字数必须与 Word 完全相同**
- **换行位置必须与 Word 完全一致**
- 这需要精确调整：字号、字间距、行距、段间距

## 1) 触发条件
用户在以下场景触发本技能：
- NSFC 发布了新的年度 Word 模板（如 2026 年版）
- 当前 LaTeX 模板与 Word 模板存在明显样式差异
- 用户主动要求“对齐 Word 样式”“更新模板格式”

## 2) 输入参数

| 参数 | 类型 | 必需 | 说明 |
|------|------|------|------|
| `project` | string | 是 | 项目名称（如 `NSFC_Young`、`NSFC_General`） |
| `word_template_year` | string | 是 | Word 模板年份（如 `2026`） |
| `optimization_level` | string | 否 | 优化级别：`minimal`（最小改动）\|`moderate`（中等）\|`thorough`（彻底），默认 `moderate` |
| `dry_run` | boolean | 否 | 预览模式，不实际修改文件，默认 `false` |

## 3) 执行流程

### 步骤 1：理解现状（深度阅读）
1. 读取 `projects/{project}/extraTex/@config.tex`，重点分析：
   - 宏包加载
   - 页面设置（geometry）
   - 颜色定义（definecolor）
   - 字体设置（fontspec、xeCJK）
   - 字号系统（newcommand 字号命令）
   - 标题格式（titlesec 定制）
   - 列表样式（enumitem 配置）

### 步骤 2：分析 Word 模板（像素级测量）
1. 定位 `projects/{project}/template/{word_template_year}年最新word模板-*.doc*`（可能是 .doc 或 .docx）
2. ⚠️ **必须打印 PDF 进行精确测量**：
   - 在 Microsoft Word 中打开模板（.doc 或 .docx 皆可）
   - 填充示例文本（与 main.tex 相同）
   - **导出/打印为 PDF**（这是关键！QuickLook 预览或其他工具的渲染与 Word 不同）
   - 使用 PDF 测量工具（如 Adobe Acrobat 的"测量工具"）精确测量
   - **替代方案**：如无 Word，可使用 LibreOffice 命令行转换：
     ```bash
     soffice --headless --convert-to pdf --outdir . "template/2026年最新word模板-*.doc*"
     ```
3. **提取关键样式要素**（精度要求 ±0.5pt）：
   - **页面**：边距（上、下、左、右）、版心尺寸
   - **正文**：字号（pt）、行距（倍数或 pt 值）、首行缩进（字符或 cm）
   - **一级标题**：字号、字体、颜色、加粗、缩进、段前段后间距
   - **二级标题**：同上
   - **三级标题**：编号格式、字号、缩进、与正文间距
   - **四级标题**：编号格式（如（1））、缩进
   - **列表**：编号格式、左缩进、悬挂缩进、项间距
   - **字间距**：中文字间距、英文词间距（如需微调换行）

### 步骤 3：差异分析与优化策略（像素级）
1. **对比当前 LaTeX 样式与 Word 模板**，识别差异：
   - 字号差异（如 14pt vs 15pt）—— 精度 ±0.1pt
   - 颜色差异（MsBlue RGB 值）
   - 间距差异（行距、段前段后）—— 精度 ±0.5pt
   - 编号格式差异（1.1 vs 1.1.）
   - **⚠️ 换行位置差异** —— 需要调整字间距或字号微调
2. **根据 optimization_level 确定修改策略**：
   - `minimal`：仅修改明显错误的样式（如颜色值错误）
   - `moderate`（默认）：调整与 Word 不一致的样式，保持结构稳定
   - `thorough`：重构样式系统，实现最大保真度

### 步骤 4：轻量级修改原则（像素级精度）
1. **优先调整参数，不重构结构**：
   - 调整 `\titleformat` 中的字号（精度 0.1pt）、颜色、间距参数
   - 调整 `\geometry` 中的边距值（精度 0.1mm）
   - 调整 `\newcommand` 字号定义中的 pt 值
   - **如需换行对齐**：微调 `\XeTeXinterchartokenstate`、字间距、或字号 ±0.1pt
2. **保留老样式的稳定性**：
   - 不修改宏包加载顺序
   - 不删除已有的自定义命令
   - 不改变条件判断结构（如 `\ifwindows`）
3. **增量添加新样式**（如有必要）：
   - 新增 `\newcommand` 而非修改现有命令
   - 使用注释标记新增内容：`% 2026年模板新增`

### 步骤 5：执行修改
1. **仅修改 `@config.tex`**（样式配置层）：
   - 调整颜色定义
   - 调整字号系统
   - 调整标题格式（titlesec）
   - 调整列表样式
   - 调整页面设置（geometry）
2. **⚠️ 绝不修改 `main.tex`**：
   - `main.tex` 是用户示例正文，与样式优化无关
   - 唯一例外：用户明确要求修改示例内容

### 步骤 6：验证与迭代（像素级验证）
1. 编译检查：
   ```bash
   cd projects/{project}
   xelatex -interaction=nonstopmode main.tex
   ```
2. **像素级 PDF 对比验证**：
   - ⚠️ **必须使用 Word 导出的 PDF 作为基准**（QuickLook 预览或其他工具的渲染与 Word 不同）
   - 将 LaTeX 生成的 PDF 与 Word 打印的 PDF **叠加对比**
   - **检查每行的文字是否完全对齐**
   - **检查换行位置是否完全一致**
   - 使用工具：
     - Adobe Acrobat 的"比较文件"功能
     - 或手动叠加（将两个 PDF 导出为 PNG，使用图像编辑软件叠加）
     - 或使用脚本对比（如 `pdftoppm` + Pillow）
3. **微调与迭代**（最多 3 轮）：
   - 如发现换行不一致：微调字号 ±0.1pt 或字间距
   - 如发现位置偏移：微调边距或缩进 ±0.5pt
   - 每轮调整后重新编译验证
4. **验收标准**：
   - ✅ 编译无错误和警告
   - ✅ 样式参数与 Word 模板一致（行距、字号、颜色、间距等）
   - ✅ 视觉上与 Word PDF 高度相似（考虑到字体渲染差异，允许轻微差异）
   - ⚠️ 像素对比指标（如 changed_ratio）仅作为辅助参考，**不作为唯一标准**

## 4) 输出规范

### 4.1 修改摘要
将变更记录有机地追加到 `projects/{project}/extraTex/@CHANGELOG.md`：

**记录原则**：
- 自然流畅，避免生硬套用模板
- 重点说明“为什么改”（Word 模板的变化）和“改了什么”（具体参数）
- 保留历史追溯性，方便后续版本对比

**记录内容**：
- 修改的文件（仅 `@config.tex`）
- 修改前后的参数对比（如字号从 14pt → 15pt）
- 优化理由（基于 Word 模板的哪个特征变化）
- 验证结果（是否达到像素级对齐）

**格式参考**：
```markdown
## [v1.0.1] - 2026-01-XX

### Changed（样式优化）
- **一级标题字号**：14pt → 15pt（Word 2026 模板要求）
- **行距**：1.5 → 1.45（通过 PDF 叠加对比确定）
- **页边距**：调整上下边距为 2.54cm（与 Word 完全一致）

### Added（新增样式）
- 新增三级标题编号格式 1.1、1.2（Word 2026 新增要求）

### Fixed（修复）
- 修复 MsBlue 颜色值误差（原 RGB 0,112,190 → 正确的 0,112,192）
```

### 4.2 代码变更
对 `@config.tex` 进行精确修改，保留：
- 原有注释
- 代码风格
- 条件判断结构（如 `\ifwindows`）
- **⚠️ 绝不触碰 `main.tex`**

### 4.3 验证清单（像素级）
- [ ] **编译无错误和警告**
- [ ] **每行字数与 Word 完全一致**
- [ ] **换行位置与 Word 完全一致**
- [ ] PDF 与 Word 模板标题样式一致
- [ ] 页边距一致（误差 < 0.5mm）
- [ ] 字体加载正常（跨平台）
- [ ] 参考文献样式正确
- [ ] 表格和图片位置正确

## 5) 核心原则（底线）

### 5.0 绝对禁区
⚠️ **永不触碰 `main.tex` 中的正文内容**
- `main.tex` 是用户的示例文档，包含章节结构和正文内容
- 本技能的职责是优化**样式配置**（`@config.tex`），而非内容模板
- 唯一例外：用户明确、主动要求修改示例内容

### 5.1 轻量级修改优先
- ✅ 调整参数值（字号 pt 值、颜色 RGB 值、间距 em/cm 值）
- ✅ 新增自定义命令
- ❌ 删除或重命名现有命令
- ❌ 改变宏包加载顺序
- ❌ 重构条件判断结构

### 5.2 保真度与稳定性平衡
- **过度开发的风险**：引入 bug、破坏已有功能、增加维护成本
- **开发不足的风险**：样式不一致、不符合基金委要求
- **平衡策略**：
  - 默认使用 `moderate` 级别
  - 仅在必要时使用 `thorough` 级别
  - 保留老样式的核心架构

### 5.3 跨平台兼容性
- 保留 `\ifwindows` 条件判断
- 确保 Mac/Windows/Linux 都能正确编译
- 外挂字体路径保持不变（`./fonts/`）

## 6) 验证清单（完成后自检，像素级）

- [ ] **编译检查**：`xelatex -> bibtex -> xelatex -> xelatex` 无错误
- [ ] **像素级对齐**：
  - [ ] 每行字数与 Word 完全一致
  - [ ] 换行位置与 Word 完全一致
  - [ ] 叠加对比 PDF 无明显偏移
- [ ] **样式一致性**：标题层级、字体、字号、颜色与 Word 模板一致（误差 < 0.5pt）
- [ ] **页面设置**：边距、行距、版心与 Word 模板一致（误差 < 0.5mm）
- [ ] **跨平台**：在至少两个操作系统上验证编译
- [ ] **向后兼容**：老用户的内容文件（`extraTex/*.tex`）无需修改即可使用
- [ ] **文档更新**：如有新增命令或配置，在 `@config.tex` 顶部添加注释说明

## 7) 常见问题

### Q1: Word 模板是二进制格式，如何准确提取样式？
A: 采用多策略：
1. 基金委提供的模板可能是 .doc 或 .docx，两者都通过 Microsoft Word 打开测量
2. **必须导出/打印 PDF**：QuickLook 预览或其他工具的渲染引擎与 Word 不同，会导致测量误差
3. 对比历史模板的变化趋势
4. 用户手动提供样式信息（截图、测量值）

### Q2: 为什么像素对比指标变差了，但样式却是正确的？
A: 这是正常现象，主要原因：
1. **基准问题**：如果使用 QuickLook 缩略图作为基准，像素对比会失真（QuickLook 渲染与 Word 不同）
2. **换行位置**：样式修改（如行距）会导致换行位置变化，像素差异会增加
3. **验收标准**：应以"样式参数是否与 Word 一致"和"视觉是否相似"为准，像素对比仅作为辅助参考

### Q3: 修改后老用户的模板还能用吗？
A: 能。本技能仅修改样式定义（`@config.tex`），不改变内容文件的接口。

### Q4: 如何判断优化是否"过度"？
A: 参考以下标准：
- ✅ 参数调优（如 14pt → 15pt）：合理
- ✅ 新增命令：合理
- ⚠️ 删除命令：需谨慎，确保无引用
- ❌ 重构核心架构：过度

### Q5: Word 模板章节结构变化了怎么办？
A:
1. **样式配置层面**：在 `@config.tex` 中添加必要的样式定义
2. **内容层面**：提示用户自己在 `main.tex` 或 `extraTex/*.tex` 中添加新章节
3. **⚠️ 本技能不负责内容结构的调整**，那是用户的责任

## 8) 版本历史与变更日志

### 技能版本历史
- v1.0.0 (2026-01-05)：初始版本，支持 NSFC_Young 项目的 2026 年模板对齐

### 项目变更日志
每次样式优化后，变更记录将追加到 `@CHANGELOG.md`，包括：
- 样式参数调整（字号、颜色、间距等）
- 新增样式定义
- Word 模板变化对应的内容
- 验证结果（像素级对齐情况）
