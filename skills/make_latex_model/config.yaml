# ================================
# make_latex_model 技能默认配置文件
# ================================
#
# 这是技能级别的默认配置，会被模板配置覆盖
# 模板配置位于 templates/ 目录下
#
# 配置优先级（从低到高）:
# 1. 技能默认配置 (config.yaml) - 本文件
# 2. 模板基础配置 (templates/{template}/{template}.yaml)
# 3. 项目本地配置 (projects/{project}/.template.yaml)
#
# ================================

skill_info:
  name: make_latex_model
  version: 2.8.0
  description: LaTeX 模板高保真优化器（支持任意 LaTeX 模板，完整验证器插件系统，一键优化流程，迭代优化闭环，标题格式对比，HTML 可视化报告，自动修复建议）
  category: normal

# ================================
# 输入参数定义
# ================================
parameters:
  project:
    type: string
    required: true
    description: 项目名称或路径（如 NSFC_Young 或 projects/NSFC_Young）
    default: null

  template:
    type: string
    required: false
    description: 模板名称（如 nsfc/young，留空则自动检测）
    default: null

  word_template_year:
    type: string
    required: false
    description: Word 模板年份（仅用于参考，不影响配置加载）
    pattern: "^\\d{4}$"
    default: "2026"

  optimization_level:
    type: string
    required: false
    description: 优化级别
    allowed_values:
      - minimal      # 最小改动：仅修复明显错误
      - moderate     # 中等优化：调整不一致的样式（默认）
      - thorough     # 彻底重构：最大保真度
    default: moderate

  dry_run:
    type: boolean
    required: false
    description: 预览模式，不实际修改文件
    default: false

# ================================
# 优化策略配置
# ================================
optimization_strategies:
  minimal:
    description: "最小改动：仅修复明显错误"
    actions:
      - fix_color_values
      - fix_critical_font_sizes
      - fix_page_margins

  moderate:
    description: "中等优化：调整不一致的样式（默认）"
    actions:
      - fix_color_values
      - fix_font_sizes
      - fix_page_margins
      - adjust_spacing
      - align_numbering_format
      - align_heading_texts

  thorough:
    description: "彻底重构：最大保真度"
    actions:
      - complete_style_overhaul
      - refactor_title_formatting
      - optimize_list_styles
      - cross_platform_validation
      - align_heading_texts

# ================================
# 样式参考基准（默认颜色系统）
# ================================
style_reference:
  colors:
    MsBlue: "RGB 0,112,192"      # Word 风格蓝色
    header_color: "RGB 0,0,0"     # 页眉颜色
    footer_color: "RGB 0,0,0"     # 页脚颜色
    text_color: "RGB 0,0,0"       # 正文颜色

# ================================
# 编译配置
# ================================
compile_config:
  engine: xelatex
  interaction_mode: nonstopmode
  max_runs: 4
  sequence:
    - xelatex
    - bibtex
    - xelatex
    - xelatex

# ================================
# 验证规则（按优先级分层）
# ================================
validation:
  max_iterations: 3
  required_checks:
    # 第一优先级：基础编译
    - compilation_success
    - no_warnings
    - cross_platform_compatibility

    # 第二优先级：样式参数一致性
    - style_parameter_consistency
    - heading_text_consistency

    # 第三优先级：视觉相似度
    - visual_similarity

    # 第四优先级：像素对比（仅当使用 Word 打印 PDF 基准时）
    - pixel_comparison

  tolerance:
    # 样式参数容忍度（第二优先级）
    font_size_diff: 0.5      # 字号误差容忍度（pt）
    color_diff: 2            # 颜色误差容忍度（RGB）
    spacing_diff: 0.05       # 间距误差容忍度（em）
    margin_diff: 0.5         # 边距误差容忍度（mm）
    line_height_diff: 0.1    # 行距误差容忍度（倍数）

    # 视觉相似度容忍度（第三优先级）
    chars_per_line_diff: 1   # 每行字数误差容忍度（字）
    line_position_diff: 2    # 换行位置误差容忍度（pt）

    # 像素对比容忍度（第四优先级）
    pixel_changed_ratio: 0.01  # 像素差异比例容忍度（1%）

  # 验收优先级说明
  acceptance_priority:
    level_1: # 第一优先级：必须满足
      - compilation_success
      - no_warnings
      - cross_platform_compatibility

    level_2: # 第二优先级：高优先级
      - style_parameter_consistency
      - heading_text_consistency

    level_3: # 第三优先级：中优先级
      - visual_similarity

    level_4: # 第四优先级：低优先级（辅助验证）
      - pixel_comparison

# ================================
# 输出配置
# ================================
output:
  format: markdown
  language: zh-CN
  include_diff: true
  include_validation_report: true
  backup_before_modification: false   # 不备份（依赖 Git）

# ================================
# 兼容性配置
# ================================
compatibility:
  preserve_old_commands: true
  preserve_if_conditions: true
  support_os:
    - windows
    - macos
    - linux

# ================================
# 工作空间配置（v2.3.0 新增）
# ================================
workspace:
  root: ".make_latex_model"       # 工作空间根目录（相对于项目根目录）
  location: project_level         # 工作空间位置标识
  auto_cleanup: true              # 自动清理过期缓存
  cache_max_age_hours: 24         # 缓存最大保留时间（小时）
  keep_iterations: true           # 是否保留所有迭代历史
  max_iterations_kept: 30         # 最多保留的迭代历史数量（与 max_iterations 对齐）
  auto_migrate_legacy: true       # 自动复制旧工作空间/旧产物到新位置（不删除旧目录）
  verbose_migration: true         # 迁移时是否输出提示信息

# ================================
# 迭代优化配置（v2.3.0 新增）
# ================================
iteration:
  max_iterations: 30              # 最大迭代次数
  convergence_threshold: 0.01     # 收敛阈值（像素差异比例 1%）
  no_improvement_limit: 5         # 连续无改善轮数阈值

  # 参数调整粒度
  adjustment_granularity:
    font_size_pt: 0.1             # 字号调整粒度（pt）
    line_spacing: 0.05            # 行距调整粒度（倍数）
    margin_cm: 0.05               # 边距调整粒度（cm）
    color_rgb: 1                  # 颜色调整粒度（RGB 0-255）

  # 回滚策略
  rollback_on_worsening: true     # 指标恶化时是否回滚
  save_best_config: true          # 是否保存最佳配置

  # 像素对比配置
  pixel_comparison:
    dpi: 150                      # 渲染分辨率
    tolerance: 2                  # 像素容差（RGB）
    focus_areas:                  # 重点对比区域
      - title_area                # 标题区域
      - body_area                 # 正文区域
      - page_margins              # 页边距

# ================================
# 基准生成配置（v2.3.0 新增）
# ================================
baseline:
  # Word 转 PDF 工具优先级
  converter_priority:
    - word                        # Microsoft Word（最精确）
    - libreoffice                 # LibreOffice（免费替代）
    - quicklook                   # QuickLook（低质量，仅限 macOS）

  # PDF 质量验证
  quality_check:
    min_page_count: 1             # 最少页数
    expected_page_size: "A4"      # 预期页面尺寸
    check_font_embedding: true    # 检查字体嵌入
