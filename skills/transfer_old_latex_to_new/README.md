# LaTeX 标书智能迁移器 - 用户指南

**技能名称**: `transfer-old-latex-to-new`
**版本**: v1.1
**最后更新**: 2026-01-08
**开发者**: AI Agent (Claude Code)

---

## 📖 目录

1. [简介](#简介)
2. [快速开始](#快速开始)
3. [使用场景](#使用场景)
4. [详细功能](#详细功能)
5. [配置说明](#配置说明)
6. [常见问题](#常见问题)
7. [最佳实践](#最佳实践)
8. [故障排除](#故障排除)

---

## 简介

### 什么是 LaTeX 标书智能迁移器？

**LaTeX 标书智能迁移器** 是一个专门用于国自然科学基金（NSFC）标书跨版本迁移的 AI 技能。它可以自动分析旧新模板的结构差异，智能规划迁移策略，执行内容迁移，并进行多轮迭代优化。

### 核心特性

✅ **可执行闭环（MVP）**：结构分析 → 生成迁移计划 → 写入新模板 →（可选）编译验证 → 交付物  
✅ **硬编码兜底**：受保护文件不允许写入（`main.tex`、`extraTex/@config.tex`、`.cls/.sty`）  
✅ **可逆操作**：apply 前自动快照，支持一键恢复  
✅ **内容不丢失**：无法自动映射的旧章节会导出到交付物，便于人工迁移  
⚠️ **AI 增强（规划中）**：一对多拆分/多对一合并/新增章节生成将在后续版本补齐（当前默认使用占位符）

### 适用范围

- **NSFC 青年基金**: 2024版 → 2025版 → 2026版
- **NSFC 面上项目**: 同版本间迁移
- **自定义模板**: 支持符合 NSFC 规范的自定义模板

---

## 快速开始

### 最简用法（默认配置）

```bash
# 1) 结构分析 + 生成迁移计划（不写入新项目）
python skills/transfer_old_latex_to_new/scripts/run.py analyze --old /path/to/old_project --new /path/to/new_project

# 输出会打印 run_id，例如：run_id=20260108_084300_ab12cd

# 2) 应用迁移（写入 new_project/extraTex，apply 前自动快照）
python skills/transfer_old_latex_to_new/scripts/run.py apply --run-id <run_id> --old /path/to/old_project --new /path/to/new_project

# 3)（可选）编译验证（4 步法：xelatex→bibtex→xelatex→xelatex）
python skills/transfer_old_latex_to_new/scripts/run.py compile --run-id <run_id> --new /path/to/new_project

# 4)（可选）一键恢复（恢复到 apply 前快照）
python skills/transfer_old_latex_to_new/scripts/run.py restore --run-id <run_id> --new /path/to/new_project
```

**交付物位置**：`skills/transfer_old_latex_to_new/runs/<run_id>/deliverables/`

---

## 使用场景

### 场景1: 年度标书升级

**触发词**: "迁移标书"、"升级模板"、"旧标书转新模板"

**示例**:
```
用户: 我有2025年的标书，想用2026年的新模板

AI: 我来帮您迁移。请提供：
1. 2025版标书路径
2. 2026版新项目路径

[自动执行迁移流程]
```

---

### 场景2: 跨版本迁移

**触发词**: "2024转2025"、"2025转2026"

**示例**:
```
用户: 帮我把2024年的青年基金标书迁移到2026版

AI: 收到。这是跨版本迁移（2024→2026），我将自动识别所有结构变化。

[执行迁移，包含两个版本间的所有变更]
```

---

### 场景3: 项目结构变化

**触发词**: "结构变化"、"内容重组"

**示例**:
```
用户: 新模板把"研究基础"独立成一个板块了，怎么处理？

AI: 这是典型的板块重组，我会自动识别变化并迁移。

[智能识别板块变化，执行跨板块迁移]
```

---

## 详细功能

### 六阶段迁移流程

#### Phase 0: 准备阶段

**功能**:
- 验证输入路径有效性
- 识别项目版本（2025/2026等）
- 检测项目结构标准性
- 创建项目快照备份

**输出**:
- 备份路径
- 版本识别结果

---

#### Phase 1: 结构分析

**功能**:
- 解析 `main.tex` 提取章节树结构
- 扫描 `extraTex/` 识别内容文件清单
- 生成结构化元数据（JSON格式）
- 对比旧新项目结构差异

**输出**:
- `sections_map_old.json`（旧项目结构）
- `sections_map_new.json`（新项目结构）
- `structure_diff.json`（结构差异）

---

#### Phase 2: 智能规划

**功能**:
- 推断章节对应关系（一对一、一对多、多对一）
- 识别新增/删除章节
- 规划迁移策略（拆分、合并、生成）
- 标记潜在风险点

**AI决策点**（自主完成）:
- 迭代轮次: 根据项目复杂度自动决定（3-7轮）
- 迁移策略: 根据结构差异自动选择（conservative/smart/aggressive）
- 新增内容生成: 自动调用写作技能或生成占位符
- 备份方式: 自动创建快照

**输出**:
- `migration_plan.json`（详细迁移计划）

---

#### Phase 3: 内容迁移

**功能**:
- **一对一迁移**: 直接复制内容
- **一对多迁移**: 语义拆分章节
- **多对一迁移**: 智能合并章节
- **新增内容**: 调用写作技能生成
- **引用修复**: 更新所有交叉引用

**迁移模式**:
- P01: 直接复制模式
- P02: 编号调整模式
- P03: 语义拆分模式（A/B/C子模式）
- P04: 智能合并模式（A/B子模式）
- P05: 上下文生成模式（A/B/C子模式）
- P06: 跨板块迁移模式

**输出**:
- 迁移后的所有 `extraTex/*.tex` 文件

---

#### Phase 4: 迭代优化

**功能**: 最多5轮迭代优化，每轮关注不同方面

| 轮次 | 优化重点 | 工具/技能 | 预期改进 |
|------|----------|-----------|----------|
| 第1轮 | 逻辑连贯性、过渡段质量 | `nsfc-writing-core` | 消除逻辑断裂 |
| 第2轮 | 术语一致性、引用完整性 | Grep + 引用验证器 | 统一术语 |
| 第3轮 | 内容深度、证据充分性 | `nsfc-rationale-writer` 等 | 补充证据 |
| 第4轮 | 格式规范、LaTeX编译 | LaTeX编译器 | 消除编译错误 |
| 第5轮 | 全文通读、最终润色 | `nsfc-writing-core` | 提升可读性 |

**收敛条件**（满足任一即提前退出）:
- 总分 ≥ 90%
- 连续2轮改进 < 5%
- LaTeX编译完美且无其他严重问题

**输出**:
- `optimization_report.json`（优化报告）

---

#### Phase 5: 最终验证

**功能**:
- LaTeX编译验证（4轮编译）
- 结构完整性检查
- 内容质量终检
- 生成交付物

**交付物**:
- `migrated_proposal.pdf`（迁移后的标书）
- `migration_log.md`（迁移日志）
- `change_summary.md`（变更摘要）
- `structure_comparison.md`（结构对比）
- `restore_guide.md`（恢复指南）

---

## 配置说明

### 默认配置（推荐使用）

技能会根据项目复杂度自动决策，无需手动配置。

**自动决策示例**:
```
项目复杂度    → 策略      → 迭代轮次
简单（一对一多）  → conservative → 3轮
中等（有拆分合并） → smart       → 5轮
复杂（大量新增）  → aggressive  → 7轮
```

---

### 高级配置（可选）

如需自定义，可编辑 `config.yaml`:

```yaml
# 迁移参数
migration:
  max_rounds: 5                    # 最大优化轮次
  backup_mode: "snapshot"          # 备份模式
  default_strategy: "smart"        # 默认策略

  content_generation:
    method: "smart"                # 新增内容生成方式

# 质量阈值
quality_thresholds:
  min_similarity: 0.7              # 最小语义相似度
  min_word_count: 50               # 最小章节字数
```

---

## 常见问题

### Q1: 迁移需要多长时间？

**答**: 取决于项目复杂度：
- **简单项目**（主要是一对一迁移）: 30-60分钟
- **中等复杂度**（有拆分合并）: 1-2小时
- **高复杂度**（大量新增内容）: 2-3小时

---

### Q2: 迁移会丢失内容吗？

**答**: 旧项目内容不会被删除；新模板侧的自动迁移以“确定性映射”为主。对于无法可靠映射的旧章节，本技能会将其导出到交付物 `unmapped_old_content.md`，用于后续人工迁移，避免科学内容丢失。

---

### Q3: 如果迁移结果不满意怎么办？

**答**: 提供了两种方案：
1. **自动恢复**: 使用 apply 前快照恢复新项目
   ```bash
   python skills/transfer_old_latex_to_new/scripts/run.py restore --run-id <run_id> --new /path/to/new_project
   ```
2. **继续优化**: 增加优化轮次
   ```
   用户: 再优化2轮
   AI: 收到，继续第6-7轮优化...
   ```

---

### Q4: 新增的"研究风险应对"章节怎么生成？

**答**: 当前版本默认写入占位符（可在 `config.yaml` 中配置占位符文本）。AI 增强生成（含风险应对）在规划中。

---

### Q5: LaTeX编译失败怎么办？

**答**: 当前版本会执行编译并输出日志摘要（`compile_summary.json` + 编译 stdout/stderr）。自动修复与多轮编译修复策略在规划中。

---

### Q6: 能否只迁移部分章节？

**答**: 技能默认迁移所有章节。如需选择性迁移，可以：
1. 迁移全部后手动删除不需要的章节
2. 或在迁移前手动指定迁移范围

---

### Q7: 迁移后如何验证质量？

**答**: 技能会：
1. 自动运行5轮质量检查
2. 生成质量评分（0-100分）
3. 输出详细的 `migration_log.md`
4. 提供 `migrated_proposal.pdf` 供人工审查

---

## 最佳实践

### 1. 迁移前准备

**建议**:
- ✅ 确保旧项目LaTeX编译通过
- ✅ 清理不需要的临时文件
- ✅ 更新到最新的模板版本
- ✅ 备份重要数据（即使技能会自动备份）

---

### 2. 迁移中监控

**建议**:
- ✅ 关注每阶段输出日志
- ✅ 检查结构差异是否符合预期
- ✅ 如发现异常，及时中止

---

### 3. 迁移后验证

**建议**:
- ✅ 通读生成的PDF，检查逻辑连贯性
- ✅ 重点检查拆分/合并章节
- ✅ 验证新增章节的内容相关性
- ✅ 检查所有图表引用是否有效

---

### 4. 人工润色

**建议**:
- ✅ 补充AI无法生成的个性化内容
- ✅ 调整过渡段使其更自然
- ✅ 统一术语和表述风格
- ✅ 检查并补充参考文献

---

## 故障排除

### 问题1: 路径验证失败

**错误信息**: `❌ 旧项目路径不存在`

**解决方案**:
1. 检查路径是否正确
2. 使用绝对路径（不是相对路径）
3. 确保路径中有 `main.tex` 和 `extraTex/` 目录

---

### 问题2: 结构分析失败

**错误信息**: `❌ 无法解析main.tex`

**解决方案**:
1. 检查 `main.tex` 是否符合NSFC模板规范
2. 确保使用标准模板（未修改 `main.tex`）
3. 检查LaTeX语法是否有错误

---

### 问题3: LaTeX编译失败

**错误信息**: `❌ LaTeX编译错误: Undefined control sequence`

**解决方案**:
1. 查看详细错误日志
2. 检查是否使用了旧模板特有命令
3. 手动修复无法自动修复的错误
4. 重新运行编译验证

---

### 问题4: 迁移后章节为空

**错误信息**: `⚠️ 章节'X.X XXX'字数不足`

**解决方案**:
1. 检查 `structure_diff.json` 中的映射关系
2. 如映射错误，手动调整并重新迁移
3. 检查源文件是否为空

---

### 问题5: 引用全部失效

**错误信息**: `⚠️ 发现15个未定义引用`

**解决方案**:
1. 运行引用修复工具
2. 检查 `ref_mapping` 是否完整
3. 手动修复无法自动映射的引用

---

## 附录

### 术语表

| 术语 | 说明 |
|------|------|
| **一对一映射** | 旧章节直接对应到新章节，内容基本不变 |
| **一对多映射** | 一个旧章节拆分为多个新章节 |
| **多对一映射** | 多个旧章节合并为一个新章节 |
| **新增章节** | 新模板有，旧模板没有的章节 |
| **删除章节** | 旧模板有，新模板没有的章节 |
| **收敛** | 连续多轮优化无显著改进，提前退出 |
| **语义边界** | 内容主题发生变化的自然分界点 |

---

### 支持的版本矩阵

| 源版本 | 目标版本 | 支持状态 |
|--------|----------|----------|
| 2024 | 2025 | ✅ 完全支持 |
| 2024 | 2026 | ✅ 完全支持 |
| 2025 | 2026 | ✅ 完全支持 |
| 自定义 | 标准模板 | ⚠️ 部分支持 |

---

### 联系支持

- **文档**: 见 `references/` 目录
- **配置**: 见 `config.yaml`
- **日志/交付物**: 见 `skills/transfer_old_latex_to_new/runs/<run_id>/`

---

## 更新日志

### v1.0 (2026-01-05)
- ✅ 初始版本发布
- ✅ 支持 2025→2026 迁移
- ✅ 实现6阶段迁移流程
- ✅ 集成所有NSFC写作技能
- ✅ 5轮迭代优化机制
- ✅ 完整的交付物生成

### v1.1 (2026-01-08)
- ✅ 落地可执行闭环（`analyze/apply/compile/restore`）
- ✅ 运行产物集中到 `runs/<run_id>/`，避免污染用户项目目录
- ✅ apply 前快照备份 + 一键恢复

---

**文档版本**: v1.1
**最后更新**: 2026-01-08
**维护者**: AI Agent (Claude Code)

**祝你标书迁移顺利！**
