# systematic-literature-review 配置（轻量化：相关性评分 + 专家写作）

skill_info:
  name: systematic-literature-review
  version: 1.0.9
  description: 令人印象深刻的精准、全面的专家级综述
  category: writing

# ============================================================================
# 档位与别名
# ============================================================================
review_levels:
  default: "premium"
  supported:
    - "premium"
    - "standard"
    - "basic"
  aliases:
    # Premium（旗舰级）：真正的顶刊综述
    "旗舰级": "premium"
    "旗舰": "premium"
    "顶刊级": "premium"
    "顶刊": "premium"
    "premium": "premium"
    "flagship": "premium"
    "top": "premium"
    "高级": "premium"

    # Standard（标准级）：覆盖 80% 实际需求
    "标准级": "standard"
    "标准": "standard"
    "standard": "standard"
    "中等": "standard"
    "常规": "standard"

    # Basic（基础级）：快速调研与入门
    "快速级": "basic"
    "快速": "basic"
    "基础级": "basic"
    "基础": "basic"
    "basic": "basic"
    "入门": "basic"
    "express": "basic"
    "fast": "basic"
    "quick": "basic"

# ============================================================================
# 检索配置
# ============================================================================
search:
  max_results_per_query: 50         # 单查询抓取的最大结果数（多查询模式）
  max_total_results: 500            # 合并后的最大结果数上限
  # 检索源优先级（按顺序尝试，失败则自动降级）
  provider_priority:
    - "mcp"                # 用户配置了且可用 → 最佳体验（由宿主能力提供）
    - "openalex"           # 主力（零配置、无官方速率限制）
    - "semantic_scholar"   # 语义增强（零配置但有速率限制）
    - "crossref"           # DOI 权威验证/兜底（零配置）
    - "duckduckgo"         # 兜底（通常依赖 MCP）

  # 自动降级配置
  fallback:
    enabled: true
    max_retries_per_provider: 2
    timeout_per_request: 30
    cache_detections: true
    detection_ttl: 300

  # 增强保护机制（防封禁/防重试风暴）
  rate_limit_protection:
    enabled: true

    # 全局速率限制（跨所有 provider）
    global:
      enabled: true
      max_calls_per_minute: 120
      cooldown_on_limit: 30

    # 指数退避重试
    retry:
      enabled: true
      max_retries: 3
      base_delay: 1.0
      max_delay: 60.0
      backoff_factor: 2.0

    # API 健康监控（连续失败自动短暂拉黑）
    health_monitor:
      enabled: true
      failure_threshold: 5
      failure_window: 60
      recovery_check_interval: 300

    # Semantic Scholar 配额管理（默认 100/min；这里取保守值）
    semantic_scholar:
      max_calls_per_minute: 80
      max_calls_per_session: 500
      cooldown_on_limit: 60
      fallback_to_openalex: true

    # OpenAlex 礼貌延迟
    openalex:
      polite_delay: 0.25
      polite_pool_email: null

  # 摘要补充（默认启用：优先保证用于写作/对齐检查的文献尽量有摘要）
  #
  # 说明：
  # - OpenAlex 并非所有条目都有 abstract_inverted_index，因此 abstract 可能为空。
  # - 开启后会对缺失摘要的条目进行“多源补齐”（Crossref/Semantic Scholar/PubMed/OpenAlex-by-doi），
  #   并对每篇文献设置有限重试轮次；仍失败则标记为“摘要缺失”，建议写作时不要引用。
  abstract_enrichment:
    enabled: true
    # 执行时机：
    # - post_selection（默认）：检索阶段不做“全局候选库补齐”，只在选文后对 selected_papers 补齐；
    #   优先降低检索阶段耗时与 cache/api 膨胀，避免把“未选中”文献也补齐一遍。
    # - search：在检索阶段对去重后的候选库做有限补齐（旧行为）
    stage: "post_selection"
    max_papers_total: 200          # 单次检索最多补齐多少篇（避免对候选库全量补齐导致限流/耗时爆炸）
    retry_rounds: 3               # 单篇文献的补齐轮次上限（每轮会按优先级尝试多个来源）
    backoff_base_seconds: 0.5     # 重试退避基础时间（秒），每轮指数退避
    min_abstract_chars: 80        # 认为“有效摘要”的最小字符数；更短的会继续尝试补齐
    timeout_seconds: 3            # 单个 API 请求的超时（秒）；过大易导致整体检索卡死，过小会降低补齐成功率

  # MCP 配置（可选；脚本内仅做降级判断，实际检索由宿主工具提供）
  mcp:
    auto_detect: true
    engines:
      - "tavily"
      - "searxng"
      - "paper_search"
      - "duckduckgo"

# ============================================================================
# 缓存策略（默认关闭：避免 run 目录 cache/api 文件爆炸）
# ============================================================================
cache:
  api:
    # 默认开启：提升稳定性、降低重复运行成本
    enabled: true
    # 缓存模式：
    # - minimal（默认）：不缓存 OpenAlex “原始分页响应”（体积大、文件多），但保留摘要补齐/其他来源的缓存收益
    # - full：缓存所有 API 响应（更可复现，但更占磁盘）
    mode: "minimal"
    ttl_seconds: 86400

# ============================================================================
# 评分与写作目标
# ============================================================================
scoring:
  # 正文字数默认范围（可被用户覆盖）
  default_word_range:
    premium:
      min: 10000
      max: 15000
    standard:
      min: 6000
      max: 10000
    basic:
      min: 3000
      max: 6000

  # 参考文献数量默认范围（可被用户覆盖）
  default_ref_range:
    premium:
      min: 80
      max: 150
    standard:
      min: 50
      max: 90
    basic:
      min: 30
      max: 60

  # 高分优先比例：选文时优先取前 60–80% 高分段，再补足目标数量
  high_score_priority:
    fraction_min: 0.6
    fraction_max: 0.8

  score_scale:
    min: 1
    max: 10

# ============================================================================
# 选文策略（保持简单，无子主题硬约束）
# ============================================================================
selection:
  ensure_subtopic_diversity: false   # 默认不强制子主题配额
  allow_lower_scores_to_fill: true   # 高分段不足时允许低分补足
  # 目标参考文献数（用于避免候选库很大时“天然打满 max_refs”导致写作上下文膨胀）
  # - value: 显式指定目标数（优先级最高）
  # - strategy: 未指定 value 时的默认策略
  target_refs:
    value: null
    strategy: "midpoint"   # midpoint=round((min_refs+max_refs)/2)

# ============================================================================
# 写作阶段上下文控制（证据包）
# ============================================================================
writing:
  evidence_cards:
    enabled: true
    abstract_max_chars: 800   # 每篇摘要截断上限（用于降低写作阶段上下文占用）

# ============================================================================
# 字数预算（70/30 + 综/述拆分）
# ============================================================================
word_budget:
  ratio:
    cited: 0.7           # 引用段落占比
    non_cited: 0.3       # 无引用段落（摘要/展望/结论等）占比
  summary_ratio: 0.55    # “综”占单文献字数的基准比例
  commentary_ratio: 0.45 # “述”占单文献字数的基准比例
  seeds: [17, 23, 43]    # 三次独立采样的随机种子
  noise_strength: 0.1    # softmax/Dirichlet 扰动强度，避免平均主义
  tolerance: 0.05        # 总字数误差容忍度（≤5%）
  outputs:
    run_pattern: "word_budget_run{n}.csv"
    final: "word_budget_final.csv"
    non_cited: "non_cited_budget.csv"

# ============================================================================
# 校验阈值（渲染前的硬门槛）
# ============================================================================
validation:
  words:
    min:
      premium: 10000
      standard: 6000
      basic: 3000
    max:
      premium: 15000
      standard: 10000
      basic: 6000
  references:
    min:
      premium: 80
      standard: 50
      basic: 30
    max:
      premium: 150
      standard: 90
      basic: 60

# ============================================================================
# LaTeX/PDF 与 Word 导出
# ============================================================================
latex:
  template_path: "latex-template/nature-reviews-template.tex"
  template_path_override: ""        # 可选：显式指定任务目录中的模板路径；其同级目录会加入 TEXINPUTS/BSTINPUTS 搜索路径
  bibliographystyle: "gbt7714-nsfc"
  pandoc_options:
    - "--standalone"
    - "--pdf-engine=xelatex"
  chinese_font_support: true        # 仅在自定义模板显式设置字体时生效；默认模板使用 ctex 自动选择可用字体
  chinese_font: "SimSun"            # 示例值：Windows 常见字体；跨平台建议通过 template_path_override 自定义模板处理字体

word:
  extract_review_draft_only: true
  heading_level_shift: 2
  include_toc: false
  include_numbering: false

# ============================================================================
# API 配置
# ============================================================================
api:
  semantic_scholar:
    base_url: "https://api.semanticscholar.org/graph/v1"
    timeout: 10
    rate_limit: 100
  openalex:
    base_url: "https://api.openalex.org"
    timeout: 10
    polite_sleep: 0.25
  crossref:
    base_url: "https://api.crossref.org"
    timeout: 10

# ============================================================================
# 目录与输出
# ============================================================================
layout:
  hidden_dir_name: ".systematic-literature-review"
  artifacts_dir_name: "artifacts"
  cache_dir_name: "cache"
  reference_dir_name: "reference"
  scripts_dir_name: "scripts"
  reference_data_extraction_name: "data_extraction_table.md"
  # 注意：状态保存在 {hidden_dir}/pipeline_state.json，不再使用单独的 checkpoints/ 目录

output:
  working_conditions: "{topic}_工作条件.md"
  review_tex: "{topic}_review.tex"
  references_bib: "{topic}_参考文献.bib"
  review_pdf: "{topic}_review.pdf"
  review_word: "{topic}_review.docx"
  validation_report: "{topic}_验证报告.md"
  dedupe_map: "dedupe_map_{topic}.json"

# ============================================================================
# 去重策略
# ============================================================================
dedupe:
  title_similarity_threshold: 0.92
  token_jaccard_threshold: 0.80
  year_window: 1

# ============================================================================
# 脚本路径
# ============================================================================
scripts:
  score_relevance: "scripts/score_relevance.py"
  select_references: "scripts/select_references.py"
  build_reference_bib: "scripts/build_reference_bib_from_papers.py"
  update_data_extraction: "scripts/update_working_conditions_data_extraction.py"
  dedupe: "scripts/dedupe_papers.py"
  compile_pdf: "scripts/compile_latex_with_bibtex.py"
  convert_latex_to_word: "scripts/convert_latex_to_word.py"
  openalex_search: "scripts/openalex_search.py"
  pipeline_cost: "scripts/pipeline_cost.py"

# ============================================================================
# 成本追踪配置
# ============================================================================
cost_tracking:
  # 启用成本追踪（可选功能，不影响文献综述核心流程）
  enabled: true

  # 关注的模型商（AI 将自动查询这些厂商的模型价格）
  model_providers:
    - OpenAI
    - Anthropic
    - 智谱清言

  # 价格缓存有效期（天）
  price_cache_max_days: 30

  # 货币转换率
  currency_rates:
    USD_TO_CNY: 7.2

# ============================================================================
# 多语言支持配置
# ============================================================================
multilingual:
  # 启用多语言支持
  enabled: true

  # 支持的语言配置
  supported_languages:
    - code: en
      name: English
      keywords: ["英语", "英文", "English", "en"]
      latex_packages: []
      ctex_options: null

    - code: zh
      name: Chinese
      keywords: ["中文", "汉语", "Chinese", "zh"]
      latex_packages: ["ctex"]
      ctex_options: null

    - code: ja
      name: Japanese
      keywords: ["日语", "日文", "Japanese", "ja"]
      latex_packages: ["luatexja-preset"]
      ctex_options: "ja"
      font_fallback: "Harano Aji Gothic"

    - code: de
      name: German
      keywords: ["德语", "德文", "German", "de", "Deutsch"]
      latex_packages: ["babel", "ngerman"]
      ctex_options: null

    - code: fr
      name: French
      keywords: ["法语", "法文", "French", "fr", "Français", "french"]
      latex_packages: ["babel", "french"]
      ctex_options: null

    - code: es
      name: Spanish
      keywords: ["西班牙语", "西班牙文", "Spanish", "es", "Español"]
      latex_packages: ["babel", "spanish"]
      ctex_options: null

  # 编译重试配置
  max_compile_retries: 99        # 近似“无限次重试”（足够大即可）；如需更严格可调小
  compile_timeout: 300           # 单次编译 5 分钟
  total_timeout: 1800            # 总计 30 分钟

  # AI 翻译提示模板
  translation_prompt_template: |
    你是一位学术翻译专家。请将以下综述正文翻译为{language}。

    要求：
    1. 保持学术语气、专业性和逻辑连贯性
    2. 保留所有 \cite{key} 引用标记及其位置，绝对不可修改
    3. 保留所有 LaTeX 结构命令（\section, \subsection, \begin{itemize}, \begin{enumerate} 等）
    4. 保留所有数学公式（$...$, \[...\], \begin{equation} 等）
    5. 保留图表标签和引用（\label{}, \ref{} 等）
    6. 专业术语可保留原文或添加译注（如"Transformer（变换器）"）
    7. 缩略词首次出现时展开（如"Artificial Intelligence (AI)"）

    仅输出翻译后的 LaTeX 源码，不要包含任何解释性文字。
